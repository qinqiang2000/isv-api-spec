# 本公司04_增值税普通发票→长软04 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 04 - 增值税普通发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"增值税普通发票"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 04
- **长软发票类型代码**: 04
- **长软文档章节**: 3.2.3.2

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `04` | `04` | 完全一致 |
| 发票类型名称 | 增值税普通发票 | 增值税普通发票 | |
| 数据结构定义 | `#/definitions/231697053` | `3.2.3.2` | 本定义也包含01专票、02货运专票、08电子专票、10电子普票 |
| 数电发票类型 | - | - | 非数电发票 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射，本公司支持更长 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录该发票被查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `buyer_name` | 购买方名称 | string(300) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方税号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射，**普票可为空**（个人购买） |
| `buyer_address_phone` | 购买方地址电话 | string(190) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | 直接映射，**普票通常为空** |
| `buyer_bank_account` | 购买方银行账号 | string(300) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | 直接映射，**普票通常为空** |
| `seller_name` | 销售方名称 | string(300) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_address_phone` | 销售方地址电话 | string(190) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | 直接映射 |
| `seller_bank_account` | 销售方银行账号 | string(300) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | 直接映射 |
| `amount` | 金额 | number(18,2) | `BODY/JE` | 金额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_amount` | 税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `total_amount` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `remark` | 备注 | string(610) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/JQBH` | 机器编号 | VARCHAR2(16) | **长软独有**，税控设备编号 |
| `verification_code` | 校验码 | string(32) | `BODY/JYM` | 校验码 | VARCHAR2(32) | 直接映射，**普票有校验码**，查验时需提供后6位 |
| `invoice_status_flag` | 发票状态标志 | 枚举 | `BODY/ZFBZ` | 作废标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | **长软独有**，已废止，以TSPZBZ为准 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| - | - | - | `BODY/QDBZ` | 清单标志 | VARCHAR2(2) | **长软独有**，0=无清单，1=有清单 |
| `special_invoice_type` | 特殊票种 | string | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/HZDK` | 汇总代开标志 | VARCHAR2(2) | **长软独有**，0=非汇总代开，1=汇总代开 |
| `invoice_status` | 发票状态 | 枚举 | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |
| `proxy_seller_tax_no` | 代开发票真实销售方识别号 | string(20) | - | - | - | **本公司独有**，从业务规则解析（特殊票种02农产品收购时） |
| `proxy_seller_name` | 代开发票真实销售方名称 | string(300) | - | - | - | **本公司独有**，从业务规则解析 |
| `void_date` | 作废日期 | string(19) | - | - | - | **本公司独有**，从业务系统获取 |
| `tax_rate` | 税率 | number(8,5) | - | - | - | **本公司独有**，从items明细中计算得出 |
| `tax_inclusive_rate_flag` | 含税税率标识 | string(1) | - | - | - | **本公司独有**，0=不含税税率，1=含税税率，2=差额征税 |
| `applicable_tax_rate_flag` | 适用税率标识 | string(1) | - | - | - | **本公司独有**，'1'=是，其他=否 |
| `item_count` | 明细条数 | string(30) | - | - | - | **本公司独有**，items数组长度 |
| `non_taxable_amount` | 不征税金额 | number(18,2) | - | - | - | **本公司独有**，从业务系统获取 |
| `seller_taxpayer_type_code` | 销方纳税人类型代码 | string | - | - | - | **本公司独有**，1=一般纳税人，2=小规模纳税人 |
| `vehicle_abnormal_flag` | 机动车异常标识 | string(1) | - | - | - | **本公司独有**，0=无风险，1=低风险，2=中风险，3=高风险 |
| `issue_type` | 开票类型 | 枚举 | - | - | - | **本公司独有**，仅乐企查验返回 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `tax_rate` | 计算得出 | 取items中第一个非零税率，或计算加权平均税率 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `void_date` | 业务系统 | 从企业业务系统获取，长软只返回ZFBZ标志 |
| `proxy_seller_tax_no` | 解析得出 | 当TSPZBZ=02(农产品收购)时，从备注或特定字段解析 |
| `proxy_seller_name` | 解析得出 | 当TSPZBZ=02(农产品收购)时，从备注或特定字段解析 |
| `tax_inclusive_rate_flag` | 业务规则 | 根据发票类型和税率判断 |
| `applicable_tax_rate_flag` | 业务规则 | 判断是否适用标准税率 |
| `non_taxable_amount` | 业务系统 | 不征税项目金额 |
| `seller_taxpayer_type_code` | 业务系统 | 销方纳税人类型，普票可能是小规模纳税人 |
| `vehicle_abnormal_flag` | 业务系统 | 机动车异常风险等级，普票一般为0 |
| `issue_type` | 乐企查验 | 仅乐企查验接口返回 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**:
- ✅ **增值税普通发票有货物明细结构**
- 明细数据记录货物或应税劳务的详细信息
- 一张发票可以有多个明细行

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 货物明细序号 | integer | - | - | - | **本公司独有**，用于排序 |
| `name` | 货物名称 | string(310) | `HWMC` | 货物或应税劳务名称 | VARCHAR2(320) | 直接映射 |
| `specification` | 规格型号 | string(64) | `GGXH` | 规格型号 | VARCHAR2(64) | 直接映射 |
| `unit` | 计量单位 | string(52) | `DW` | 单位 | VARCHAR2(52) | 直接映射 |
| `quantity` | 数量 | string(25) | `SL` | 数量 | VARCHAR2(25) | 直接映射 |
| `unit_price` | 单价 | string(25) | `DJ` | 单价 | VARCHAR2(25) | 直接映射 |
| `amount` | 金额 | number(18,2) | `JE` | 金额 | NUMBER(20,2) | 直接映射 |
| `tax_rate` | 税率 | number(8,5) | `SLV` | 税率 | NUMBER(8,5) | 直接映射 |
| `tax_amount` | 税额 | number(18,2) | `SE` | 税额 | NUMBER(20,2) | 直接映射 |
| `product_code` | 商品编码 | string(45) | - | - | - | **本公司独有**，商品和服务税收分类编码 |
| `zero_tax_rate_flag` | 零税率标识 | 枚举 | - | - | - | **本公司独有**，零税率标志 |

**说明**：
- 长软API中明细字段的金额、税额、税率都是NUMBER类型，可以直接映射
- 其他字段（数量、单价）都是字符串类型
- 本公司独有字段需要从业务系统或Apifox定义中获取

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**：
```
长软 → 本公司
formatDate("20251230") → "2025-12-30"

实现逻辑：
if (!yyyymmdd || yyyymmdd.length !== 8) return null;
return `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`;
```

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 税额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细金额 | `number` (18,2) | `NUMBER(20,2)` | 类型一致，直接映射 |
| 明细税额 | `number` (18,2) | `NUMBER(20,2)` | 类型一致，直接映射 |
| 明细税率 | `number` (8,5) | `NUMBER(8,5)` | 类型一致，直接映射 |

**转换示例**：
```
长软API返回：
{
  "JE": "10000.00",      // 金额合计（字符串）
  "SE": "1300.00",       // 税额合计（字符串）
  "JSHJ": "11300.00"     // 价税合计（字符串）
}

转换为本公司API：
{
  "amount": 10000.00,
  "tax_amount": 1300.00,
  "total_amount": 11300.00
}
```

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 10 | ⚠️ 本公司更宽松，兼容数电发票20位 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |
| name | 310 | 320 | ⚠️ 长软略大，截断可能性极小 |
| verification_code | 32 | 32 | ✅ 长度一致，查验时只需后6位 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → invoice_status)
- **作废标志** (ZFBZ → invoice_status_flag)
- **特殊票种标志** (TSPZBZ → special_invoice_type)

### 5.2 增值税普通发票特有枚举映射

⚠️ **重要**: 增值税普通发票**没有特有枚举**，所有枚举都使用通用枚举映射。

但需要注意以下特殊情况：

#### 5.2.1 发票状态标志 (invoice_status_flag)

普票特有的状态标志枚举：

| 本公司API值 | 含义 | 说明 |
|-----------|------|------|
| 0 | 正数票 | 正常开具的发票 |
| 1 | 负数票 | 红字发票/冲红发票 |
| 2 | 空白作废发票 | 未使用即作废 |
| 3 | 正数作废发票 | 正数票作废 |
| 4 | 负数作废发票 | 负数票作废 |

**说明**：这个枚举在本公司API中更细化，长软API只有ZFBZ（0/1/2/3等），两者需要映射。

#### 5.2.2 含税税率标识 (tax_inclusive_rate_flag)

| 本公司API值 | 含义 | 说明 |
|-----------|------|------|
| 0 | 不含税税率 | 金额为不含税金额 |
| 1 | 含税税率 | 金额为含税金额 |
| 2 | 差额征税 | 差额征税方式 |

**说明**：本公司API独有，长软API无对应字段，需从业务规则判断。

#### 5.2.3 零税率标识 (zero_tax_rate_flag)

货物明细中的零税率标识：

| 本公司API值 | 含义 | 说明 |
|-----------|------|------|
| "" (空) | 无零税率标识 | 普通税率 |
| 0 | 出口退税 | 出口货物退税 |
| 1 | 出口免税和其他免税政策 | 免税商品 |
| 2 | 不征税措施 | 不征税项目 |
| 3 | 普通零税率 | 零税率 |

**说明**：本公司API独有，用于货物明细，长软API无对应字段。

#### 5.2.4 销方纳税人类型代码 (seller_taxpayer_type_code)

| 本公司API值 | 含义 | 说明 |
|-----------|------|------|
| 1 | 一般纳税人 | 可开专票和普票 |
| 2 | 小规模纳税人 | **普票常见开票方**，只能开普票 |
| 3 | 转登记小规模纳税人 | 从一般纳税人转为小规模 |
| 4 | 辅导期一般纳税人 | 新认定的一般纳税人 |
| 5 | 自然人 | 个人代开 |

**说明**：本公司API独有，普票的销方常为小规模纳税人（类型2）或自然人（类型5）。

#### 5.2.5 清单标志 (QDBZ)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 0 | 无清单 | 普通发票，明细直接在CHILDLIST中 |
| 1 | 有清单 | 销货清单，明细在独立的清单中 |

**说明**：本公司API暂无对应字段，可扩展时添加 `list_flag` 字段。

#### 5.2.6 汇总代开标志 (HZDK)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 0 | 非汇总代开 | 普通发票 |
| 1 | 汇总代开 | 税务机关汇总代开 |

**说明**：本公司API暂无对应字段，可扩展时添加 `aggregate_proxy_flag` 字段。

---

## 六、增值税普通发票特殊性说明

### 6.1 该类型的独特特性

1. **有校验码**
   - 增值税普通发票**有校验码**字段（JYM）
   - 这是与专用发票的主要区别之一
   - 查验时需提供**校验码后6位**作为必填参数
   - 校验码用于税务系统真伪验证

2. **不可抵扣进项税**
   - 普通发票**不能抵扣进项税额**
   - 这是与专用发票的核心区别
   - 主要面向个人消费者或不需要抵扣的企业
   - 小规模纳税人只能开具普通发票

3. **购方信息可选**
   - 购方名称必填，但税号可以为空
   - 个人购买时，可以只有名称（如"个人"）
   - 地址电话、银行账号通常为空
   - 与专票要求完整购方信息不同

4. **销方可以是小规模纳税人**
   - 小规模纳税人只能开具普通发票
   - 自然人代开也是普通发票
   - 税率通常为3%或5%（小规模征收率）
   - 一般纳税人也可开普票（如面向个人销售）

5. **必须有货物明细**
   - 普通发票必须包含货物或应税劳务明细
   - CHILDLIST不能为空
   - 每个明细行需要包含完整的税率、税额信息

6. **金额计算关系**
   ```
   价税合计 = 金额合计 + 税额合计
   税额合计 = Σ(明细金额 × 明细税率)
   金额合计 = Σ(明细金额)
   ```

### 6.2 与其他类型的区别

| 特性 | 增值税普通发票(04) | 增值税专用发票(01) | 电子普票(10) | 卷式发票(11) |
|------|------------------|------------------|-------------|-------------|
| 校验码 | ✅ 有，查验必填后6位 | ❌ 无 | ✅ 有 | ✅ 有 |
| 抵扣 | ❌ 不可抵扣 | ✅ 可抵扣 | ❌ 不可抵扣 | ❌ 不可抵扣 |
| 明细结构 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 | ❌ 无明细 |
| 购方完整信息 | ⚠️ 可选（可为个人） | ✅ 必需 | ⚠️ 可选 | ⚠️ 可选 |
| 销方完整信息 | ✅ 必需 | ✅ 必需 | ✅ 必需 | ✅ 必需 |
| 销方类型 | 一般/小规模/自然人 | 一般纳税人 | 一般/小规模 | 一般/小规模 |
| 发票介质 | 纸质 | 纸质 | 电子 | 纸质卷筒 |
| 查验必填字段 | 代码+号码+日期+校验码后6位 | 代码+号码+日期+金额 | 代码+号码+日期+校验码后6位 | 代码+号码+日期+校验码后6位 |

### 6.3 特殊处理逻辑

#### 6.3.1 校验码提取与验证

**处理流程**：
1. **获取完整校验码**：从长软API的 `BODY/JYM` 字段获取
2. **提取后6位**：截取字符串最后6位字符
3. **查验时使用**：调用长软查验接口时，只需传入后6位
4. **返回完整校验码**：查验成功后，将完整校验码返回给本公司API

**实现逻辑**：
```
提取后6位：
if (jym && jym.length >= 6) {
  last6Digits = jym.substr(jym.length - 6, 6);
}

示例：
完整校验码：abcd123456789012
后6位：789012
```

#### 6.3.2 购方信息可选处理

**挑战**：普票的购方信息可能不完整（如个人购买）。

**处理方案**：
1. **购方名称**：必填，如果是个人可以是"个人"、"*个人*"等
2. **购方税号**：可选，个人购买时为空
3. **购方地址电话**：可选，通常为空
4. **购方银行账号**：可选，通常为空

**实现逻辑**：
```
映射购方信息：
buyer_name = xmlBody.GFMC || null;  // 必填
buyer_tax_no = xmlBody.GFSBH || null;  // 可选
buyer_address_phone = xmlBody.GFDZDH || null;  // 可选，通常为空
buyer_bank_account = xmlBody.GFYHZH || null;  // 可选，通常为空

判断是否为个人购买：
if (!buyer_tax_no || buyer_tax_no === '' ||
    buyer_name.includes('个人') || buyer_name === '*') {
  is_personal_buyer = true;
}
```

#### 6.3.3 小规模纳税人识别

**挑战**：识别销方是否为小规模纳税人。

**识别依据**：
1. **税率**：小规模征收率通常为3%或5%
2. **发票类型**：小规模只能开普票，不能开专票
3. **金额**：小规模纳税人季度销售额不超过30万免税

**实现逻辑**：
```
识别小规模纳税人：

// 方法1：通过税率判断
if (items中所有税率 === 0.03 || items中所有税率 === 0.05) {
  可能是小规模纳税人;
}

// 方法2：通过销方纳税人类型代码（如果有）
if (seller_taxpayer_type_code === '2' || seller_taxpayer_type_code === '5') {
  是小规模纳税人或自然人;
}

// 方法3：结合发票类型和税率
if (invoice_type === '04' && (tax_rate === 0.03 || tax_rate === 0.05)) {
  likely_small_scale_taxpayer = true;
}
```

#### 6.3.4 金额计算验证

**挑战**：确保明细数据与汇总数据一致。

**验证规则**：
1. **验证明细金额合计**
   ```
   Σ(items.amount) ≈ amount (允许±0.02误差)
   ```

2. **验证明细税额合计**
   ```
   Σ(items.tax_amount) ≈ tax_amount (允许±0.02误差)
   ```

3. **验证价税合计**
   ```
   amount + tax_amount ≈ total_amount (允许±0.02误差)
   ```

4. **验证每个明细的计算逻辑**
   ```
   item.tax_amount ≈ item.amount × item.tax_rate (允许±0.01误差)
   ```

**实现逻辑**：
```
验证金额逻辑：
1. 计算明细金额合计：itemsAmount = Σ(item.JE)
2. 计算明细税额合计：itemsTax = Σ(item.SE)
3. 对比汇总金额：|itemsAmount - amount| <= 0.02
4. 对比汇总税额：|itemsTax - tax_amount| <= 0.02
5. 验证价税合计：|amount + tax_amount - total_amount| <= 0.02

如果误差超过阈值：
- 记录警告日志
- 但不影响查验结果（以长软返回为准）
```

#### 6.3.5 税率识别与验证

**挑战**：普票的主税率需要从明细中提取。

**常见税率**：
- **13%**：一般货物（一般纳税人）
- **9%**：农产品、交通运输服务等（一般纳税人）
- **6%**：现代服务业、增值电信服务等（一般纳税人）
- **3%**：小规模纳税人征收率（最常见）
- **5%**：销售不动产、劳务派遣等小规模征收率
- **0%**：出口货物、免税商品等
- **免税**：特定商品

**提取逻辑**：
```
提取主税率：
1. 遍历所有明细，提取非零税率
2. 如果所有明细税率一致，直接取该税率
3. 如果明细中有多种税率：
   - 优先选择最常见的税率
   - 或取加权平均税率
   - 或取第一个非零税率

示例：
items = [
  {amount: 100, tax_rate: 0.13, tax_amount: 13},
  {amount: 200, tax_rate: 0.13, tax_amount: 26},
  {amount: 50, tax_rate: 0, tax_amount: 0}
]

主税率 = 0.13 (13%)
```

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（发票类型04）:
- 发票代码 (FPDM)
- 发票号码 (FPHM)
- 开票日期 (KPRQ)
- **校验码后六位** (JYM)

**本公司API要求必填**（但长软API可选）:
- `invoice_code` (发票代码) - 必填
- `invoice_number` (发票号码) - 必填
- `invoice_status` (发票状态) - 从HEAD/CYJGDM映射，必填
- `seller_tax_no` (销售方识别号) - 必填
- `buyer_name` (购买方名称) - 必填
- `seller_name` (销售方名称) - 必填

**乐企查验额外必填**：
- 纳税人识别号（税号）- 购方或销方之一

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 10 | ✅ 本公司长度更大，兼容数电票号 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| name | 310 | 320 | ⚠️ 长软略大，截断风险极小 |
| verification_code | 32 | 32 | ✅ 长度一致，查验时只需后6位 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数，可记录但不返回
- `CYSJ` (查验时间) - 长软查验时间戳，可记录但不返回
- `JQBH` (机器编号) - 税控设备编号，可扩展字段支持
- `CPYBZ` (成品油标志) - 已废止，以TSPZBZ为准
- `QDBZ` (清单标志) - 是否有销货清单，可扩展字段支持
- `HZDK` (汇总代开标志) - 是否汇总代开，可扩展字段支持

**本公司独有字段**（需从其他数据源获取）:
- `void_date` (作废日期) - 从业务系统获取
- `proxy_seller_*` (代开信息) - 从业务规则解析
- `tax_rate` (主税率) - 从明细计算得出
- `item_count` (明细条数) - 从items数组长度计算
- `tax_inclusive_rate_flag` (含税税率标识) - 从业务规则判断
- `applicable_tax_rate_flag` (适用税率标识) - 从业务规则判断
- `non_taxable_amount` (不征税金额) - 从业务系统获取
- `seller_taxpayer_type_code` (销方纳税人类型) - 从业务系统获取或从税率推断
- `vehicle_abnormal_flag` (机动车异常标识) - 从业务系统获取（普票一般为0）
- `issue_type` (开票类型) - 仅乐企查验返回

### 7.4 增值税普通发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 校验码处理

**挑战**：普票查验必须提供校验码后6位，但长软返回完整校验码。

**解决方案**：
1. **查验请求时**：
   - 从用户输入获取校验码（可能是完整或后6位）
   - 如果超过6位，提取后6位
   - 调用长软API时传入后6位

2. **查验响应时**：
   - 长软API返回完整校验码（`BODY/JYM`）
   - 直接映射到本公司API的 `verification_code` 字段
   - 不需要截断或处理

**实现示例**：
```
查验请求：
用户输入：verification_code = "abcd123456789012" (完整32位)
提取后6位：last6 = "789012"
调用长软：<JYM>789012</JYM>

查验响应：
长软返回：<JYM>abcd123456789012</JYM>
映射到本公司：verification_code = "abcd123456789012"
```

#### 7.4.2 购方信息可选处理

**挑战**：普票的购方信息可能不完整，尤其是个人购买。

**解决方案**：
1. **购方名称**：必填，但可以是"个人"、"*个人*"、"*"等
2. **购方税号**：可选，个人购买时为空或"*"
3. **购方地址电话**：可选，通常为空
4. **购方银行账号**：可选，通常为空

**业务处理**：
```
判断是否为个人购买：
if (!buyer_tax_no ||
    buyer_tax_no === '' ||
    buyer_tax_no === '*' ||
    buyer_name.includes('个人') ||
    buyer_name === '*') {
  // 个人购买
  is_personal = true;
  buyer_tax_no = null;  // 统一设为null
  buyer_address_phone = null;
  buyer_bank_account = null;
}
```

**注意事项**：
- 个人购买的发票完全合法有效
- 不要因为购方信息不完整而拒绝查验
- 只要长软查验成功，就应该返回成功

#### 7.4.3 小规模纳税人识别

**挑战**：需要识别销方是否为小规模纳税人。

**识别依据**：
1. **税率为3%或5%**：小规模征收率
2. **只能开普票**：不能开专票
3. **发票类型为04**：普通发票

**业务处理**：
```
识别小规模纳税人：
is_small_scale = false;

// 检查税率
if (tax_rate === 0.03 || tax_rate === 0.05) {
  is_small_scale = true;
}

// 检查所有明细税率
all_rates_3_or_5 = items.every(item =>
  item.tax_rate === 0.03 ||
  item.tax_rate === 0.05 ||
  item.tax_rate === 0
);

if (all_rates_3_or_5 && invoice_type === '04') {
  seller_taxpayer_type_code = '2';  // 小规模纳税人
}
```

**注意事项**：
- 一般纳税人也可以开3%或5%税率的普票（简易计税）
- 最准确的识别需要从业务系统查询
- 仅供参考，不作为强制校验

#### 7.4.4 明细数据完整性验证

**挑战**：确保明细数据与汇总数据一致。

**验证规则**：
1. **验证明细金额合计**
   ```
   Σ(items.amount) ≈ amount (允许±0.02误差)
   ```

2. **验证明细税额合计**
   ```
   Σ(items.tax_amount) ≈ tax_amount (允许±0.02误差)
   ```

3. **验证价税合计**
   ```
   amount + tax_amount ≈ total_amount (允许±0.02误差)
   ```

4. **验证每个明细的计算逻辑**
   ```
   item.tax_amount ≈ item.amount × item.tax_rate (允许±0.01误差)
   ```

**处理策略**：
```
验证流程：
1. 计算明细金额合计
2. 计算明细税额合计
3. 对比汇总金额
4. 如果误差超过阈值：
   - 记录警告日志
   - 标记数据质量问题
   - 但不影响查验结果（以长软返回为准）
5. 返回验证结果
```

**注意事项**：
- 由于浮点数计算精度问题，允许小额误差（通常2分钱以内）
- 如果误差超过阈值，应记录警告日志，但不影响查验结果
- 对于清单发票（QDBZ=1），明细可能为空或不完整，此时跳过明细验证

#### 7.4.5 特殊票种处理

**成品油发票** (TSPZBZ=08):
- 明细中需要包含油品名称、单位、数量等信息
- 可能有特殊的格式要求
- 税率通常为13%

**农产品收购发票** (TSPZBZ=02):
- 购销方信息可能反向存储（与专票类似）
- 税率通常为9%或10%
- 需要从备注中解析代开信息

**稀土发票** (TSPZBZ=03/04):
- 稀土矿产品或稀土产成品
- 可能有特殊的税收政策
- 需要特殊标识和备案

**黄金发票** (TSPZBZ=20/21/22):
- 投资性黄金、非投资性黄金、标准黄金
- 税收政策特殊
- 可能有免税或零税率

**处理建议**：
```
根据特殊票种标志处理：
switch (special_invoice_type) {
  case '08':  // 成品油
    // 验证明细中是否有油品信息
    // 检查税率是否符合成品油税率
    break;
  case '02':  // 农产品收购
    // 检查是否需要购销方反向处理
    // 从备注中解析代开信息
    break;
  case '03':
  case '04':  // 稀土
    // 检查是否有稀土备案信息
    break;
  case '20':
  case '21':
  case '22':  // 黄金
    // 检查是否有黄金交易信息
    break;
  default:
    // 普通发票
    break;
}
```

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697053)
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf` (章节3.2.3.2)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 增值税专用发票映射表: `本公司01_增值税专用发票→长软01.md` (对比参考)
6. 国家税务总局发票查验平台: https://inv-veri.chinatax.gov.cn/

---

**文档结束**
