# 本公司82_数电普票（医疗门诊）→长软09(QDLX=91) 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-31
**发票类型**: 82 - 电子发票(普通发票) / 数字化电子发票-普通发票（医疗门诊）

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"数电普票（医疗门诊）"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)
- **本公司发票类型代码**: 82
- **长软发票类型代码**: 09 (数电发票)
- **长软数电发票类型**: QDLX=91 (医疗-门诊)
- **长软文档章节**: 3.2.3.21
- **长软API版本**: V4.1.2（新增）

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射(CYJGDM, ZFBZ, TSPZBZ等)

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `82` | `09` | **关键**：长软09需配合QDLX=91标识医疗门诊发票 |
| 发票类型名称 | 电子发票(普通发票) | 数电发票(普票-医疗门诊) | 医疗门诊专用的数电普票 |
| 数据结构定义 | `#/definitions/231697052` | `3.2.3.21` | |
| 发票介质 | 全电子 | 全电子 | 无纸质发票代码 |
| 数电发票类型 | - | `QDLX=91` | **V4.1.2新增**，医疗门诊发票类型 |
| 请求参数要求 | - | `REQTYPE=V2` | **新增**：必须设置为V2才能返回91格式 |

### ⚠️ 重要：触发条件

**本映射表适用于以下情况**：
1. 当本公司发票类型为82（数电普票）
2. **且**满足以下任一条件：
   - 特殊票种标志 `TSPZBZ = 16`（医疗服务-门诊）
   - 明细中包含医疗门诊特征（项目名称包含"挂号"、"诊疗费"、"检查费"等）
   - 长软查验结果返回 `QDLX = 91`
3. **且**查验请求中 `REQTYPE = V2`

**映射路由逻辑**：
```
如果 invoice_type = 82:
    如果 TSPZBZ = 16 或 长软返回QDLX=91:
        如果 REQTYPE = V2:
            使用本映射表（82→09(QDLX=91)）
        否则:
            使用标准数电普票映射表（82→09(QDLX=10)）
    否则:
        使用标准数电普票映射表（82→09(QDLX=10)）
```

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | 直接映射，数电票号20位 |
| `invoice_code` | 纸质发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | **数电普票无发票代码**，FPDM为空 |
| `paper_invoice_no` | 纸质发票号码 | string(20) | - | - | - | **本公司独有**，数电票无此字段 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `buyer_name` | 购买方名称 | string(150) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方识别号 | string(20) | `BODY/GFSH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射，**注意字段名为GFSH不是GFSBH** |
| `buyer_address` | 购买方地址 | string(300) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | 直接映射，数电票此字段为空 |
| `buyer_phone` | 购买方电话 | string(60) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | **合并字段**：需从GFDZDH解析，数电票通常为空 |
| `buyer_bank_name` | 购买方开户行 | string(120) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | **合并字段**：需从GFYHZH解析，数电票通常为空 |
| `buyer_account_number` | 购买方账号 | string(100) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | **合并字段**：需从GFYHZH解析，数电票通常为空 |
| `seller_name` | 销售方名称 | string(150) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSH` | 销方纳税人识别号 | VARCHAR2(64) | 直接映射，**注意字段名为XFSH不是XFSBH** |
| `seller_address` | 销货方地址 | string(250) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | **合并字段**：需从XFDZDH解析，数电票通常为空 |
| `seller_phone` | 销售方电话 | string(60) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | **合并字段**：需从XFDZDH解析，数电票通常为空 |
| `seller_bank_name` | 销售方开户行 | string(120) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | **合并字段**：需从XFYHZH解析，数电票通常为空 |
| `seller_account_number` | 销售方账号 | string(100) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | **合并字段**：需从XFYHZH解析，数电票通常为空 |
| - | - | - | `BODY/JYM` | 校验码 | VARCHAR2(32) | **长软字段为空**，数电票无校验码 |
| `total_tax_amount` | 合计税额 | number(18,2) | `BODY/SE` | 税额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `total_amount` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `amount_with_tax_in_words` | 价税合计(大写) | string(300) | - | - | - | **本公司独有**，需自行计算 |
| `remark` | 备注 | string(450) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/SBBH` | 设备编号 | VARCHAR2(50) | **长软字段为空**，数电票无设备编号 |
| - | - | - | `BODY/JE` | 金额 | VARCHAR2(32) | **长软独有**，本公司从items计算 |
| `invoice_status` | 发票状态 | 枚举 | `BODY/ZFBZ` | 作废标志 | CHAR(1) | 枚举映射，参见通用枚举文档 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | **长软独有**，废止字段 |
| - | - | - | `BODY/DKBZ` | 代开标志 | VARCHAR2(2) | **长软独有**，代开标志 |
| - | - | - | `BODY/URL` | OFD版式文件下载链接 | VARCHAR2(200) | **长软独有**，电子文件下载链接 |
| - | - | - | `BODY/PURL` | PDF版式文件下载链接 | VARCHAR2(200) | **长软独有**，电子文件下载链接 |
| - | - | - | `BODY/SDSKR` | 数电发票收款人 | VARCHAR2(150) | **长软独有**，数电票收款人 |
| - | - | - | `BODY/SDFHR` | 数电发票复核人 | VARCHAR2(150) | **长软独有**，数电票复核人 |
| - | - | - | `BODY/SDSJBZ` | 数电发票实际备注 | VARCHAR2(750) | **长软独有**，数电票实际备注 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| - | - | - | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | **长软独有**，16=医疗服务(门诊) |
| - | - | - | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |
| `issuer` | 开票人姓名 | string(300) | - | - | - | **本公司独有**，数电票无此字段 |
| `reviewer` | 复核人姓名 | string(75) | - | - | - | **本公司独有**，数电票无此字段 |
| `payee` | 收款人姓名 | string(150) | - | - | - | **本公司独有**，数电票无此字段 |
| `is_blue_invoice` | 蓝字/红字标识 | 枚举(Y/N) | - | - | - | **本公司独有**，从ZFBZ推断 |
| `original_blue_invoice_no` | 对应蓝字发票号码 | string(20) | - | - | - | **本公司独有**，红票时填写 |
| `seller_taxpayer_type_code` | 销方纳税人类型代码 | string | - | - | - | **本公司独有**，医疗机构通常为一般纳税人 |
| `item_count` | 明细条数 | integer | - | - | - | **本公司独有**，items数组长度 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **合并字段**: 长软API将多个字段合并到一个字段中，需要解析拆分
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `amount_with_tax_in_words` | 计算得出 | 将total_amount数字转换为中文大写 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `is_blue_invoice` | 推断得出 | 根据ZFBZ判断：0/1→Y(蓝字)，2/3/7/8→N(红字) |
| `original_blue_invoice_no` | 业务系统 | 红字发票对应的原蓝字发票号，从业务系统获取 |
| `seller_taxpayer_type_code` | 业务规则 | 医疗机构通常为一般纳税人(1) |
| `issuer` | - | 数电票无开票人字段，返回null |
| `reviewer` | - | 数电票无复核人字段，返回null |
| `payee` | - | 数电票无收款人字段，返回null |
| `paper_invoice_no` | - | 数电票无纸质号码，返回null |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

⚠️ **关键架构决策**：数电医疗门诊发票（09_91）的明细数据需要**拆分为两个独立数组**：

**本公司API结构**：
```json
{
  "items": [],                           // 标准货物明细（保持82数电普票的语义）
  "medical_outpatient_detail_list": []   // 医疗门诊特定业务要素（新增字段）
}
```

**长软API路径**: `BODY/CHILDLIST/CHILD[]`（单一数组）

⚠️ **为什么必须拆分？**
1. **语义正确性**：`items[]`的字段（如`specification`=规格型号）不能被重用为费用明细，会导致字段语义混乱
2. **数据一致性**：保持82类型发票的`items[]`结构统一，无论是普通数电普票还是医疗门诊数电普票
3. **业务扩展性**：医疗门诊特定信息（项目名称、费用明细、单位、数量）应该放在专门的业务字段中
4. **参考通行费发票**：类似于通行费发票（72）和医疗住院发票（09_90）的拆分架构

**拆分逻辑**：
- 长软09_91的每个`CHILD`元素同时映射到两个数组
- `items[]`：保留标准货物字段（金额、税率、税额），其他字段（规格型号、单位等）留空
- `medical_outpatient_detail_list[]`：包含医疗门诊特定信息（项目名称、费用明细、单位、数量、其它等）

### 3.2 标准货物明细映射（items[]）

**本公司API路径**: `items[]`

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 序号 | integer | - | - | - | **本公司独有**，用于排序，与medical_outpatient_detail_list保持一致 |
| `name` / `goods_or_service_name` | 货物或应税劳务名称 | string(300/600) | `XMMC` | 项目名称 | VARCHAR2(160) | **映射**：使用XMMC作为货物名称 |
| `specification` | 规格型号 | string(150) | - | - | - | **留空**，医疗项目无规格型号 |
| `unit` | 单位 | string(300) | `DW` | 单位 | VARCHAR2(16) | **映射**：使用DW（可选） |
| `quantity` | 发票交易数量 | string(25) | `SL` | 数量 | VARCHAR2(32) | **映射**：使用SL（可选） |
| `unit_price` | 发票交易单价 | string(25) | - | - | - | **计算**：从JE和SL计算（可选） |
| `amount` | 金额 | number(8,2) | `JE` | 金额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_rate` | 税率 | number(6,6) | - | - | - | **从SE和JE计算**，或默认0（医疗免税） |
| `tax_amount` | 税额 | number(8,6) | `SE` | 税额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_classification_code` | 商品税收分类编码 | string(19) | `SPBM` | 商品编码 | VARCHAR2(32) | **映射**：使用SPBM |
| `deduction_amount` | 扣除额 | number(8,2) | - | - | - | **本公司独有** |
| `item_short_name` | 商品服务简称 | string(120) | - | - | - | **本公司独有** |
| `product_barcode` | 商品条码 | string(300) | - | - | - | **本公司独有** |

**说明**：
- `items[]`保持标准82数电普票的结构，填充可用字段
- 与医疗住院（09_90）相比，门诊发票可能包含单位、数量信息
- 医疗门诊特定信息不混入此数组

### 3.3 医疗门诊特定业务要素映射（medical_outpatient_detail_list[]）

**本公司API路径**: `medical_outpatient_detail_list[]`（**新增字段**）

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 序号 | integer | - | - | - | **本公司独有**，与items保持一致 |
| `project_name` | 项目名称 | string(160) | `XMMC` | 项目名称 | VARCHAR2(160) | 直接映射（如"挂号费"、"诊疗费"等） |
| `expense_detail` | 费用明细 | string(160) | `FYMX` | 费用明细 | VARCHAR2(160) | 直接映射（详细说明） |
| `unit` | 单位 | string(16) | `DW` | 单位 | VARCHAR2(16) | 直接映射（如"次"、"项"等） |
| `quantity` | 数量 | string(32) | `SL` | 数量 | VARCHAR2(32) | 直接映射 |
| `amount` | 金额 | number(18,2) | `JE` | 金额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_amount` | 税额 | number(18,2) | `SE` | 税额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `other_info` | 其它 | string(160) | `QT` | 其它 | VARCHAR2(160) | 直接映射（其他补充信息） |
| `commodity_code` | 商品编码 | string(32) | `SPBM` | 商品编码 | VARCHAR2(32) | 直接映射 |
| `special_policy_code` | 特殊政策标识 | string(2) | `TSZCBS` | 特殊政策标识 | VARCHAR2(2) | 直接映射（1=免税,2=不征税,3=0税率） |
| `actual_tax_amount` | 实际税额 | string(32) | `SJSE` | 实际税额 | VARCHAR2(32) | 长软独有，实际缴纳税额 |

**说明**：
- 这是本公司API的扩展字段，专门用于存储医疗门诊业务信息
- 与`items[]`一一对应（通过`sequence_no`关联）
- 包含医疗门诊特有的字段：项目名称、费用明细、单位、数量、其它信息
- **比医疗住院（09_90）多了更详细的费用信息字段**（FYMX、DW、SL、QT）

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-31 或 2025-12-31 16:59:45 |
| 长软API | `YYYYMMDD` | 20251231 |

**转换规则**：
- 开票日期 (KPRQ): `YYYYMMDD` → `YYYY-MM-DD`
- 实现: `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额 | 本公司从items计算 | `VARCHAR2(32)` 字符串 | 长软JE字段存在但本公司不使用 |
| 税额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细金额 | `number` (8,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细税额 | `number` (8,6) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 数量 | - | `VARCHAR2(32)` 字符串 | 长软独有字段 |
| 实际税额 | - | `VARCHAR2(32)` 字符串 | 长软独有字段 |

**转换示例**：
```javascript
// 长软API返回
{
  "JE": "100.00",       // 金额（字符串）
  "SE": "0.00",         // 税额（字符串，医疗免税）
  "JSHJ": "100.00",     // 价税合计（字符串）
  "SL": "1"             // 数量（字符串）
}

// 转换为本公司API
{
  "total_tax_amount": 0.00,
  "total_amount": 100.00,
  "amount_with_tax_in_words": "壹佰元整"
}
```

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 20 | ✅ 长度一致，数电票号20位 |
| seller_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **发票状态** (ZFBZ → invoice_status)
- **特殊政策标识** (TSZCBS)

### 5.2 数电医疗门诊发票特有枚举映射

⚠️ **重要**: 以下枚举为**该发票类型特有**，不在通用枚举文档中。

#### 5.2.1 特殊票种标志 (TSPZBZ)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 15 | 医疗服务（住院）发票 | 该发票属于医疗住院类型（参见09_90） |
| 16 | 医疗服务（门诊）发票 | 该发票属于医疗门诊类型 |

**说明**：
- 本公司API暂无对应字段，可扩展时添加 `medical_type` 字段

#### 5.2.2 数电发票类型 (QDLX)

| QDLX值 | 含义 | 本公司发票类型 |
|-------|------|--------------|
| 90 | 医疗（住院）发票 | 82（数电普票-医疗住院） |
| 91 | 医疗（门诊）发票 | 82（数电普票-医疗门诊） |

**说明**：
- **V4.1.2新增**枚举值
- 需要在查验请求中设置`REQTYPE=V2`才能触发此类型返回

#### 5.2.3 特殊政策标识 (TSZCBS)

**明细级枚举**：

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 1 | 免税 | 医疗服务免税 |
| 2 | 不征税 | 医疗服务不征税 |
| 3 | 0税率 | 医疗服务零税率 |
| 01 | 不征税 | 医疗服务不征税（新编码） |
| 02 | 零税率 | 医疗服务零税率（新编码） |
| 04 | 免税 | 医疗服务免税（新编码） |

**说明**：
- TSZCBS 是明细级字段，每个明细都可能有不同的标识
- 医疗服务通常使用免税政策

---

## 六、数电医疗门诊发票特殊性说明

### 6.1 该类型的独特特性

1. **数电化的医疗门诊发票**
   - 这是传统医疗发票的数电化版本
   - 无发票代码，仅有20位发票号码
   - 无校验码，防伪通过数字签名实现
   - 通过电子税务局开具

2. **V4.1.2新增类型**
   - **QDLX=91**：专门用于医疗门诊发票
   - **REQTYPE参数**：必须设置为V2才能返回此格式
   - **向后兼容**：如果REQTYPE=V1或不填，医疗发票仍按照09_10格式返回

3. **与医疗住院(82→09_90)的区别**
   - **明细字段数量**: 门诊（91）有10个字段，住院（90）只有7个字段
   - **费用明细**: 门诊有FYMX（费用明细）字段，住院只有BZ（备注）
   - **单位数量**: 门诊有DW（单位）和SL（数量）字段，住院没有
   - **其它信息**: 门诊有QT（其它）字段，住院没有
   - **业务场景**: 门诊通常按项目收费，住院按服务项目收费

4. **与普通数电普票(82→09_10)的区别**
   - **长软类型**: 09(QDLX=10)用于普通数电普票，09(QDLX=91)专用于医疗门诊
   - **明细字段**: 09_10为常规货物明细，09_91为医疗项目明细
   - **特殊票种标志**: 09_91有TSPZBZ=16字段，09_10可能没有
   - **状态字段**: 都使用ZFBZ

5. **明细数据拆分架构**
   - 长软09_91的明细数据需要**拆分为两个独立数组**
   - `items[]`：保持标准货物明细结构（部分字段可填充）
   - `medical_outpatient_detail_list[]`：存储医疗门诊特定业务要素（项目名称、费用明细、单位、数量、其它等）
   - ❌ **禁止字段重用**：不能将`specification`重用为费用明细，会导致语义混乱

6. **医疗服务免税**
   - 医疗门诊服务通常享受免税政策
   - 税额合计(SE)通常为0
   - 价税合计(JSHJ) = 金额合计(JE)
   - TSZCBS通常标识为1（免税）或04（免税）

7. **医疗门诊特有字段**
   - `XMMC`（项目名称）：记录医疗服务项目（如"挂号费"、"诊疗费"）
   - `FYMX`（费用明细）：详细说明费用内容
   - `DW`（单位）：项目单位（如"次"、"项"）
   - `SL`（数量）：项目数量
   - `QT`（其它）：其他补充信息
   - `SPBM`（商品编码）：医疗服务税收分类编码
   - `TSZCBS`（特殊政策标识）：通常为免税
   - `SJSE`（实际税额）：实际缴纳税额

### 6.2 与其他类型的对比

| 特性 | 数电医疗门诊(82→09_91) | 数电医疗住院(82→09_90) | 数电普票(82→09_10) |
|------|---------------------|---------------------|-----------------|
| 发票代码 | ❌ 无 | ❌ 无 | ❌ 无 |
| 发票号码 | ✅ 20位 | ✅ 20位 | ✅ 20位 |
| 校验码 | ❌ 无 | ❌ 无 | ❌ 无 |
| 长软类型码 | 09(QDLX=91) | 09(QDLX=90) | 09(QDLX=10) |
| 状态字段 | ZFBZ | ZFBZ | ZFBZ |
| 特殊票种标志 | ✅ TSPZBZ=16 | ✅ TSPZBZ=15 | ❌ 通常无 |
| 明细类型 | 医疗项目明细（含费用明细） | 医疗项目明细 | 常规货物明细 |
| 明细字段数 | 10个（详细） | 7个（简化） | 11个（完整） |
| 费用明细字段 | ✅ FYMX | ❌ 无 | ❌ 无 |
| 单位数量字段 | ✅ DW、SL | ❌ 无 | ✅ 有 |
| 其它信息字段 | ✅ QT | ❌ 无 | ❌ 无 |
| 免税政策 | ✅ 通常免税 | ✅ 通常免税 | ⚠️ 视具体业务 |
| 发票介质 | 电子 | 电子 | 电子 |
| 税控设备 | ❌ 无 | ❌ 无 | ❌ 无 |

### 6.3 特殊处理逻辑

#### 6.3.1 发票类型识别与路由

**触发条件判断**：
```javascript
function determineInvoiceMapping(invoice) {
  // 如果是82类型的数电普票
  if (invoice.invoice_type === "82") {
    // 检查是否为医疗门诊类型
    if (invoice.special_invoice_type_flag === "16" ||
        hasMedicalOutpatientCharacter(invoice.items)) {
      // 使用数电医疗门诊映射（82→09_91）
      return "82_TO_09_91_MEDICAL_OUTPATIENT";
    } else if (invoice.special_invoice_type_flag === "15") {
      // 使用数电医疗住院映射（82→09_90）
      return "82_TO_09_90_MEDICAL_INPATIENT";
    } else {
      // 使用普通数电普票映射（82→09_10）
      return "82_TO_09_10_NORMAL";
    }
  }
}

function hasMedicalOutpatientCharacter(items) {
  // 检查明细中是否包含医疗门诊特征
  return items.some(item =>
    item.name?.includes("挂号费") ||
    item.name?.includes("诊疗费") ||
    item.name?.includes("检查费") ||
    item.name?.includes("化验费")
  );
}
```

**业务背景**：
- 数电发票系统中，医疗门诊类型的数电普票会被长软归类为QDLX=91
- 本公司API统一使用类型82表示数电普票，通过业务特征区分子类型
- 需要在查验时根据长软返回的QDLX动态判断使用哪个映射表

#### 6.3.2 查验请求REQTYPE参数设置

**重要**：必须在查验请求中设置`REQTYPE=V2`才能获取医疗专用格式

```javascript
// 查验请求示例
{
  "VERSION": "4.0.12",
  "FPLX": "09",
  "FPHM": "12345678901234567890",
  "KPRQ": "20251231",
  "FPJE": "100.00",
  "REQTYPE": "V2"  // 关键：必须设置为V2
}
```

**REQTYPE行为**：
- **V1（或不填）**：医疗发票按照标准09_10格式返回
- **V2**：医疗发票按照专用格式返回（09_90或09_91）

#### 6.3.3 明细字段映射处理（拆分为两个数组）

⚠️ **关键**：必须将长软09_91的明细拆分为两个独立数组。

**完整映射逻辑**：
```javascript
// 长软09_91 → 本公司82（拆分架构）
function mapMedicalOutpatientInvoice91To82(changRuanResponse) {
  const items = [];
  const medicalOutpatientDetailList = [];

  const childList = changRuanResponse.BODY.CHILDLIST.CHILD || [];

  childList.forEach((child, index) => {
    // 1. 映射到标准货物items[]（保持语义正确）
    items.push({
      sequence_no: index + 1,
      name: child.XMMC || "医疗服务",        // 项目名称
      specification: "",                      // 规格型号留空
      unit: child.DW || "",                  // 单位（可选）
      quantity: child.SL || "",              // 数量（可选）
      unit_price: calculateUnitPrice(child), // 计算单价（可选）
      amount: parseFloat(child.JE),          // 金额
      tax_rate: calculateTaxRate(child),     // 计算税率或默认0
      tax_amount: parseFloat(child.SE),      // 税额
      tax_classification_code: child.SPBM,   // 商品编码
      deduction_amount: null,                // 扣除额
      item_short_name: null,                 // 商品简称
      product_barcode: null                  // 商品条码
    });

    // 2. 映射到医疗门诊业务要素medical_outpatient_detail_list[]
    medicalOutpatientDetailList.push({
      sequence_no: index + 1,
      project_name: child.XMMC || "",                // 项目名称
      expense_detail: child.FYMX || "",              // 费用明细
      unit: child.DW || "",                          // 单位
      quantity: child.SL || "",                      // 数量
      amount: parseFloat(child.JE),                  // 金额
      tax_amount: parseFloat(child.SE),              // 税额
      other_info: child.QT || "",                    // 其它
      commodity_code: child.SPBM || "",              // 商品编码
      special_policy_code: child.TSZCBS || null,     // 特殊政策标识
      actual_tax_amount: child.SJSE || null          // 实际税额
    });
  });

  return {
    ...otherInvoiceFields,
    items: items,                                    // 标准货物明细
    medical_outpatient_detail_list: medicalOutpatientDetailList,  // 医疗门诊业务要素
    item_count: items.length                         // 明细条数
  };
}

function calculateTaxRate(child) {
  const amount = parseFloat(child.JE);
  const tax = parseFloat(child.SE);
  if (amount > 0 && tax > 0) {
    return tax / amount;
  }
  return 0;  // 免税
}

function calculateUnitPrice(child) {
  const amount = parseFloat(child.JE);
  const quantity = parseFloat(child.SL);
  if (quantity > 0) {
    return (amount / quantity).toFixed(2);
  }
  return "";
}
```

**数据示例**：
```json
{
  "invoice_number": "12345678901234567890",
  "invoice_type": "82",
  "total_amount": 150.00,
  "total_tax_amount": 0.00,

  // 标准货物明细（保持语义正确）
  "items": [
    {
      "sequence_no": 1,
      "name": "挂号费",
      "specification": "",
      "unit": "次",
      "quantity": "1",
      "unit_price": "50.00",
      "amount": 50.00,
      "tax_rate": 0.00,
      "tax_amount": 0.00,
      "tax_classification_code": "30101010100000000000"
    },
    {
      "sequence_no": 2,
      "name": "诊疗费",
      "specification": "",
      "unit": "项",
      "quantity": "1",
      "unit_price": "100.00",
      "amount": 100.00,
      "tax_rate": 0.00,
      "tax_amount": 0.00,
      "tax_classification_code": "30101010200000000000"
    }
  ],

  // 医疗门诊特定业务要素
  "medical_outpatient_detail_list": [
    {
      "sequence_no": 1,
      "project_name": "挂号费",
      "expense_detail": "普通门诊挂号",
      "unit": "次",
      "quantity": "1",
      "amount": 50.00,
      "tax_amount": 0.00,
      "other_info": "专家号",
      "commodity_code": "30101010100000000000",
      "special_policy_code": "04",      // 免税
      "actual_tax_amount": "0.00"
    },
    {
      "sequence_no": 2,
      "project_name": "诊疗费",
      "expense_detail": "内科诊疗",
      "unit": "项",
      "quantity": "1",
      "amount": 100.00,
      "tax_amount": 0.00,
      "other_info": "",
      "commodity_code": "30101010200000000000",
      "special_policy_code": "04",
      "actual_tax_amount": "0.00"
    }
  ]
}
```

#### 6.3.4 费用明细字段处理

**挑战**：医疗门诊发票包含费用明细（FYMX）字段，需要正确处理。

**解决方案**：
1. **FYMX字段含义**：
   - 详细说明医疗服务的具体内容
   - 如"普通门诊挂号"、"内科诊疗"、"血常规检查"等

2. **与项目名称（XMMC）的区别**：
   - XMMC：项目名称（如"挂号费"、"诊疗费"）
   - FYMX：费用明细（详细说明，如"普通门诊挂号"）

3. **映射到本公司API**：
   - 存储在 `medical_outpatient_detail_list[].expense_detail`
   - 不要与 `items[].name` 混淆

#### 6.3.5 单位数量字段处理

**挑战**：医疗门诊发票可能包含单位（DW）和数量（SL）字段。

**解决方案**：
1. **字段含义**：
   - DW：项目单位（如"次"、"项"、"盒"）
   - SL：项目数量（如"1"、"2"）

2. **映射策略**：
   - 同时映射到 `items[].unit` 和 `items[].quantity`
   - 同时映射到 `medical_outpatient_detail_list[].unit` 和 `medical_outpatient_detail_list[].quantity`

3. **单价计算**：
   - 如果有数量，可以计算单价：`unit_price = amount / quantity`
   - 存储在 `items[].unit_price`

#### 6.3.6 其它信息字段处理

**挑战**：医疗门诊发票包含其它（QT）字段，用于补充信息。

**解决方案**：
1. **QT字段含义**：
   - 其他补充信息
   - 如"专家号"、"急诊"、"复诊"等

2. **映射到本公司API**：
   - 存储在 `medical_outpatient_detail_list[].other_info`
   - 可以用于业务系统的附加信息展示

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API查验请求必填字段**:
- 发票类型 (`FPLX`) - 09
- 发票号码 (`FPHM`) - 20位数字
- 开票日期 (`KPRQ`) - YYYYMMDD格式
- 价税合计 (`FPJE`) - 价税合计金额
- **请求类型 (`REQTYPE`) - V2**（**新增**，必须设置为V2才能返回91格式）

**本公司API响应必填字段**:
- `invoice_number` (发票号码) - 必填，20位数字
- `invoice_status` (发票状态) - 必填，从ZFBZ映射
- `seller_name` (销售方名称) - 必填
- `buyer_name` (购买方名称) - 必填
- `total_amount` (价税合计) - 必填
- `total_tax_amount` (合计税额) - 必填
- `amount_with_tax_in_words` (价税合计大写) - 必填，需自行计算

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 20 | ✅ 长度一致，数电票号20位 |
| seller_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |
| project_name | - | 160 | ⚠️ 医疗项目名称，本公司需新增字段 |
| expense_detail | - | 160 | ⚠️ 费用明细，本公司需新增字段 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数
- `CYSJ` (查验时间) - 长软查验时间戳
- `JE` (金额) - 长软返回，本公司从items计算
- `SBBH` (设备编号) - 数电票为空
- `JYM` (校验码) - 数电票为空
- `CPYBZ` (成品油标志) - 废止字段
- `DKBZ` (代开标志) - 代开标志
- `URL` (OFD文件下载链接) - 电子文件链接
- `PURL` (PDF文件下载链接) - 电子文件链接
- `SDSKR` (数电发票收款人) - 数电票收款人
- `SDFHR` (数电发票复核人) - 数电票复核人
- `SDSJBZ` (数电发票实际备注) - 数电票实际备注
- `TSPZBZ` (特殊票种标志) - 16=医疗服务(门诊)
- `SJSE` (实际税额) - 明细级实际税额
- `FYMX` (费用明细) - 明细级费用明细
- `QT` (其它) - 明细级其它信息

**本公司独有字段**（需从其他数据源获取）:
- `amount_with_tax_in_words` (价税合计大写) - 从total_amount计算
- `item_count` (明细条数) - 从items数组长度计算
- `is_blue_invoice` (蓝字/红字标识) - 从ZFBZ推断
- `original_blue_invoice_no` (原蓝字发票号) - 从业务系统获取
- `paper_invoice_no` (纸质发票号码) - 数电票无此字段
- `invoice_code` (发票代码) - 数电票无此字段
- `issuer` (开票人) - 数电票无此字段
- `reviewer` (复核人) - 数电票无此字段
- `payee` (收款人) - 数电票无此字段
- `seller_taxpayer_type_code` (销方纳税人类型) - 从业务规则判断

### 7.4 数电医疗门诊发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 与医疗住院发票的差异处理

**挑战**：医疗门诊（09_91）和医疗住院（09_90）虽然都是医疗发票，但明细字段有显著差异。

**解决方案**：
1. **识别差异**：
   - 门诊（91）：10个明细字段，包含FYMX、DW、SL、QT
   - 住院（90）：7个明细字段，只有XMMC、JE、SE、BZ、SPBM、TSZCBS、SJSE

2. **统一处理**：
   - 使用不同的扩展字段数组：
     - 门诊：`medical_outpatient_detail_list`
     - 住院：`medical_inpatient_detail_list`
   - 保持 `items[]` 结构统一

3. **业务判断**：
   - 根据TSPZBZ或QDLX判断类型
   - 自动选择正确的映射逻辑

#### 7.4.2 费用明细与项目名称的区分

**挑战**：XMMC（项目名称）和FYMX（费用明细）容易混淆。

**解决方案**：
1. **明确定义**：
   - XMMC：项目分类（如"挂号费"、"诊疗费"）
   - FYMX：具体说明（如"普通门诊挂号"、"内科诊疗"）

2. **映射策略**：
   - XMMC → `items[].name` 和 `medical_outpatient_detail_list[].project_name`
   - FYMX → `medical_outpatient_detail_list[].expense_detail`（仅门诊有）

3. **显示建议**：
   - 列表显示：使用XMMC
   - 详情显示：同时显示XMMC和FYMX

#### 7.4.3 单位数量的正确处理

**挑战**：医疗门诊发票可能有单位数量，医疗住院没有。

**解决方案**：
1. **可选字段**：
   - DW（单位）和SL（数量）都是可选字段
   - 需要做空值判断

2. **单价计算**：
   - 如果有数量且>0，计算单价
   - 否则，单价留空

3. **验证逻辑**：
   - 如果有数量，验证：`unit_price * quantity ≈ amount`

#### 7.4.4 向后兼容处理

**挑战**：如何保证旧系统（使用V1或不设置REQTYPE）的兼容性。

**解决方案**：
1. **默认行为**：
   - 如果请求中不包含REQTYPE或REQTYPE=V1
   - 医疗发票仍按照09_10格式返回
   - 旧系统不受影响

2. **逐步迁移**：
   - 新系统统一使用REQTYPE=V2
   - 旧系统保持REQTYPE=V1或不设置
   - 根据业务需求逐步迁移

3. **数据兼容**：
   - 09_10格式的医疗发票可以转换为09_91格式
   - 主要差异在于明细字段的拆分和扩展
   - 建议在中间层做数据转换

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697052)
2. 长软API文档: `【长软】发票查验服务调用说明V4.1.2.pdf` (章节3.2.3.21，第27-28页)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 国家税务总局发票查验平台: https://inv-veri.chinatax.gov.cn/
6. 参考映射表: `本公司82_数电普票→长软09(QDLX=10).md`
7. 参考映射表: `本公司82_数电普票（医疗住院）→长软09(QDLX=90).md`

---

**文档结束**
