# 本公司83_机动车销售电子统一发票→长软09(QDLX=03) 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 83 - 机动车销售电子统一发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间,针对"机动车销售电子统一发票"的完整字段映射关系。

- **本公司API**: invoice_verification.apifox.json (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 83
- **长软发票类型代码**: 09
- **长软清单类型**: QDLX=03 (电子机动车销售统一发票)
- **长软文档章节**: 3.2.3.15

### 依赖的通用文档

本映射表引用以下通用文档,使用前请先了解:
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射(CYJGDM, ZFBZ, TSPZBZ等)

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `83` | `09` | 长软使用统一的09类型表示数电发票 |
| 发票类型名称 | 机动车销售电子统一发票 | 数电发票(电子机动车销售统一发票) | |
| 数据结构定义 | `#/definitions/231697060` | `3.2.3.15` | |
| 数电发票清单类型 | - | `QDLX=03` | **关键区分**:03表示机动车 |
| 发票号码特征 | 20位数字 | 20位数字 | 数电发票统一为20位号码 |
| 发票代码特征 | 空(纸质发票代码字段) | 空 | 数电发票无发票代码 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**,请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | 直接映射,20位数电发票号码 |
| `invoice_code` | 纸质发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(12) | **均为空**,数电发票无发票代码 |
| `paper_invoice_no` | 纸质发票号码 | string(20) | - | - | - | **本公司独有**,数电发票不适用 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**,记录查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换: YYYY-MM-DD ← YYYYMMDD |
| - | - | - | `BODY/SKPH` | 机器编码 | VARCHAR2(16) | **长软独有**,税控设备编号 |
| `buyer_name` | 购买方名称 | string(150) | `BODY/GHDW` | 购买方名称 | VARCHAR2(370) | 直接映射 |
| `buyer_tax_no` | 购买方识别号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射,企业购车时使用 |
| - | - | - | `BODY/SFZHM` | 身份证号码/组织机构代码 | VARCHAR2(70) | **长软独有**,个人购车时存储身份证号 |
| `buyer_address` | 购买方地址 | string(300) | - | - | - | **本公司独有**,长软无此字段 |
| `buyer_phone` | 购买方电话 | string(60) | - | - | - | **本公司独有**,长软无此字段 |
| `buyer_bank_name` | 购买方开户行 | string(120) | - | - | - | **本公司独有**,长软无此字段 |
| `buyer_account_number` | 购买方账号 | string(100) | - | - | - | **本公司独有**,长软无此字段 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/NSRSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_name` | 销售方名称 | string(150) | `BODY/XHDWMC` | 销货单位名称 | VARCHAR2(300) | 直接映射 |
| `seller_address` | 销货方地址 | string(250) | `BODY/DZ` | 地址 | VARCHAR2(250) | 直接映射 |
| `seller_phone` | 销售方电话 | string(60) | `BODY/DH` | 电话 | VARCHAR2(120) | 直接映射 |
| `seller_bank_name` | 销售方开户行 | string(120) | `BODY/KHYH` | 开户银行 | VARCHAR2(250) | 直接映射 |
| `seller_account_number` | 销售方账号 | string(100) | `BODY/ZH` | 账号 | VARCHAR2(300) | 直接映射 |
| `vehicle_type_code` | 车辆类型 | string(600) | `BODY/CLLX` | 车辆类型 | VARCHAR2(128) | 直接映射 |
| `product_model` | 厂牌型号 | string(150) | `BODY/CPXH` | 厂牌型号 | VARCHAR2(160) | 直接映射 |
| `origin_place` | 产地 | string(300) | `BODY/CD` | 产地 | VARCHAR2(128) | 直接映射 |
| `compliance_no` | 合格证号 | string(50) | `BODY/HGZS` | 合格证号 | VARCHAR2(160) | 直接映射 |
| `import_no` | 进口证明书号 | string(30) | `BODY/JKZMSH` | 进口证明书号 | VARCHAR2(128) | 直接映射 |
| `inspection_no` | 商检单号 | string(30) | `BODY/SJDH` | 商检单号 | VARCHAR2(128) | 直接映射 |
| `engine_no` | 发动机号码 | string(160) | `BODY/FDJHM` | 发动机号 | VARCHAR2(190) | 直接映射 |
| `vehicle_identification_no` | 车辆识别代号/车价号码 | string(30) | `BODY/CJHM` | 车辆识别代号/车架号码 | VARCHAR2(40) | 直接映射,VIN码 |
| `price_without_tax` | 不含税价 | number(18,2) | `BODY/CJFY` | 不含税价 | NUMBER(18,2) | 直接映射,车价及价外费用(不含增值税) |
| `tax_rate` | 税率 | number(16,6) | `BODY/ZZSSL` | 增值税税率或征收率 | VARCHAR2(32) | 类型转换: 长软为字符串 |
| `tax_amount` | 税额 | number(18,6) | `BODY/ZZSSE` | 增值税税额 | VARCHAR2(32) | 类型转换: 长软为字符串 |
| `total_amount` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换: 长软为字符串 |
| `total_tax_amount` | 合计税额 | number(18,2) | `BODY/ZZSSE` | 增值税税额 | VARCHAR2(32) | 映射自ZZSSE,机动车只有一个税额 |
| `amount_with_tax_in_words` | 价税合计(大写) | string(300) | - | - | - | **本公司独有**,需从业务系统计算 |
| `tax_bureau_code` | 主管税务机关代码 | string(11) | `BODY/SWJG_DM` | 主管税务机关代码 | VARCHAR2(11) | 直接映射 |
| `tax_bureau_name` | 主管税务机关名称 | string(150) | `BODY/SWJG_MC` | 主管税务机关名称 | VARCHAR2(300) | 直接映射 |
| `taxation_voucher` | 完税凭证号码 | string(40) | `BODY/WSPZHM` | 完税凭证号码 | VARCHAR2(200) | 直接映射 |
| `vehicle_tonnage` | 车辆吨位 | number(16,4) | `BODY/DW` | 吨位 | VARCHAR2(64) | 类型转换: 长软为字符串 |
| `vehicle_capacity` | 限乘人数 | string(4) | `BODY/XCRS` | 限乘人数 | VARCHAR2(40) | 直接映射 |
| `issuer` | 开票人 | string(300) | - | - | - | **本公司独有**,数电发票可能无此字段 |
| `remark` | 备注 | string(450) | - | - | - | **本公司独有**,长软09类型无备注字段 |
| `invoice_category_code` | 发票票种代码 | string(2) | - | - | - | **本公司独有**,内部分类标识 |
| `special_element_type_code` | 特定要素类型代码 | string(2) | - | - | - | **本公司独有**,特定业务要素 |
| `is_blue_invoice` | 蓝字/红字标识 | 枚举 | - | - | - | **本公司独有**,从发票号码或其他规则判断 |
| `original_blue_invoice_no` | 开具红字发票对应的蓝字发票号码 | string(20) | - | - | - | **本公司独有**,红字发票时填充 |
| `original_blue_paper_invoice_code` | 对应蓝字纸质发票代码 | string(12) | - | - | - | **本公司独有**,红字发票时填充 |
| `original_blue_paper_invoice_no` | 对应蓝字纸质发票号码 | string(20) | - | - | - | **本公司独有**,红字发票时填充 |
| `tax_classification_code` | 商品和服务税收分类合并编码 | string(19) | - | - | - | **本公司独有**,税收分类编码 |
| `invoice_status` | 发票状态 | 枚举 | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**,查验状态码,参见通用枚举文档 |
| - | - | - | `BODY/ZFBZ` | 作废标志 | CHAR(1) | **长软独有**,参见通用枚举映射 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**,查验时间戳 |
| - | - | - | `BODY/DKBZ` | 代开标志 | VARCHAR2(2) | **长软独有**,参见枚举映射 |
| - | - | - | `BODY/TSZCBS` | 特殊政策标识 | VARCHAR2(2) | **长软独有**,参见枚举映射 |
| - | - | - | `BODY/SJSL` | 实际税率 | VARCHAR2(32) | **长软独有**,实际征收税率 |
| - | - | - | `BODY/SJSE` | 实际税额 | VARCHAR2(32) | **长软独有**,实际征收税额 |
| - | - | - | `BODY/BBXX` | 版本信息 | CHAR(1) | **长软独有**,0=旧版,1=新版 |

**字段分类说明**:
- **直接映射**: 字段名和含义一致,直接对应
- **格式转换**: 需要进行格式转换(如日期、金额格式)
- **类型转换**: 需要进行数据类型转换(如string ↔ number)
- **长软独有**: 长软API独有字段,本公司API无此字段
- **本公司独有**: 本公司API独有字段,需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `amount_with_tax_in_words` | 计算得出 | 将price_without_tax转换为大写中文金额 |
| `issuer` | 业务系统 | 从企业业务系统获取开票人信息(数电发票可能无此信息) |
| `remark` | 业务系统 | 从企业业务系统获取备注信息 |
| `is_blue_invoice` | 业务规则 | 根据发票号码或金额正负判断蓝字/红字 |
| `original_blue_*` | 业务系统 | 红字发票时,从红字申请单或业务系统获取 |
| `buyer_address` | 业务系统 | 长软无此字段,从业务系统获取 |
| `buyer_phone` | 业务系统 | 长软无此字段,从业务系统获取 |
| `buyer_bank_*` | 业务系统 | 长软无此字段,从业务系统获取 |
| `tax_classification_code` | 业务规则 | 商品税收分类编码,从商品编码库获取 |
| `paper_invoice_no` | 不适用 | 数电发票无纸质发票号码 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`(不适用于机动车发票)
**长软API路径**: 无货物明细结构

⚠️ **注意**:
- ❌ **机动车发票无货物明细结构**
- 机动车发票的商品信息已经包含在主信息中(车辆信息)
- 长软API不返回货物明细
- 本公司API不返回items字段或返回空数组

### 3.2 车辆信息vs货物明细

机动车发票的特殊性在于:车辆信息直接在主信息中,而非作为明细行。

**传统发票(如81数电专票)**:
```
主信息: 购销方、金额合计
  └─ 明细: 货物1、货物2、货物3...
```

**机动车发票(83数电机动车)**:
```
主信息: 购销方、车辆信息(厂牌型号、VIN码、发动机号...)、金额
  └─ 无明细
```

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**:
- 长软 → 本公司: "20251230" → "2025-12-30"
- 提取年月日并插入连字符

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 不含税价 | `number` (18,2) | `NUMBER(18,2)` | 类型一致,直接映射 |
| 税率 | `number` (16,6) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 税额 | `number` (18,6) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 车辆吨位 | `number` (16,4) | `VARCHAR2(64)` 字符串 | 长软→本公司: `parseFloat()` |

**转换示例**:
```
长软API返回:
{
  "ZZSSL": "0.13",      // 13%税率
  "ZZSSE": "13000.00",  // 税额
  "JSHJ": "113000.00",  // 价税合计
  "CJFY": 100000.00     // 不含税价
}

转换为本公司API:
{
  "tax_rate": 0.13,
  "tax_amount": 13000.00,
  "total_amount": 113000.00,
  "total_tax_amount": 13000.00,
  "price_without_tax": 100000.00
}
```

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 20 | ✅ 长度一致,数电发票统一20位 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大,但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大,但实际18位够用 |
| product_model | 150 | 160 | ⚠️ 长软略大,注意截断风险 |
| vehicle_type_code | 600 | 128 | ⚠️ 本公司更大,安全 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括:
- **查验结果代码** (CYJGDM → invoice_status)
- **作废标志** (ZFBZ → 内部处理)
- **特殊票种标志** (TSPZBZ → 不适用于机动车)

### 5.2 机动车数电发票特有枚举映射

⚠️ **重要**: 以下枚举为**该发票类型特有**,不在通用枚举文档中。

#### 5.2.1 版本信息 (BBXX)

| 长软值 | 含义 | 本公司映射 | 说明 |
|-------|------|-----------|------|
| 0 | 旧版机动车发票 | 不映射(长软独有) | 2018年之前的旧版式 |
| 1 | 新版机动车发票 | 不映射(长软独有) | 2018年8月启用的新版式 |

**说明**: 本公司API暂不包含版本信息字段,如需扩展可添加 `vehicle_invoice_version` 字段。

#### 5.2.2 代开标志 (DKBZ)

| 长软值 | 含义 | 本公司映射 | 处理逻辑 |
|-------|------|-----------|----------|
| 0 | 非代开 | 不映射 | 自开发票 |
| 1 | 自开 | 不映射 | 自开发票 |
| 2 | 代开 | 不映射 | 代开发票,可记录但不返回 |

**处理规则**: 数电发票的代开信息可能与传统发票不同,建议记录但不作为主要业务字段。

#### 5.2.3 特殊政策标识 (TSZCBS)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 1 | 免税 | 享受免税政策 |
| 2 | 不征税 | 不征税项目 |
| 3 | 0税率 | 适用0税率 |
| 01 | 不征税 | 同2 |

**说明**: 本公司API暂无对应字段,建议记录用于内部分析。

#### 5.2.4 蓝字/红字标识 (is_blue_invoice)

| 本公司枚举值 | 含义 | 判断规则 |
|------------|------|----------|
| `true` | 蓝字发票 | 正常开具的发票,金额为正 |
| `false` | 红字发票 | 冲红发票,金额为负或有原始蓝字发票号码 |

**判断逻辑**:
- 如果 `total_amount < 0` 或 `price_without_tax < 0`,则为红字发票
- 如果有 `original_blue_invoice_no` 字段,则为红字发票
- 否则为蓝字发票

---

## 六、机动车数电发票特殊性说明

### 6.1 该类型的独特特性

1. **数电发票特征**
   - 发票号码为20位数字,无发票代码
   - 通过长软09类型查验,QDLX=03区分为机动车
   - 电子化发票,无纸质实体

2. **无货物明细结构**
   - 机动车发票的商品信息(车辆信息)直接在主信息中
   - 一张发票对应一台车辆
   - 不使用CHILDLIST/CHILD结构

3. **购方可能是个人**
   - 企业购车: 使用 `GFSBH`(购方纳税人识别号)
   - 个人购车: 使用 `SFZHM`(身份证号码)
   - 长软API分别存储,本公司API统一使用 `buyer_tax_no`

4. **车辆唯一标识**
   - **VIN码**(vehicle_identification_no / CJHM): 车辆识别代号,全球唯一,17位
   - **发动机号**(engine_no / FDJHM): 发动机号码
   - **合格证号**(compliance_no / HGZS): 车辆合格证书号

5. **金额计算逻辑**
   - 不含税价(price_without_tax / CJFY): 车价及价外费用,不含增值税
   - 价税合计 = 不含税价 + 增值税税额
   - 税额 = 不含税价 × 税率

6. **与传统机动车发票(03)的区别**
   - 发票号码: 20位 vs 8位
   - 发票代码: 无 vs 12位
   - 查验方式: 长软09(QDLX=03) vs 长软03
   - 介质: 纯电子 vs 纸质

### 6.2 与其他类型的区别

| 特性 | 机动车数电(83) | 传统机动车(03) | 数电专票(81) |
|------|--------------|--------------|-------------|
| 发票号码 | 20位数字 | 8位数字 | 20位数字 |
| 发票代码 | 无 | 12位 | 无 |
| 长软类型 | 09(QDLX=03) | 03 | 09(QDLX=20) |
| 明细结构 | ❌ 无明细 | ❌ 无明细 | ✅ 有货物明细 |
| 特殊字段 | VIN码、发动机号、合格证号 | VIN码、发动机号、合格证号 | 无 |
| 购方标识 | 税号或身份证号 | 税号或身份证号 | 仅税号 |
| 介质 | 纯电子 | 纸质 | 纯电子 |

### 6.3 特殊处理逻辑

#### 6.3.1 购方标识判断

**挑战**: 机动车发票的购方可能是企业或个人,长软API分别存储在GFSBH和SFZHM。

**处理规则**:
1. 优先使用 `GFSBH`(购方纳税人识别号)
   - 如果GFSBH存在且长度≥15位,映射到 `buyer_tax_no`
2. 个人购车时
   - 使用 `SFZHM`(身份证号码,18位)
   - 可扩展字段 `id_card_no` 存储,或直接存入 `buyer_tax_no`
3. 建议处理逻辑:
   - 企业: `buyer_tax_no` = GFSBH
   - 个人: `buyer_tax_no` = SFZHM (统一使用识别号字段)

#### 6.3.2 金额计算验证

**验证公式**:
```
价税合计 = 不含税价 + 增值税税额
增值税税额 = 不含税价 × 税率
```

**验证逻辑**:
- 验证1: 税额 = 不含税价 × 税率 (允许±0.02误差)
- 验证2: 价税合计 = 不含税价 + 税额 (允许±0.02误差)
- 税率一般为13%、9%或0%(免税车辆)

#### 6.3.3 车辆唯一性验证

**VIN码验证**:
- 必须为17位字符
- 格式: 世界制造厂识别代码(3位) + 车辆说明(6位) + 年份(1位) + 装配厂(1位) + 顺序号(6位)
- 示例: LHGCM1649A0123456

**业务规则**:
- 查验时记录VIN码,防止同一车辆多次开票
- 结合发动机号和合格证号进行交叉验证
- 对于进口车辆,额外验证进口证明书号

#### 6.3.4 红字发票处理

**识别规则**:
- `is_blue_invoice = false` 表示红字发票
- 金额为负值
- 有 `original_blue_invoice_no` 字段

**处理要点**:
- 记录原始蓝字发票号码
- 金额字段保持负值
- 查验时需验证原始蓝字发票存在性

#### 6.3.5 数电发票特殊字段处理

**缺失的传统字段**:
- 数电发票无发票代码(invoice_code = 空)
- 数电发票无纸质发票号码(paper_invoice_no = 空)
- 数电发票可能无开票人信息(issuer可能为空)

**新增的数电字段**:
- 发票号码统一为20位
- 通过QDLX=03识别为机动车类型
- 可能包含数电发票特有的业务要素

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**:
- 发票号码(FPHM)
- 开票日期(KPRQ)
- 价税合计(JSHJ) - 用于查验校验

**本公司API要求必填**(根据schema):
- `is_blue_invoice` (蓝字/红字标识)
- `seller_name` (销售方名称)
- `buyer_name` (购买方名称)
- `total_amount` (价税合计)
- `total_tax_amount` (合计税额)
- `amount_with_tax_in_words` (价税合计大写)
- `product_model` (厂牌型号)
- `vehicle_identification_no` (车辆识别代号)
- `tax_rate` (税率)
- `tax_amount` (税额)
- `price_without_tax` (不含税价)
- `invoice_status` (发票状态)

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 20 | ✅ 长度一致,安全 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大,但中国税号18位,20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大,但中国税号18位,20位足够 |
| product_model | 150 | 160 | ⚠️ 长软略大,可能截断,需监控 |
| vehicle_type_code | 600 | 128 | ✅ 本公司更大,安全 |

### 7.3 数据完整性

**长软独有字段**(本公司API无对应):
- `CYCS` (查验次数) - 长软统计查验次数,可记录但不返回
- `CYSJ` (查验时间) - 长软查验时间戳,可记录
- `SKPH` (机器编码) - 税控设备编号
- `SFZHM` (身份证号) - 个人购车时使用,本公司统一用buyer_tax_no
- `DKBZ` (代开标志) - 代开发票标识
- `TSZCBS` (特殊政策标识) - 特殊税收政策
- `SJSL` (实际税率) - 实际征收税率
- `SJSE` (实际税额) - 实际征收税额
- `BBXX` (版本信息) - 发票新旧版本
- `ZFBZ` (作废标志) - 作废状态

**本公司独有字段**(需从其他数据源获取):
- `paper_invoice_no` (纸质发票号码) - 数电发票不适用
- `buyer_address` (购买方地址) - 从业务系统获取
- `buyer_phone` (购买方电话) - 从业务系统获取
- `buyer_bank_name` (购买方开户行) - 从业务系统获取
- `buyer_account_number` (购买方账号) - 从业务系统获取
- `amount_with_tax_in_words` (价税合计大写) - 计算得出
- `issuer` (开票人) - 从业务系统获取或为空
- `remark` (备注) - 从业务系统获取
- `is_blue_invoice` (蓝字/红字标识) - 根据金额正负判断
- `original_blue_*` (原始蓝字发票信息) - 红字发票时从业务系统获取
- `tax_classification_code` (税收分类编码) - 从商品编码库获取
- `invoice_category_code` (发票票种代码) - 内部分类
- `special_element_type_code` (特定要素类型代码) - 特定业务要素

### 7.4 机动车数电发票特殊集成要点

⚠️ **这是最重要的部分,必须根据业务特性详细说明!**

#### 7.4.1 查验参数注意事项

**税务总局查验平台必填**:
- 发票号码(20位数电发票号码)
- 开票日期
- 金额(价税合计)

**乐企查验接口必填**:
- 发票号码(20位数电发票号码)
- 开票日期
- 金额(价税合计)
- 税号(销方或购方纳税人识别号)

**注意**: 数电发票无发票代码,`invoice_code`字段应传空或不传。

#### 7.4.2 QDLX识别逻辑

**关键**: 长软API使用统一的09类型表示数电发票,通过QDLX字段区分具体类型。

**QDLX值对应关系**:
- QDLX=20: 数电专票(本公司81)
- QDLX=10: 数电普票(本公司82)
- QDLX=03: 数电机动车(本公司83) ← **本类型**
- QDLX=15: 数电二手车(本公司84)
- QDLX=01: 数电纸质专票(本公司85)
- QDLX=04: 数电纸质普票(本公司86)

**处理建议**:
- 解析长软返回时,必须检查QDLX值
- 如果QDLX≠03,说明发票类型不匹配,应报错
- 记录QDLX值用于日志和调试

#### 7.4.3 个人vs企业购车处理

**长软API返回**:
- 企业购车: `GFSBH` 有值(纳税人识别号), `SFZHM` 可能有组织机构代码或为空
- 个人购车: `SFZHM` 有值(身份证号), `GFSBH` 可能为空

**本公司API映射策略**:

**方案1 (推荐)**: 统一映射到 `buyer_tax_no`
```
if (GFSBH存在且长度 >= 15) {
  buyer_tax_no = GFSBH  // 企业税号
} else if (SFZHM存在且长度 == 18) {
  buyer_tax_no = SFZHM  // 个人身份证号
} else {
  buyer_tax_no = GFSBH || SFZHM || null
}
```

**方案2**: 分别映射(需扩展schema)
```
buyer_tax_no = GFSBH        // 企业税号
id_card_no = SFZHM          // 身份证号/组织机构代码
```

建议采用方案1,保持API简洁性。

#### 7.4.4 金额字段映射

**长软返回字段**:
- `CJFY` (不含税价) - NUMBER(18,2)
- `ZZSSL` (增值税税率) - VARCHAR2(32) 字符串
- `ZZSSE` (增值税税额) - VARCHAR2(32) 字符串
- `JSHJ` (价税合计) - VARCHAR2(32) 字符串

**本公司映射字段**:
- `price_without_tax` ← CJFY (直接映射)
- `tax_rate` ← ZZSSL (字符串转数值)
- `tax_amount` ← ZZSSE (字符串转数值)
- `total_tax_amount` ← ZZSSE (同tax_amount,机动车只有一个税额)
- `total_amount` ← JSHJ (字符串转数值)

**类型转换示例**:
```javascript
{
  price_without_tax: parseFloat(CJFY),           // 100000.00
  tax_rate: parseFloat(ZZSSL),                    // 0.13
  tax_amount: parseFloat(ZZSSE),                  // 13000.00
  total_tax_amount: parseFloat(ZZSSE),            // 13000.00
  total_amount: parseFloat(JSHJ)                  // 113000.00
}
```

#### 7.4.5 数电发票特有处理

**发票代码处理**:
- `invoice_code` 字段始终为空
- `paper_invoice_no` 字段不适用,为空

**发票号码处理**:
- `invoice_number` 为20位数字字符串
- 格式验证: 必须为纯数字且长度=20

**蓝字/红字识别**:
- 数电发票通过金额正负判断
- 红字发票: `total_amount < 0` 或 `price_without_tax < 0`
- 需要从业务系统获取 `original_blue_invoice_no`

**版本信息**:
- 长软返回BBXX字段(0=旧版,1=新版)
- 数电发票应该都是新版(BBXX=1)
- 本公司API暂不返回此字段

#### 7.4.6 异常情况处理

**查验失败场景**:
1. 发票不存在: `CYJGDM ≠ 001`
2. 发票已作废: `ZFBZ = 1`
3. 金额不匹配: 查验时传入的金额与实际不符
4. 类型不匹配: QDLX ≠ 03

**建议处理**:
- 记录完整的长软返回XML用于排查
- 记录QDLX值,确保类型匹配
- 对于作废发票,仍返回完整信息但标注状态
- 金额验证失败时,提示用户检查输入

---

## 参考文档

1. 本公司API定义: `invoice_verification.apifox.json` - schema `#/definitions/231697060`
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf` - 第3.2.3.15节
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 传统机动车发票映射(对比参考): `本公司03_机动车销售统一发票→长软03.md`
6. 国家税务总局发票查验平台: https://inv-veri.chinatax.gov.cn/

---

**文档结束**
