# 本公司88_数电纸质发票(二手车销售统一发票)→长软09(QDLX=15) 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 88 - 纸质发票（二手车销售统一发票）/ 数字化电子发票-纸质二手车销售统一发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"数电纸质二手车销售统一发票"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)
- **本公司发票类型代码**: 88
- **长软发票类型代码**: 09 (数电发票)
- **长软数电发票类型**: QDLX=15 (数电二手车)
- **长软文档章节**: 3.2.3.9

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `88` | `09` | 长软数电发票统一类型代码 |
| 数电发票子类型 | - | `QDLX=15` | **关键**：长软用QDLX区分数电子类型 |
| 发票类型名称 | 纸质发票（二手车销售统一发票） | 数电发票(纸质二手车) | |
| 数据结构定义 | `#/definitions/231697061` | `3.2.3.9` | 本定义也包含84类型 |
| 发票介质 | 纸质+电子 | 纸质+电子 | 同时具有纸质和电子形态 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | **双重号码**：可为8位纸质号或20位数电号 |
| `invoice_code` | 纸质发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 纸质发票代码，12位 |
| `paper_invoice_no` | 纸质发票号码 | string(20) | - | - | - | **本公司独有**，存储8位纸质号码 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录该发票被查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `invoice_category_code` | 发票票种代码 | string(2) | - | - | - | **本公司独有**，数电二手车固定为特定代码 |
| `special_element_type_code` | 特定要素类型代码 | 枚举(51/52) | `BODY/FXKPBZ` | 反向开票标志 | VARCHAR2(2) | 枚举映射：51=正常(0)，52=反向(1) |
| `is_blue_invoice` | 蓝字/红字标识 | 枚举(Y/N) | - | - | - | **本公司独有**，从ZFBZ推断 |
| `original_blue_invoice_no` | 开具红字发票对应的蓝字发票号码 | string(20) | - | - | - | **本公司独有**，红字发票时填写 |
| `original_blue_paper_invoice_code` | 开具红字发票对应的纸质发票代码 | string(12) | - | - | - | **本公司独有**，红字发票对应的纸质代码 |
| `original_blue_paper_invoice_no` | 开具红字发票对应的纸质发票号码 | string(20) | - | - | - | **本公司独有**，红字发票对应的纸质号码 |
| - | - | - | `BODY/SKPH` | 机器编码 | VARCHAR2(16) | **长软字段为空**，数电票无税控设备 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| `remark` | 备注 | string(450) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/SDSJBZ` | 数电发票实际备注 | VARCHAR2(750) | **长软独有**，数电票特有备注 |
| `invoice_status` | 发票状态 | 枚举 | `BODY/ZFBZ` | 作废标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算
- **双重号码**: 数电纸质票同时具有纸质号码（8位）和数电号码（20位）

### 2.2 卖方信息字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `seller_name` | 销售方名称 | string(150) | `BODY/XFDW` | 卖方单位/个人 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFHM` | 卖方单位代码/身份证号 | VARCHAR2(64) | 直接映射，可能是税号或身份证号 |
| `seller_address` | 销货方地址 | string(250) | `BODY/XFDZ` | 卖方单位/个人住址 | VARCHAR2(310) | 直接映射 |
| `seller_phone` | 销售方电话 | string(60) | `BODY/XFDH` | 卖方电话 | VARCHAR2(80) | 直接映射 |
| `seller_bank_name` | 销售方开户行 | string(120) | - | - | - | **本公司独有**，数电票无此字段 |
| `seller_account_number` | 销售方账号 | string(100) | - | - | - | **本公司独有**，数电票无此字段 |

### 2.3 买方信息字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `buyer_name` | 购买方名称 | string(150) | `BODY/GFDW` | 买方单位/个人 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方识别号 | string(20) | `BODY/GFHM` | 买方单位代码/身份证号 | VARCHAR2(64) | 直接映射，可能是税号或身份证号 |
| `buyer_address` | 购买方地址 | string(300) | `BODY/GFDZ` | 买方单位/个人住址 | VARCHAR2(310) | 直接映射 |
| `buyer_phone` | 购买方电话 | string(60) | `BODY/GFDH` | 买方电话 | VARCHAR2(80) | 直接映射 |
| `buyer_bank_name` | 购买方开户行 | string(120) | - | - | - | **本公司独有**，数电票无此字段 |
| `buyer_account_number` | 购买方账号 | string(100) | - | - | - | **本公司独有**，数电票无此字段 |

### 2.4 拍卖单位信息字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `auction_company_name` | 拍卖单位纳税人名称 | string(300) | `BODY/JYDW` | 经营、拍卖单位 | VARCHAR2(300) | **字段复用**，与经营单位共用长软字段 |
| `auction_company_tax_no` | 拍卖单位纳税人识别号 | string(20) | `BODY/JYSBH` | 经营、拍卖单位纳税人识别号 | VARCHAR2(26) | **字段复用**，与经营单位共用长软字段 |
| `auction_company_address` | 拍卖单位地址 | string(300) | `BODY/JYDZ` | 经营、拍卖单位地址 | VARCHAR2(310) | **字段复用**，与经营单位共用长软字段 |
| `auction_company_phone` | 拍卖单位电话 | string(60) | `BODY/JYDH` | 经营、拍卖单位电话 | VARCHAR2(80) | **字段复用**，与经营单位共用长软字段 |
| `auction_company_bank_name` | 拍卖单位开户银行 | string(120) | `BODY/JYYHZH` | 开户银行及账号 | VARCHAR2(250) | 字段复用，需解析银行名称 |
| `auction_company_account_number` | 拍卖单位银行账号 | string(50) | `BODY/JYYHZH` | 开户银行及账号 | VARCHAR2(250) | 字段复用，需解析账号 |

### 2.5 经营单位信息字段映射

⚠️ **重要**: 本公司API将拍卖单位和经营单位分开，但长软API使用同一组字段（JYDW/JYSBH等），需要根据业务逻辑判断。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `business_company_name` | 经营单位纳税人名称 | string(300) | `BODY/JYDW` | 经营、拍卖单位 | VARCHAR2(300) | **字段复用**，与拍卖单位共用长软字段 |
| `business_company_tax_no` | 经营单位纳税人识别号 | string(20) | `BODY/JYSBH` | 经营、拍卖单位纳税人识别号 | VARCHAR2(26) | **字段复用**，与拍卖单位共用长软字段 |
| `business_company_address` | 经营单位地址 | string(300) | `BODY/JYDZ` | 经营、拍卖单位地址 | VARCHAR2(310) | **字段复用**，与拍卖单位共用长软字段 |
| `business_company_phone` | 经营单位电话 | string(60) | `BODY/JYDH` | 经营、拍卖单位电话 | VARCHAR2(80) | **字段复用**，与拍卖单位共用长软字段 |
| `business_company_bank_name` | 经营单位开户银行 | string(120) | `BODY/JYYHZH` | 开户银行及账号 | VARCHAR2(250) | 字段复用，需解析银行名称 |
| `business_company_account_number` | 经营单位银行账号 | string(50) | `BODY/JYYHZH` | 开户银行及账号 | VARCHAR2(250) | 字段复用，需解析账号 |

### 2.6 二手车市场信息字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `used_car_market_name` | 二手车市场纳税人名称 | string(300) | `BODY/SCMC` | 二手车市场 | VARCHAR2(300) | 直接映射 |
| `used_car_market_tax_no` | 二手车市场纳税人识别号 | string(20) | `BODY/SCSBH` | 二手车市场纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `used_car_market_address` | 二手车市场地址 | string(300) | `BODY/SCDZ` | 二手车市场地址 | VARCHAR2(310) | 直接映射 |
| `used_car_market_phone` | 二手车市场电话 | string(60) | `BODY/SCDH` | 二手车市场电话 | VARCHAR2(80) | 直接映射 |
| `used_car_market_bank_name` | 二手车市场开户银行 | string(120) | `BODY/SCYHZH` | 二手车市场开户银行及账号 | VARCHAR2(250) | 需解析银行名称 |
| `used_car_market_account_number` | 二手车市场银行账号 | string(50) | `BODY/SCYHZH` | 二手车市场开户银行及账号 | VARCHAR2(250) | 需解析账号 |

### 2.7 车辆信息字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `license_plate_no` | 车牌照号 | string(20) | `BODY/CPZH` | 车牌照号 | VARCHAR2(32) | 直接映射 |
| `registration_no` | 登记证号 | string(20) | `BODY/DJZH` | 登记证号 | VARCHAR2(32) | 直接映射 |
| `vehicle_type_code` | 车辆类型 | string(600) | `BODY/CLLX` | 车辆类型 | VARCHAR2(32) | 直接映射 |
| `vehicle_identification_no` | 车辆识别代号/车架号码 | string(30) | `BODY/CJHM` | 车辆识别代号/车架号码 | VARCHAR2(64) | 直接映射，VIN码 |
| `product_model` | 厂牌型号 | string(150) | `BODY/CPXH` | 厂牌型号 | VARCHAR2(96) | 直接映射 |
| `transfer_vehicle_management_name` | 转入地车辆管理所名称 | string(80) | `BODY/CGSMC` | 转入地车辆车管所名称 | VARCHAR2(310) | 直接映射 |
| `vehicle_price_total` | 车价合计小写 | number(18,2) | `BODY/CJHJ` | 车价合计 | VARCHAR2(32) | 类型转换：长软为字符串，**不含税价** |
| `vehicle_price_total_in_words` | 车价合计大写 | string(300) | - | - | - | **本公司独有**，从vehicle_price_total计算 |

### 2.8 金额字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `amount_including_tax` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_amount` | 合计税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `amount_in_words` | 价税合计(大写) | string(300) | - | - | - | **本公司独有**，从amount_including_tax计算 |

### 2.9 其他字段映射

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `issuer` | 开票人 | string(300) | - | - | - | **本公司独有**，数电票无此字段 |
| `tax_classification_code` | 商品和服务税收分类合并编码 | string(19) | - | - | - | **本公司独有**，二手车统一编码 |

### 2.10 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `paper_invoice_no` | FPHM字段 | 如果是8位号码，同时存储到paper_invoice_no |
| `invoice_code` | FPDM字段 | 纸质发票代码，12位 |
| `invoice_category_code` | 业务规则 | 数电二手车固定为特定代码 |
| `is_blue_invoice` | 推断得出 | 根据ZFBZ判断：0/1→Y(蓝字)，3/7/8→N(红字) |
| `original_blue_invoice_no` | 业务系统 | 红字发票对应的原蓝字发票号，从业务系统获取 |
| `original_blue_paper_invoice_code` | 业务系统 | 红字发票对应的纸质代码 |
| `original_blue_paper_invoice_no` | 业务系统 | 红字发票对应的纸质号码 |
| `seller_bank_name` | - | 数电票简化信息，返回null |
| `seller_account_number` | - | 数电票简化信息，返回null |
| `buyer_bank_name` | - | 数电票简化信息，返回null |
| `buyer_account_number` | - | 数电票简化信息，返回null |
| `vehicle_price_total_in_words` | 计算得出 | 将vehicle_price_total数字转换为中文大写 |
| `amount_in_words` | 计算得出 | 将amount_including_tax数字转换为中文大写 |
| `issuer` | - | 数电票无开票人字段，返回null |
| `tax_classification_code` | 业务规则 | 二手车统一使用特定税收分类编码 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

⚠️ **注意**:
- ❌ **数电纸质二手车销售统一发票无货物明细结构**
- 二手车发票是单笔交易，只有一个车价合计（不含税价）
- 车辆信息字段直接在发票主信息中，不在明细列表中
- **长软API无 `CHILDLIST` 节点**
- **本公司API无 `items[]` 数组**

### 3.2 与数电专票的区别

| 项目 | 数电纸质二手车发票 (88) | 数电专票 (81) |
|------|-------------------|--------------|
| 明细结构 | ❌ 无明细 | ✅ 有货物明细 |
| 车价性质 | **不含税价** | - |
| 涉及方数量 | 四方或五方 | 两方 |
| 特殊字段 | 车辆信息、拍卖/经营单位、二手车市场 | 购销方完整信息 |
| 发票介质 | 纸质+电子 | 全电子 |

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**：
长软 → 本公司: 将 "20251230" 转换为 "2025-12-30"

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 车价合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 税额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 20 | ✅ 长度一致，可支持8位或20位号码 |
| invoice_code | 12 | 20 | ✅ 本公司12位，长软20位，纸质代码12位足够 |
| seller_tax_no | 20 | 64 | ⚠️ 长软更大，支持身份证18位或税号18位 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，支持身份证18位或税号18位 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |
| product_model | 150 | 96 | ✅ 本公司更大，无风险 |
| vehicle_type_code | 600 | 32 | ✅ 本公司更大，无风险 |
| vehicle_identification_no | 30 | 64 | ⚠️ 长软更大，VIN码17位，30位足够 |

### 4.4 银行账号字段解析

长软API将银行名称和账号合并在一个字段中，需要解析：

**长软字段**: `JYYHZH`、`SCYHZH` 格式通常为 "银行名称 账号"
**解析逻辑**:
- 按空格或其他分隔符分割
- 前半部分为银行名称
- 后半部分为账号

**示例**:
```
长软: "中国工商银行北京分行 6222021234567890123"
↓ 解析
本公司:
  auction_company_bank_name: "中国工商银行北京分行"
  auction_company_account_number: "6222021234567890123"
```

### 4.5 双重号码处理

数电纸质二手车发票同时具有纸质号码和数电号码：

**处理逻辑**:
1. 从 `BODY/FPHM` 获取发票号码
2. 判断号码长度：
   - 如果是8位：为纸质号码
     - `invoice_number` = FPHM（8位）
     - `paper_invoice_no` = FPHM（8位）
   - 如果是20位：为数电号码
     - `invoice_number` = FPHM（20位）
     - `paper_invoice_no` = null（或从其他来源获取）
3. 从 `BODY/FPDM` 获取发票代码
   - `invoice_code` = FPDM（12位纸质代码）

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **作废标志** (ZFBZ → invoice_status)

### 5.2 数电纸质二手车发票特有枚举映射

⚠️ **重要**: 以下枚举为**该发票类型特有**，不在通用枚举文档中。

#### 5.2.1 发票类型区分 (QDLX)

数电发票统一使用长软类型代码09，通过QDLX字段区分子类型：

| QDLX值 | 含义 | 本公司发票类型 |
|-------|------|--------------|
| 15 | 数电二手车（纸质+电子） | 88（纸质）/ 84（电子） |
| 20 | 数电专票（电子） | 81 |
| 10 | 数电普票（电子） | 82 |
| 03 | 数电机动车（电子） | 83 |
| 01 | 数电专票（纸质） | 85 |
| 04 | 数电普票（纸质） | 86 |

**说明**：
- 长软在消息头 `HEAD/QDLX` 返回此字段
- **本映射表仅处理QDLX=15（数电二手车）的纸质形态**
- 需要通过发票代码和号码长度区分纸质（88）和电子（84）

#### 5.2.2 特定要素类型代码 (反向开票标志)

**本公司字段**: `special_element_type_code`
**长软字段**: `BODY/FXKPBZ`

| 本公司值 | 本公司含义 | 长软值 | 长软含义 | 说明 |
|---------|-----------|-------|---------|------|
| 51 | 正常开具 | 0 | 否 | 正常开票（买方开给卖方） |
| 52 | 反向开具 | 1 | 是 | 反向开票（卖方开给买方） |

**业务含义**：
- 正常情况（51/0）：经营单位或二手车市场作为开票方，开给买方
- 反向开票（52/1）：买方作为开票方，开给卖方（特殊业务场景）

#### 5.2.3 买方/卖方代码类型识别

**长软字段**: `BODY/GFHM`、`BODY/XFHM`
**本公司字段**: `buyer_tax_no`、`seller_tax_no`

由于买方和卖方可能是个人，代码字段可能是以下两种类型之一：

| 类型 | 格式 | 长度 | 识别规则 |
|------|------|------|---------|
| 纳税人识别号（税号） | 纯数字 | 15位或18位 | 企业统一社会信用代码或税号 |
| 身份证号 | 数字+字母(X) | 18位 | 个人身份证号码 |

**识别逻辑**：
检查代码字段的长度和格式：
- 18位且包含字母X → 身份证号
- 15位或18位纯数字 → 税号

---

## 六、数电纸质二手车发票特殊性说明

### 6.1 该类型的独特特性

1. **双重介质形态**
   - 数电纸质二手车发票**同时具有纸质和电子形态**
   - 纸质发票有12位发票代码和8位发票号码
   - 电子发票有20位数电发票号码
   - 查验时可能使用纸质号码或数电号码

2. **双重号码体系**
   - **纸质号码**：8位（存储在paper_invoice_no）
   - **数电号码**：20位（存储在invoice_number）
   - **发票代码**：12位（存储在invoice_code）
   - FPHM字段可能返回8位或20位，需判断

3. **无税控设备信息**
   - **没有机器编号**（SKPH为空）
   - 数电票通过电子税务局开具，无需税控设备

4. **四方或五方主体结构**
   - **买方**：购买二手车的单位或个人
   - **卖方**：出售二手车的单位或个人
   - **拍卖单位**：实际拍卖方（可选）
   - **经营单位**：实际经营方（可选）
   - **二手车市场**：提供交易场所的市场管理方

   ⚠️ **注意**: 本公司API将拍卖单位和经营单位分开，但长软API使用同一组字段（JYDW/JYSBH等），需要根据业务逻辑判断实际是拍卖单位还是经营单位。

5. **车价合计为不含税价**
   - 二手车发票的 `CJHJ`（车价合计）是**不含税价**
   - 与数电专票不同，二手车发票的车价合计不包含税额
   - 二手车销售适用简易计税方法，征收率0.5%

6. **买方/卖方可能是个人**
   - 买方或卖方的代码字段可能是税号（企业）或身份证号（个人）
   - 需要根据格式和长度判断代码类型
   - 个人信息字段标题统一为"单位/个人"

7. **反向开票机制**
   - 有 `special_element_type_code`（特定要素类型代码）字段
   - 51=正常开票，52=反向开票
   - 正常情况下由经营单位或二手车市场开具
   - 特殊情况下可能由买方向卖方反向开票

8. **无货物明细结构**
   - 数电纸质二手车发票是单笔交易，无明细列表
   - 车辆信息直接在发票主信息中
   - 长软API无 `CHILDLIST` 节点
   - 本公司API无 `items[]` 数组

9. **车辆信息完整**
   - 包含车牌照号、登记证号、车架号、厂牌型号等
   - 转入地车管所名称用于车辆过户
   - 车辆识别代号（VIN码）是车辆唯一标识

10. **银行账号信息简化**
    - 数电票不强制要求买卖双方的开户行账号信息
    - buyer_bank_name、buyer_account_number 等字段返回null
    - seller_bank_name、seller_account_number 等字段返回null
    - 但拍卖单位、经营单位、二手车市场可能有银行账号信息（从JYYHZH、SCYHZH解析）

11. **数电特有字段**
    - `SDSJBZ`（数电发票实际备注）：可空，可能与BZ不同

### 6.2 与其他类型的区别

| 特性 | 数电纸质二手车(88) | 数电二手车(84) | 传统二手车(15) | 数电专票(81) |
|------|------------------|--------------|--------------|-------------|
| 发票代码 | ✅ 12位 | ❌ 无 | ✅ 12位 | ❌ 无 |
| 发票号码 | ✅ 8位或20位 | ✅ 20位 | ✅ 8位 | ✅ 20位 |
| 发票介质 | 纸质+电子 | 全电子 | 纸质 | 全电子 |
| 涉及主体 | 四方或五方 | 四方或五方 | 四方 | 两方 |
| 车价性质 | 不含税价 | 不含税价 | 不含税价 | - |
| 是否显示税额 | ✅ 有 | ✅ 有 | ❌ 无 | ✅ 有 |
| 抵扣进项税 | ❌ 不可抵扣 | ❌ 不可抵扣 | ❌ 不可抵扣 | ✅ 可抵扣 |
| 明细结构 | ❌ 无明细 | ❌ 无明细 | ❌ 无明细 | ✅ 有货物明细 |
| 买方信息 | 可能是个人（身份证） | 可能是个人（身份证） | 可能是个人 | 必须是企业 |
| 反向开票标志 | ✅ 有（51/52） | ✅ 有（51/52） | ✅ 有（FXKPBZ） | ❌ 无 |
| 特殊字段 | 拍卖单位、经营单位、二手车市场 | 拍卖单位、经营单位、二手车市场 | 经营单位、二手车市场 | 购销方完整信息 |
| 长软类型码 | 09 (QDLX=15) | 09 (QDLX=15) | 15 | 09 (QDLX=20) |
| 税控设备 | ❌ 无 | ❌ 无 | ✅ 有 | ❌ 无 |

### 6.3 特殊处理逻辑

#### 6.3.1 发票类型识别

由于长软对所有数电票统一返回类型码09，必须通过QDLX区分，并且需要区分纸质（88）和电子（84）：

**处理流程**:
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 如果 QDLX=15，进一步判断：
   - 检查 `BODY/FPDM`（发票代码）是否存在
   - 检查 `BODY/FPHM`（发票号码）的长度
   - 如果有发票代码或号码是8位 → 类型88（纸质）
   - 如果无发票代码且号码是20位 → 类型84（电子）
4. 其他QDLX值，路由到对应的映射表

#### 6.3.2 双重号码处理

**挑战**: 数电纸质二手车发票可能同时具有纸质号码（8位）和数电号码（20位）。

**解决方案**:
1. **识别号码类型**：
   - 从 `BODY/FPHM` 获取发票号码
   - 判断长度：8位=纸质号码，20位=数电号码

2. **字段映射策略**：
   - 如果是8位纸质号码：
     - `invoice_number` = FPHM（8位）
     - `paper_invoice_no` = FPHM（8位）
     - `invoice_code` = FPDM（12位）
   - 如果是20位数电号码：
     - `invoice_number` = FPHM（20位）
     - `paper_invoice_no` = 从业务系统获取（或null）
     - `invoice_code` = FPDM（12位，可能为空）

3. **查验请求处理**：
   - 用户可能使用纸质号码查验
   - 也可能使用数电号码查验
   - 需要支持两种查验方式

#### 6.3.3 拍卖/经营单位字段复用处理

**挑战**: 本公司API将拍卖单位（auction_company_*）和经营单位（business_company_*）分开，但长软API使用同一组字段（JYDW/JYSBH/JYDZ/JYDH/JYYHZH）。

**解决方案**:
1. **识别实际单位类型**：
   - 根据业务规则或单位名称判断是拍卖单位还是经营单位
   - 如果无法判断，优先填充到经营单位字段

2. **字段映射策略**：
   - 如果是拍卖单位：填充 auction_company_* 字段，business_company_* 返回null
   - 如果是经营单位：填充 business_company_* 字段，auction_company_* 返回null
   - 如果无法判断：同时填充两组字段（冗余）

3. **银行账号解析**：
   - 从 `JYYHZH` 解析银行名称和账号
   - 格式通常为 "银行名称 账号"
   - 按空格或其他分隔符分割

#### 6.3.4 四方主体信息提取

数电纸质二手车发票涉及四方或五方，需要分别提取各方信息：

**处理流程**：
1. **识别买方信息** - 从 `GFDW`、`GFHM`、`GFDZ`、`GFDH` 提取
2. **识别卖方信息** - 从 `XFDW`、`XFHM`、`XFDZ`、`XFDH` 提取
3. **识别拍卖/经营单位信息** - 从 `JYDW`、`JYSBH`、`JYDZ`、`JYDH`、`JYYHZH` 提取
4. **识别二手车市场信息** - 从 `SCMC`、`SCSBH`、`SCDZ`、`SCDH`、`SCYHZH` 提取
5. **判断实际开票方** - 通常是经营单位、拍卖单位或二手车市场

#### 6.3.5 买方/卖方代码类型识别

**挑战**：买方和卖方的代码字段可能是税号（企业）或身份证号（个人）。

**解决方案**：
1. 检查代码字段长度和格式
2. 18位且末位可能是X → 身份证号
3. 15位或18位纯数字 → 税号
4. 根据识别结果设置对应的数据类型标识

#### 6.3.6 车价合计与价税合计处理

**重要**: 数电纸质二手车发票有两个金额字段：

1. **车价合计** (`vehicle_price_total`):
   - 映射自 `BODY/CJHJ`
   - **不含税价**
   - 这是二手车交易的实际价格

2. **价税合计** (`amount_including_tax`):
   - 映射自 `BODY/JSHJ`
   - 含税价
   - 用于发票金额汇总

**处理注意事项**：
- 车价合计是不含税价，用于车辆交易
- 价税合计 = 车价合计 + 税额
- 税额 = 车价合计 × 征收率（0.5%）

#### 6.3.7 反向开票处理

当 `special_element_type_code = 52` 或 `FXKPBZ = 1` 时，需要特殊处理：

**处理逻辑**：
1. 识别反向开票标志
2. 记录反向开票信息
3. 开票方信息可能在买方或卖方字段中
4. 需要根据业务规则确定实际的开票主体

#### 6.3.8 红字发票处理

数电票的红字处理逻辑：

**处理流程**:
1. 检查 `ZFBZ` 是否为 3/7/8（红字发票）
2. 设置 `is_blue_invoice = 'N'`
3. 从业务系统获取原蓝字发票信息：
   - `original_blue_invoice_no`（原蓝字发票号）
   - `original_blue_paper_invoice_code`（原纸质发票代码）
   - `original_blue_paper_invoice_no`（原纸质发票号码）
4. 建立红蓝字发票关联关系

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（核心字段）:
- `FPHM` (发票号码)
- `KPRQ` (开票日期)
- `GFDW` (买方单位/个人)
- `XFDW` (卖方单位/个人)
- `CJHJ` (车价合计)

**本公司API要求必填**:
- `is_blue_invoice` (蓝字/红字标识)
- `seller_name` (销售方名称)
- `buyer_name` (购买方名称)
- `amount_including_tax` (价税合计)
- `tax_amount` (合计税额)
- `amount_in_words` (价税合计大写)
- `license_plate_no` (车牌照号)
- `registration_no` (登记证号)
- `vehicle_identification_no` (车辆识别代号)
- `product_model` (厂牌型号)
- `transfer_vehicle_management_name` (转入地车辆管理所名称)
- `vehicle_price_total_in_words` (车价合计大写)
- `vehicle_price_total` (车价合计小写)
- `invoice_status` (发票状态)

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 20 | ✅ 长度一致，可支持8位或20位号码 |
| invoice_code | 12 | 20 | ✅ 本公司12位，纸质代码12位足够 |
| seller_tax_no | 20 | 64 | ⚠️ 长软更大，需考虑身份证18位，本公司20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，需考虑身份证18位，本公司20位足够 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |
| product_model | 150 | 96 | ✅ 本公司更大，无风险 |
| vehicle_type_code | 600 | 32 | ✅ 本公司更大，无风险 |
| vehicle_identification_no | 30 | 64 | ⚠️ 长软更大，但VIN码17位，30位足够 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数
- `CYSJ` (查验时间) - 长软查验时间戳
- `SKPH` (机器编号) - 数电票为空
- `SDSJBZ` (数电发票实际备注) - 数电票特有备注

**本公司独有字段**（需从其他数据源获取）:
- `paper_invoice_no` (纸质发票号码) - 从FPHM识别或业务系统获取
- `invoice_category_code` (发票票种代码) - 从业务规则获取
- `is_blue_invoice` (蓝字/红字标识) - 从ZFBZ推断
- `original_blue_invoice_no` (原蓝字发票号) - 从业务系统获取
- `original_blue_paper_invoice_code` (原纸质发票代码) - 从业务系统获取
- `original_blue_paper_invoice_no` (原纸质发票号) - 从业务系统获取
- `seller_bank_name` (销售方开户行) - 数电票简化信息
- `seller_account_number` (销售方账号) - 数电票简化信息
- `buyer_bank_name` (购买方开户行) - 数电票简化信息
- `buyer_account_number` (购买方账号) - 数电票简化信息
- `vehicle_price_total_in_words` (车价合计大写) - 从vehicle_price_total计算
- `amount_in_words` (价税合计大写) - 从amount_including_tax计算
- `issuer` (开票人) - 数电票无此字段
- `tax_classification_code` (商品税收分类编码) - 从业务规则获取

### 7.4 数电纸质二手车发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 发票类型路由

**挑战**：长软对所有数电票统一返回类型码09，需要根据QDLX路由到正确的处理器，并且需要区分纸质和电子形态。

**解决方案**：
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 如果 QDLX=15，进一步判断介质类型：
   - 检查 `BODY/FPDM`（发票代码）是否存在
   - 检查 `BODY/FPHM`（发票号码）的长度
   - 如果有发票代码或号码是8位 → 使用本映射表（88-纸质二手车）
   - 如果无发票代码且号码是20位 → 路由到84映射表（电子二手车）
4. 其他QDLX值，路由到对应的映射表：
   - QDLX=20 → 路由到数电专票映射表
   - QDLX=10 → 路由到数电普票映射表
   - QDLX=03 → 路由到数电机动车映射表
   - QDLX=01 → 路由到数电纸质专票映射表
   - QDLX=04 → 路由到数电纸质普票映射表
   - 其他值 → 返回不支持的数电类型错误

#### 7.4.2 双重号码体系处理

**挑战**：数电纸质二手车发票同时具有纸质号码和数电号码，需要正确识别和存储。

**解决方案**：
1. **号码识别逻辑**：
   ```
   从 BODY/FPHM 获取发票号码
   IF 长度 = 8位 THEN
       invoice_number = FPHM (8位纸质号)
       paper_invoice_no = FPHM (8位纸质号)
       invoice_code = FPDM (12位代码)
   ELSE IF 长度 = 20位 THEN
       invoice_number = FPHM (20位数电号)
       paper_invoice_no = 从业务系统获取或null
       invoice_code = FPDM (12位代码，可能为空)
   END IF
   ```

2. **查验请求支持**：
   - 支持使用纸质号码（8位）+ 发票代码（12位）查验
   - 支持使用数电号码（20位）查验
   - 两种方式都应该能正确返回发票信息

3. **响应字段完整性**：
   - 始终尽可能返回 invoice_number、invoice_code、paper_invoice_no 三个字段
   - 即使只有部分信息，也要正确填充已知字段

#### 7.4.3 拍卖/经营单位字段复用处理

**挑战**：本公司API将拍卖单位和经营单位分开，但长软API使用同一组字段。

**解决方案**：
1. **识别实际单位类型**：
   - 根据单位名称关键字（如"拍卖"）判断
   - 如果无法判断，优先填充到经营单位字段

2. **字段映射策略**（三选一）：
   - **方案A（推荐）**：根据名称识别，分别填充
   - **方案B**：同时填充两组字段（冗余）
   - **方案C**：仅填充经营单位字段，拍卖单位返回null

3. **银行账号解析**：
   - 从 `JYYHZH` 按空格分割银行名称和账号
   - 从 `SCYHZH` 按空格分割银行名称和账号

#### 7.4.4 四方主体信息完整性验证

**挑战**：数电纸质二手车发票涉及买方、卖方、拍卖/经营单位、二手车市场四方或五方，信息复杂。

**解决方案**：
1. **验证必填方信息**：
   - 买方名称（GFDW）必填
   - 卖方名称（XFDW）必填
   - 拍卖/经营单位或二手车市场至少一方必填

2. **识别实际开票方**：
   - 通常是拍卖/经营单位（JYDW）或二手车市场（SCMC）
   - 开票方的税号应与企业纳税人识别号一致

3. **处理个人信息**：
   - 买方或卖方可能是个人
   - 代码字段使用身份证号而非税号
   - 需要识别并正确处理身份证号格式

#### 7.4.5 车价合计验证（不含税价）

**挑战**：确保车价合计字段正确处理为不含税价，并验证与价税合计的关系。

**解决方案**：
1. 直接映射 `CJHJ` → `vehicle_price_total`（不含税价）
2. 直接映射 `JSHJ` → `amount_including_tax`（价税合计）
3. 验证关系：`amount_including_tax ≈ vehicle_price_total + tax_amount`
4. 车价合计通常较大（数万至数百万），需验证数值合理性

**验证规则**：
车价合计应在合理范围（1000元 ~ 10,000,000元）

#### 7.4.6 买方/卖方代码类型识别

**挑战**：买方和卖方的代码可能是税号（企业）或身份证号（个人）。

**解决方案**：
1. 实现代码类型识别逻辑
2. 18位且末位可能是X → 身份证号
3. 15位或18位纯数字 → 税号
4. 如果是身份证号，需注意隐私保护（脱敏处理）

#### 7.4.7 反向开票标志处理

**挑战**：本公司API使用 `special_element_type_code` (51/52)，长软API使用 `FXKPBZ` (0/1)。

**解决方案**：
1. 映射关系：
   - FXKPBZ=0 → special_element_type_code=51（正常开具）
   - FXKPBZ=1 → special_element_type_code=52（反向开具）

2. 当反向开票时（52/1），需要识别实际开票方可能与常规情况不同

#### 7.4.8 车辆信息完整性

**关键车辆字段**：
- `license_plate_no` (车牌照号) - 唯一标识，可能为空（新车未上牌）
- `registration_no` (登记证号) - 重要证件号
- `vehicle_identification_no` (车架号/VIN码) - **最重要**，全球唯一
- `product_model` (厂牌型号) - 车辆基本信息
- `transfer_vehicle_management_name` (转入地车管所) - 过户信息

**验证建议**：
1. 车架号（VIN码）必须17位
2. 车牌照号格式：省份简称+字母+5位数字/字母
3. 如果车牌照号为空，可能是新车，需特别标注

#### 7.4.9 红字发票链条追踪

**挑战**：数电纸质票红字发票需要追踪原蓝字发票，包括纸质和电子信息。

**解决方案**：
1. **识别红字发票**：
   - 检查 `ZFBZ` 是否为 3/7/8
   - 设置 `is_blue_invoice = 'N'`

2. **记录原票信息**（需要业务系统支持）：
   - `original_blue_invoice_no`: 原蓝字发票号码（可能是8位或20位）
   - `original_blue_paper_invoice_code`: 原纸质发票代码（12位）
   - `original_blue_paper_invoice_no`: 原纸质发票号码（8位）
   - 建立红蓝字发票关联关系

3. **红字列表处理**：
   - 长软09类型暂不返回红字列表（HZLIST）
   - 需要从业务系统维护红蓝字关系

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697061)
2. 长软API文档: `【长软】发票查验服务调用说明V4.1.2.pdf` (3.2.3.9节)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 参考映射表: `本公司15_二手车销售统一发票→长软15.md`（传统二手车发票）
6. 参考映射表: `本公司84_数电二手车→长软09(QDLX=15).md`（数电二手车电子发票）
7. 参考映射表: `本公司86_数电纸质发票(普通发票)→长软09(QDLX=04).md`（数电纸质普票）
8. 国家税务总局全电发票平台: https://etax.chinatax.gov.cn/

---

**文档结束**
