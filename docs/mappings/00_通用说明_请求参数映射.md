# 发票查验API - 通用请求参数映射说明

**文档版本**: v1.1
**创建日期**: 2025-12-30
**更新日期**: 2025-12-31
**适用范围**: 所有发票类型

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间的**通用请求参数映射关系**。

这些参数映射适用于所有发票类型（01、03、04、08、10、11、14、15、81-88、51、61等），各发票类型的映射表文档应引用本文档，无需重复定义。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)

---

## 一、接口基本信息对比

### 1.1 本公司API

| 项目 | 值 |
|------|-----|
| **接口路径** | `/partners/invoice-verifications` |
| **HTTP方法** | `POST` |
| **协议** | HTTPS RESTful |
| **数据格式** | JSON |
| **字符编码** | UTF-8 |
| **认证方式** | Bearer Token (Authorization Header) |

### 1.2 长软API

| 项目 | 值 |
|------|-----|
| **接口地址** | `https://xxx.xxx.xxx.xxx:443/fpcyService/fpcyService.do` |
| **HTTP方法** | `POST` |
| **协议** | HTTP POST |
| **数据格式** | XML |
| **字符编码** | UTF-8 |
| **认证方式** | 用户名+签名（MD5） |

---

## 二、HTTP请求头参数映射

### 2.1 本公司API请求头

本公司API使用标准的HTTP请求头进行认证和链路追踪：

| 请求头名称 | 类型 | 必填 | 说明 | 示例值 |
|-----------|------|------|------|--------|
| **Authorization** | string | ✅ 是 | Bearer token，用于API身份验证 | `Bearer eyJhbGciOiJIUzI1Ni...` |
| **X-Request-Id** | string | ✅ 是 | 全局唯一请求ID，用于链路追踪与日志关联 | `req_1735548170_48210952` |
| **X-Customer-Id** | string | ✅ 是 | 客户编号，10位数字 | `1234567890` |
| **Accept-Language** | string | ❌ 否 | 响应语言，IETF BCP 47格式 | `zh-CN` 或 `en-US` |

### 2.2 长软API认证参数

长软API不使用HTTP请求头进行认证，认证信息包含在XML报文中：

| XML字段 | 类型 | 必填 | 说明 |
|---------|------|------|------|
| **USERNAME** | VARCHAR(10) | ✅ 是 | 发票查验服务平台分配的用户名 |
| **SENDTIME** | VARCHAR(14) | ✅ 是 | 数据发送时间，格式YYYYMMDDHHMMSS |
| **SIGN** | VARCHAR(400) | ✅ 是 | 签名，对 `USERNAME+FPDM+FPHM+SENDTIME+PASSWORD` 进行MD5加密 |

### 2.3 认证参数映射逻辑

```
本公司API认证流程:
1. 客户端在 Authorization 请求头中提供 Bearer Token
2. 服务端验证Token有效性
3. 从Token中提取客户信息（客户ID、权限等）
4. 使用提取的客户信息调用长软API

映射到长软API:
1. 根据客户ID查询对应的长软账户配置（USERNAME、PASSWORD）
2. 生成SENDTIME（当前时间，格式YYYYMMDDHHMMSS）
3. 计算SIGN = MD5(USERNAME + FPDM + FPHM + SENDTIME + PASSWORD)
4. 将USERNAME、SENDTIME、SIGN写入XML报文
```

⚠️ **重要提示**：
- 长软账户凭证（USERNAME、PASSWORD）由系统管理员配置，存储在后端数据库或配置中心
- **禁止**将长软PASSWORD暴露到API响应或日志中
- 每个客户可能对应不同的长软账户，需建立客户ID与长软账户的映射关系

---

## 三、请求体参数映射

### 3.1 通用参数对照表

| 本公司API字段 | 本公司类型 | 本公司必填 | 长软API字段 | 长软类型 | 长软必填 | 映射说明 |
|--------------|-----------|-----------|------------|---------|---------|----------|
| `invoice_type` | string(2) | ✅ 是* | `FPLX` | VARCHAR(2) | ❌ 否 | 直接映射，见发票类型枚举映射 |
| `invoice_code` | string(12) | ⚠️ 条件 | `FPDM` | VARCHAR(12) | ❌ 否 | 直接映射，10位或12位发票代码 |
| `invoice_number` | string(20) | ✅ 是 | `FPHM` | VARCHAR(8) | ✅ 是 | 直接映射，8位或20位数字（数电发票20位） |
| `issue_date` | string | ✅ 是 | `KPRQ` | VARCHAR(8) | ✅ 是 | **格式转换**：`YYYY-MM-DD` → `YYYYMMDD` |
| `verification_code` | string(32) | ⚠️ 条件 | `JYM` | VARCHAR(6) | ❌ 否 | **截取后6位**：`verification_code.substring(verification_code.length - 6)` |
| `invoice_amount` | number(18,2) | ⚠️ 条件 | `FPJE` | VARCHAR(20) | ❌ 否 | **类型转换**：`number.toString()` |
| `company_tax_no` | string(20) | ⚠️ 条件 | - | - | - | **本公司独有**，用于乐企通道查验 |
| - | - | - | `VERSION` | VARCHAR(10) | ✅ 是 | **长软独有**，固定值 `4.0.12` 或更高版本 |
| - | - | - | `REQTYPE` | VARCHAR(10) | ❌ 否 | **长软独有**🆕，本公司固定为 `V2`，用于获取医疗发票专用格式 |

**标注说明**：
- ✅ **是**：所有场景都必填
- ❌ **否**：所有场景都可选
- ⚠️ **条件**：根据发票类型或查验平台有不同的必填要求

### 3.2 发票类型枚举映射 (invoice_type ↔ FPLX)

| 本公司API (invoice_type) | 长软API (FPLX) | 发票类型名称 | 特殊说明 |
|------------------------|---------------|------------|----------|
| **01** | **01** | 增值税专用发票 | |
| **02** | **01** | 货物运输业增值税专用发票 | 本公司02映射到长软01 |
| **03** | **03** | 机动车销售统一发票 | |
| **04** | **04** | 增值税普通发票 | |
| **08** | **20** | 增值税电子专用发票 | |
| **10** | **10** | 增值税电子普通发票 | |
| **11** | **11** | 增值税普通发票（卷式） | |
| **14** | **14** | 增值税普通发票（通行费） | |
| **15** | **15** | 二手车销售统一发票 | |
| **51** | **83** | 电子发票（铁路电子客票） | |
| **61** | **61** | 电子发票（航空运输客票电子行程单） | |
| **81** | **09** | 电子发票（数电发票-增值税专用发票） | 需在HEAD中设置QDLX=20 |
| **82** | **09** | 电子发票（数电发票-普通发票） | 需在HEAD中设置QDLX=10 |
| **83** | **09** | 电子发票（数电发票-机动车） | 需在HEAD中设置QDLX=03 |
| **84** | **09** | 电子发票（数电发票-二手车） | 需在HEAD中设置QDLX=15 |
| **85** | **09** | 纸质发票（数电纸质发票-增值税专用发票） | 需在HEAD中设置QDLX=01 |
| **86** | **09** | 纸质发票（数电纸质发票-普通发票） | 需在HEAD中设置QDLX=04 |
| **87** | **09** | 纸质发票（数电纸质发票-机动车） | 需在HEAD中设置QDLX=03 |
| **88** | **09** | 纸质发票（数电纸质发票-二手车） | 需在HEAD中设置QDLX=15 |
| **F1** | - | 财政票据（财政电子票据） | **不通过长软查验，走财政部平台** |

⚠️ **数电发票特殊处理**：
- 长软API对数电发票统一使用 `FPLX=09`
- 需要在XML响应的 `HEAD/QDLX` 字段中区分子类型（10/20/01/04/03/15）
- 本公司API在请求时需要精确指定类型（81-88），在响应时同样返回精确类型

---

## 四、参数格式转换规则

### 4.1 日期格式转换

| API | 格式 | 示例 | 正则表达式 |
|-----|------|------|-----------|
| 本公司API | `YYYY-MM-DD` | `2025-12-30` | `^\d{4}-\d{2}-\d{2}$` |
| 长软API | `YYYYMMDD` | `20251230` | `^\d{8}$` |

**转换逻辑**：

```javascript
// 本公司 → 长软
function toChangruanDateFormat(issueDate) {
  // 输入: "2025-12-30"
  // 输出: "20251230"
  return issueDate.replace(/-/g, '');
}

// 长软 → 本公司
function fromChangruanDateFormat(kprq) {
  // 输入: "20251230"
  // 输出: "2025-12-30"
  return `${kprq.substring(0, 4)}-${kprq.substring(4, 6)}-${kprq.substring(6, 8)}`;
}
```

### 4.2 金额格式转换

| API | 类型 | 精度 | 示例 |
|-----|------|------|------|
| 本公司API | `number` | (18,2) | `10000.00` |
| 长软API | `VARCHAR` | 字符串 | `"10000.00"` |

**转换逻辑**：

```javascript
// 本公司 → 长软
function toChangruanAmountFormat(amount) {
  // 输入: 10000.00 (number)
  // 输出: "10000.00" (string)
  return amount.toFixed(2);
}

// 长软 → 本公司
function fromChangruanAmountFormat(fpje) {
  // 输入: "10000.00" (string)
  // 输出: 10000.00 (number)
  return parseFloat(fpje);
}
```

### 4.3 校验码格式转换

| 场景 | 本公司API | 长软API | 转换说明 |
|------|-----------|---------|----------|
| 完整校验码 | `"12345678901234567890"` (32位) | `"567890"` (后6位) | **截取后6位** |
| 数电纸质普票 | `"20位数电发票号码"` | `"号码后6位"` | **特殊处理** |

**转换逻辑**：

```javascript
// 本公司 → 长软
function toChangruanVerificationCode(verificationCode, invoiceType) {
  if (!verificationCode) return '';

  // 数电纸质普票(86)：使用数电发票号码后6位
  if (invoiceType === '86') {
    // 从invoice_number字段获取20位数电号码
    return invoice_number.substring(invoice_number.length - 6);
  }

  // 其他类型：使用校验码后6位
  return verificationCode.substring(verificationCode.length - 6);
}
```

---

## 五、REQTYPE参数说明 🆕

### 5.1 参数概述

`REQTYPE` 是长软API V4.1.2新增的请求参数，用于控制**医疗发票**的返回格式。

| 项目 | 说明 |
|------|------|
| 字段名 | `REQTYPE` |
| 类型 | VARCHAR(10) |
| 必填性 | 可选 |
| 默认值 | `V1`（不填时默认） |
| 本公司固定值 | **`V2`** |
| 影响范围 | 仅影响医疗住院和医疗门诊发票的返回格式 |

### 5.2 参数取值

| 取值 | 含义 | 返回格式 | 是否推荐 |
|------|------|----------|---------|
| `V1` 或 不填 | 默认模式 | 医疗发票按标准数电普票格式返回（`QDLX=10`），特定业务要素在备注字段中 | ❌ 不推荐 |
| `V2` | 专用格式模式 | 医疗发票按专用格式返回（`QDLX=90`或`91`），包含结构化的医疗明细 | ✅ **本公司使用** |

### 5.3 V1 vs V2 对比

#### 医疗住院发票

| 对比项 | V1模式 | V2模式 |
|--------|--------|--------|
| QDLX值 | 10（标准数电普票） | 90（医疗住院专用） |
| 返回章节 | 3.2.3.10 | 3.2.3.20 |
| 特定要素 | 拼接在备注字段中 | 独立的医疗住院明细列表 |
| 结构化程度 | 低（需要解析备注） | 高（结构化字段） |

#### 医疗门诊发票

| 对比项 | V1模式 | V2模式 |
|--------|--------|--------|
| QDLX值 | 10（标准数电普票） | 91（医疗门诊专用） |
| 返回章节 | 3.2.3.10 | 3.2.3.21 |
| 特定要素 | 拼接在备注字段中 | 独立的医疗门诊明细列表 |
| 结构化程度 | 低（需要解析备注） | 高（结构化字段） |

### 5.4 本公司实施策略

⚠️ **重要决策**：本公司**强制使用 `REQTYPE=V2`**

**理由**：
1. ✅ **数据结构化**：V2模式返回结构化的医疗明细，便于数据处理和展示
2. ✅ **业务要素完整**：可获取完整的医疗特定业务要素（如费用分类、医保信息等）
3. ✅ **避免解析复杂度**：无需从备注字段中解析特定要素
4. ✅ **面向未来**：长软推荐使用V2模式，V1仅为向后兼容

**实施要求**：
- 所有调用长软API的请求中，**固定添加** `REQTYPE=V2` 参数
- 医疗发票查验结果按 `QDLX=90` 或 `QDLX=91` 格式处理
- 非医疗发票不受影响，REQTYPE参数对其无效果

### 5.5 请求示例

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MSG>
  <VERSION>4.1.2</VERSION>
  <FPLX>09</FPLX>
  <FPDM></FPDM>
  <FPHM>12345678901234567890</FPHM>
  <KPRQ>20251231</KPRQ>
  <FPJE>1580.00</FPJE>
  <JYM></JYM>
  <USERNAME>testuser01</USERNAME>
  <SENDTIME>20251231120000</SENDTIME>
  <SIGN>abc123def456...</SIGN>
  <REQTYPE>V2</REQTYPE>  <!-- 本公司固定为V2 -->
</MSG>
```

### 5.6 版本兼容性

| 长软API版本 | REQTYPE支持 | 本公司处理 |
|------------|-------------|-----------|
| V4.0.16及以下 | ❌ 不支持 | 不发送REQTYPE参数 |
| V4.1.2及以上 | ✅ 支持 | **固定发送REQTYPE=V2** |

---

## 六、不同发票类型的必填参数差异

### 6.1 税务总局查验平台（长软通道）

#### 6.1.1 传统发票类型

| 发票类型 | invoice_type | 必填字段 | 金额字段含义 |
|---------|-------------|---------|------------|
| 增值税专用发票 | 01 | invoice_code, invoice_number, issue_date, invoice_amount | **不含税金额** |
| 货运专票 | 02 | invoice_code, invoice_number, issue_date, invoice_amount | **不含税金额** |
| 机动车发票 | 03 | invoice_code, invoice_number, issue_date, invoice_amount | **不含税金额** |
| 增值税普通发票 | 04 | invoice_code, invoice_number, issue_date, verification_code | 校验码后6位 |
| 电子专票 | 08 | invoice_code, invoice_number, issue_date, invoice_amount | **不含税金额** |
| 电子普票 | 10 | invoice_code, invoice_number, issue_date, verification_code | 校验码后6位 |
| 卷式发票 | 11 | invoice_code, invoice_number, issue_date, verification_code | 校验码后6位 |
| 通行费发票 | 14 | invoice_code, invoice_number, issue_date, verification_code | 校验码后6位 |
| 二手车发票 | 15 | invoice_code, invoice_number, issue_date, invoice_amount | **车价合计** |

#### 6.1.2 数电发票类型

| 发票类型 | invoice_type | 必填字段 | 金额字段含义 | 特殊说明 |
|---------|-------------|---------|------------|----------|
| 数电专票 | 81 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |
| 数电普票 | 82 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |
| 数电机动车 | 83 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |
| 数电二手车 | 84 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |
| 数电铁路客票 | 51 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |
| 数电航空客票 | 61 | invoice_number(20位), issue_date, invoice_amount | **价税合计** | 无invoice_code |

#### 6.1.3 数电纸质发票类型（双重查验）

| 发票类型 | invoice_type | 查验方式 | 必填字段组合 |
|---------|-------------|---------|-------------|
| 数电纸质专票 | 85 | **方式一** | invoice_code, invoice_number(8位), issue_date, invoice_amount(不含税) |
| | | **方式二** | invoice_number(20位), issue_date, invoice_amount(价税合计) |
| 数电纸质普票 | 86 | **方式一** | invoice_code, invoice_number(8位), issue_date, verification_code |
| | | **方式二** | invoice_number(20位), issue_date, invoice_amount(价税合计) |
| 数电纸质机动车 | 87 | **仅一种** | invoice_code, invoice_number(8位), issue_date, invoice_amount(不含税) |
| 数电纸质二手车 | 88 | **仅一种** | invoice_code, invoice_number(8位), issue_date, invoice_amount(车价合计) |

⚠️ **数电纸质发票特殊处理**：
- 数电纸质发票同时印制有**纸质发票号码**（8位）和**数电发票号码**（20位）
- 类型85、86支持两种查验方式，系统应优先使用方式一（纸质号码）
- 类型87、88仅支持纸质号码查验

### 6.2 乐企查验接口

乐企通道的必填字段与税务总局基本一致，但**额外要求**：

| 额外必填字段 | 说明 |
|-------------|------|
| `company_tax_no` | 查验企业的纳税人识别号或统一社会信用代码 |

⚠️ **重要限制**：
- 乐企通道**不支持**财政票据（F1）查验
- 乐企通道所有发票类型都**必须提供** `company_tax_no`

### 6.3 财政部查验平台

| 发票类型 | invoice_type | 必填字段 |
|---------|-------------|---------|
| 财政电子票据 | F1 | invoice_code, invoice_number, issue_date, invoice_amount, verification_code |

⚠️ **注意**：财政票据**不通过长软查验**，需要对接财政部查验平台。

---

## 七、必填参数验证规则

### 7.1 发票代码验证

```javascript
// 发票代码验证规则
function validateInvoiceCode(invoiceCode, invoiceType) {
  // 数电发票（81、82、83、84、51、61）无发票代码
  const digitalTypes = ['81', '82', '83', '84', '51', '61'];
  if (digitalTypes.includes(invoiceType)) {
    return invoiceCode === null || invoiceCode === '';
  }

  // 其他类型必须是10位或12位数字
  return /^\d{10}$|^\d{12}$/.test(invoiceCode);
}
```

### 7.2 发票号码验证

```javascript
// 发票号码验证规则
function validateInvoiceNumber(invoiceNumber, invoiceType) {
  // 数电发票：20位数字
  const digitalTypes = ['81', '82', '83', '84', '85', '86', '87', '88', '51', '61'];
  if (digitalTypes.includes(invoiceType)) {
    return /^\d{20}$/.test(invoiceNumber);
  }

  // 传统发票：8位数字
  return /^\d{8}$/.test(invoiceNumber);
}
```

### 7.3 金额字段验证

```javascript
// 金额字段必填性验证
function validateInvoiceAmount(invoiceAmount, invoiceType) {
  const requireAmountTypes = [
    '01', '02', '03', '08', '15',  // 传统专票、机动车、二手车
    '20',                          // 电子专票（长软类型）
    '81', '82', '83', '84',       // 数电发票
    '85', '86', '87', '88',       // 数电纸质发票
    '51', '61'                     // 数电客票
  ];

  if (requireAmountTypes.includes(invoiceType)) {
    return invoiceAmount !== null && invoiceAmount > 0;
  }

  return true; // 其他类型金额可选
}
```

### 7.4 校验码验证

```javascript
// 校验码必填性验证
function validateVerificationCode(verificationCode, invoiceType) {
  const requireCodeTypes = ['04', '10', '11', '14', 'F1'];

  if (requireCodeTypes.includes(invoiceType)) {
    return verificationCode !== null && verificationCode.length >= 6;
  }

  return true; // 其他类型校验码可选
}
```

---

## 八、请求示例

### 8.1 本公司API请求示例

#### 示例1：增值税专用发票查验

```http
POST /partners/invoice-verifications HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-Request-Id: req_1735548170_12345678
X-Customer-Id: 1234567890
Content-Type: application/json
Accept-Language: zh-CN

{
  "invoice_type": "01",
  "invoice_code": "1100182130",
  "invoice_number": "63516373",
  "issue_date": "2025-12-30",
  "invoice_amount": 10000.00
}
```

#### 示例2：增值税电子普通发票查验

```http
POST /partners/invoice-verifications HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-Request-Id: req_1735548170_87654321
X-Customer-Id: 1234567890
Content-Type: application/json

{
  "invoice_type": "10",
  "invoice_code": "044001600111",
  "invoice_number": "20078888",
  "issue_date": "2025-12-30",
  "verification_code": "12345617888"
}
```

#### 示例3：数电发票（专票）查验

```http
POST /partners/invoice-verifications HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-Request-Id: req_1735548170_11111111
X-Customer-Id: 1234567890
Content-Type: application/json

{
  "invoice_type": "81",
  "invoice_number": "12345678901234567890",
  "issue_date": "2025-12-30",
  "invoice_amount": 11800.00
}
```

### 8.2 长软API请求示例

#### 示例1：增值税专用发票查验

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MSG>
  <VERSION>4.0.12</VERSION>
  <FPLX>01</FPLX>
  <FPDM>1100182130</FPDM>
  <FPHM>63516373</FPHM>
  <KPRQ>20251230</KPRQ>
  <FPJE>10000.00</FPJE>
  <JYM></JYM>
  <USERNAME>testuser01</USERNAME>
  <SENDTIME>20251230163000</SENDTIME>
  <SIGN>e10adc3949ba59abbe56e057f20f883e</SIGN>
</MSG>
```

#### 示例2：增值税电子普通发票查验

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MSG>
  <VERSION>4.0.12</VERSION>
  <FPLX>10</FPLX>
  <FPDM>044001600111</FPDM>
  <FPHM>20078888</FPHM>
  <KPRQ>20251230</KPRQ>
  <FPJE></FPJE>
  <JYM>617888</JYM>
  <USERNAME>testuser01</USERNAME>
  <SENDTIME>20251230163100</SENDTIME>
  <SIGN>a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</SIGN>
</MSG>
```

#### 示例3：数电发票（专票）查验

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MSG>
  <VERSION>4.0.12</VERSION>
  <FPLX>09</FPLX>
  <FPDM></FPDM>
  <FPHM>12345678901234567890</FPHM>
  <KPRQ>20251230</KPRQ>
  <FPJE>11800.00</FPJE>
  <JYM></JYM>
  <USERNAME>testuser01</USERNAME>
  <SENDTIME>20251230163200</SENDTIME>
  <SIGN>9876543210abcdefghijklmnopqrstuv</SIGN>
</MSG>
```

---

## 九、映射转换完整流程

### 9.1 请求参数映射流程

```
1. 接收本公司API请求
   ↓
2. 验证请求头 (Authorization, X-Request-Id, X-Customer-Id)
   ↓
3. 验证请求体参数（根据invoice_type验证必填字段）
   ↓
4. 根据X-Customer-Id查询长软账户配置 (USERNAME, PASSWORD)
   ↓
5. 构建长软API请求参数：
   - VERSION: 固定 "4.0.12"
   - FPLX: 映射 invoice_type → FPLX (注意特殊映射如02→01, 08→20)
   - FPDM: 直接映射 invoice_code
   - FPHM: 直接映射 invoice_number
   - KPRQ: 格式转换 issue_date (YYYY-MM-DD → YYYYMMDD)
   - FPJE: 类型转换 invoice_amount (number → string)
   - JYM: 截取 verification_code 后6位
   - USERNAME: 从配置获取
   - SENDTIME: 生成当前时间 (YYYYMMDDHHmmss)
   - SIGN: 计算 MD5(USERNAME + FPDM + FPHM + SENDTIME + PASSWORD)
   ↓
6. 构建XML报文
   ↓
7. 调用长软API
   ↓
8. 解析长软响应 (见响应字段映射文档)
   ↓
9. 构建本公司API响应
```

### 9.2 数电发票特殊处理

```
针对数电发票 (invoice_type: 81-88, 51, 61):
1. 识别数电发票类型
   ↓
2. 统一映射 FPLX = "09"
   ↓
3. 响应解析时，从 HEAD/QDLX 获取子类型：
   - QDLX=20 → invoice_type=81 (数电专票)
   - QDLX=10 → invoice_type=82 (数电普票)
   - QDLX=03 → invoice_type=83/87 (数电机动车)
   - QDLX=15 → invoice_type=84/88 (数电二手车)
   - QDLX=01 → invoice_type=85 (数电纸质专票)
   - QDLX=04 → invoice_type=86 (数电纸质普票)
   ↓
4. 区分数电电子(81-84)和数电纸质(85-88)：
   - 有invoice_code → 纸质
   - 无invoice_code → 电子
```

---

## 十、错误处理

### 10.1 参数验证错误

当请求参数不符合要求时，本公司API应返回 HTTP 400 错误：

```json
{
  "error": {
    "code": "invalid_request_parameter",
    "type": "validation_error",
    "message": "参数验证失败：发票代码格式不正确",
    "details": {
      "field": "invoice_code",
      "value": "ABC123",
      "expected": "10位或12位数字"
    }
  }
}
```

### 10.2 长软认证错误

当长软账户配置缺失或签名错误时：

```json
{
  "error": {
    "code": "verification_channel_config_error",
    "type": "system_error",
    "message": "查验通道配置错误，请联系系统管理员"
  }
}
```

对应长软错误代码：100、101、102、103、107

---

## 十一、版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|---------|------|
| v1.1 | 2025-12-31 | 🆕 升级至长软API V4.1.2；新增REQTYPE参数说明（第五章）；强调本公司固定使用REQTYPE=V2 | Claude |
| v1.0 | 2025-12-30 | 创建请求参数映射文档，定义本公司API与长软API请求参数映射关系 | Claude |

---

## 十二、参考文档

1. **长软API文档**: `【长软】发票查验服务调用说明V4.1.2.pdf`
2. **本公司API定义**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0)
3. **通用枚举映射**: [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)
4. **各发票类型映射表**: `docs/mappings/` 目录下各文档

---

**文档结束**
