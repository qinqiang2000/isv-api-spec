# 本公司51_铁路电子客票→长软83 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 51 - 电子发票（铁路电子客票）

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"电子发票（铁路电子客票）"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)
- **本公司发票类型代码**: 51
- **长软发票类型代码**: 83
- **长软文档章节**: 3.2.3.11

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `51` | `83` | 不同编码 |
| 发票类型名称 | 电子发票（铁路电子客票） | 铁路客票 | |
| 数据结构定义 | `#/definitions/231697059` | `3.2.3.11` | |
| 数电发票类型 | - | - | 铁路电子客票为特殊电子发票 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| - | - | - | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | **长软独有**，铁路电子客票无发票代码，此字段为空 |
| `railway_specific_elements.invoice_number` | 发票号码 | string(30) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | 直接映射，20位数字 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录该发票被查验次数 |
| `railway_specific_elements.issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `railway_specific_elements.business_type_name` | 业务类型名称 | string(300) | `BODY/YWLX` | 业务类型 | VARCHAR2(2) | **需映射**，长软为代码，本公司为名称，参见5.2节 |
| `railway_specific_elements.passenger_name` | 姓名 | string(150) | `BODY/XM` | 姓名 | VARCHAR2(100) | 直接映射，乘客姓名 |
| `railway_specific_elements.id_no` | 证件号码 | string(30) | `BODY/ZJH` | 证件号 | VARCHAR2(100) | 直接映射，乘客证件号 |
| `railway_specific_elements.fare` | 票价 | string | `BODY/PJ` | 票价 | VARCHAR2(32) | 直接映射，单张车票价格 |
| `amount_excluding_tax` | 合计金额(不含税) | number(18,2) | `BODY/JE` | 金额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_amount` | 合计税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `railway_specific_elements.tax_rate` | 税率 | string | `BODY/SLV` | 税率 | NUMBER(8,5) | 直接映射，铁路客票适用9%税率 |
| `railway_specific_elements.departure_station` | 出发站 | string(60) | `BODY/CFZ` | 出发站 | VARCHAR2(100) | 直接映射，出发站中文名 |
| `railway_specific_elements.arrival_station` | 到达站 | string(60) | `BODY/DDZ` | 到达站 | VARCHAR2(100) | 直接映射，到达站中文名 |
| `railway_specific_elements.train_no` | 乘车车次 | string(20) | `BODY/CC` | 车次 | VARCHAR2(100) | 直接映射，如G123、D456 |
| `railway_specific_elements.travel_date` | 日期 | string | `BODY/CCRQ` | 乘车日期 | VARCHAR2(20) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `railway_specific_elements.departure_time` | 出发时间 | string(5) | `BODY/CFSJ` | 出发时间 | VARCHAR2(32) | 格式转换：HH:mm ← HHmmss或HHMM |
| `railway_specific_elements.seat_class` | 席别 | string(20) | `BODY/XB` | 席别 | VARCHAR2(20) | 直接映射，如一等座、二等座、硬卧 |
| `railway_specific_elements.carriage` | 车厢 | string(20) | `BODY/CX` | 车厢 | VARCHAR2(20) | 直接映射，车厢号 |
| `railway_specific_elements.seat_no` | 席位 | string(60) | `BODY/XW` | 席位 | VARCHAR2(20) | 直接映射，座位号 |
| `railway_specific_elements.railway_eticket_type_name` | 铁路电子客票票种名称 | string(60) | `BODY/PZ` | 票种 | VARCHAR2(20) | 直接映射，如成人票、儿童票、学生票 |
| `railway_specific_elements.eticket_no` | 电子客票号 | string(30) | `BODY/DZKPH` | 电子客票号 | VARCHAR2(100) | 直接映射，唯一标识电子客票 |
| `railway_specific_elements.air_condition_flag` | 空调特征 | string(20) | `BODY/KTTZ` | 空调特征 | VARCHAR2(20) | 直接映射，有空调/无空调 |
| `buyer_name` | 购买方名称 | string(300) | `BODY/GMFMC` | 购买方名称 | VARCHAR2(100) | 直接映射，企业报销时为企业名称 |
| `buyer_tax_no` | 购买方纳税人识别号 | string(20) | `BODY/GFSH` | 购买方统一社会信用代码 | VARCHAR2(64) | 直接映射，企业报销时填写 |
| `invoice_status_flag` | 发票状态标志 | 枚举 | `BODY/FPZT` | 发票状态 | VARCHAR(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| `invoice_status` | 发票状态 | 枚举 | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |
| `railway_specific_elements.payment_amount` | 支付金额 | number(18,2) | - | - | - | **本公司独有**，实际支付金额（可能含优惠） |
| `railway_specific_elements.refunded_amount` | 已退金额 | number(18,2) | - | - | - | **本公司独有**，退票金额 |
| `railway_specific_elements.original_fare` | 原票票价 | number(18,2) | - | - | - | **本公司独有**，改签前原票价格 |
| `railway_specific_elements.original_departure_station` | 原票出发站 | string(60) | - | - | - | **本公司独有**，改签前出发站 |
| `railway_specific_elements.original_arrival_station` | 原票到达站 | string(60) | - | - | - | **本公司独有**，改签前到达站 |
| `railway_specific_elements.railway_discount_type` | 铁路客票优惠类型 | string(30) | - | - | - | **本公司独有**，优惠类型（学生优惠、残军优惠等） |
| `railway_specific_elements.original_invoice_no` | 原发票号码 | string(30) | - | - | - | **本公司独有**，退票或改签时的原发票号 |
| `railway_specific_elements.departure_station_pinyin` | 出发站拼音 | string(60) | - | - | - | **本公司独有**，出发站拼音简码 |
| `railway_specific_elements.arrival_station_pinyin` | 到达站拼音 | string(60) | - | - | - | **本公司独有**，到达站拼音简码 |
| `railway_specific_elements.tax` | 税额 | string | - | - | - | **本公司独有**，单张车票税额（通常已包含在SE合计中） |
| `seller_name` | 销售方名称 | string(300) | - | - | - | **本公司独有**，通常为"中国铁路客票" |
| `seller_tax_no` | 销售方识别号 | string(20) | - | - | - | **本公司独有**，中国铁路总公司统一社会信用代码 |
| `seller_address` | 销售方地址 | string(190) | - | - | - | **本公司独有**，铁路销售方地址 |
| `seller_phone` | 销售方联系电话 | string(60) | - | - | - | **本公司独有**，如12306客服电话 |
| `is_blue_invoice` | 是否蓝字发票标志 | boolean | - | - | - | **本公司独有**，true=蓝字，false=红字（退票） |
| `invoice_category_code` | 发票票种代码 | string(2) | - | - | - | **本公司独有**，票种分类代码 |
| `special_element_type_code` | 特定要素类型代码 | string(2) | - | - | - | **本公司独有**，特定要素分类 |
| `amount_including_tax` | 价税合计 | number(18,2) | - | - | - | **本公司独有**，JE + SE |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、时间格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **需映射**: 需要通过枚举值或编码映射表进行转换
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `payment_amount` | 业务系统 | 实际支付金额，考虑优惠后的金额 |
| `refunded_amount` | 业务系统 | 退票时的退款金额（可能扣除手续费） |
| `original_fare` | 业务系统 | 改签时原票的票价 |
| `original_departure_station` | 业务系统 | 改签时原票的出发站 |
| `original_arrival_station` | 业务系统 | 改签时原票的到达站 |
| `railway_discount_type` | 业务规则 | 根据票种和乘客类型确定优惠类型 |
| `original_invoice_no` | 业务系统 | 退票或改签时对应的原发票号码 |
| `departure_station_pinyin` | 计算得出 | 从车站中文名转换为拼音简码（如"北京"→"BJP"） |
| `arrival_station_pinyin` | 计算得出 | 从车站中文名转换为拼音简码 |
| `seller_name` | 固定值 | 通常为"中国铁路客票"或具体铁路局名称 |
| `seller_tax_no` | 配置值 | 中国铁路总公司或各铁路局的统一社会信用代码 |
| `is_blue_invoice` | 业务规则 | 根据业务类型判断：正常购票=true，退票=false |
| `amount_with_tax` | 计算得出 | total_amount + total_tax_amount |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: 无

⚠️ **注意**:
- ❌ 铁路电子客票**无货物明细结构**
- ✅ 所有票务信息都在 `railway_specific_elements` 中
- ℹ️ 铁路客票为单次行程服务，不像普通发票有多行货物明细

### 3.2 items字段说明

本公司API中的 `items[]` 数组在铁路电子客票中**可能存在但仅用于兼容性**，实际数据应优先从 `railway_specific_elements` 获取。

如果 items 存在，典型结构为：

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 说明 |
|---|---|---|---|
| `sequence_no` | 明细序号 | integer | 固定为1（仅一条记录） |
| `goods_or_service_name` | 货物或应税劳务、服务名称 | string(310) | 如"旅客运输服务" |
| `item_short_name` | 商品服务简称 | string(310) | 如"铁路旅客运输" |
| `name` | 项目名称 | string(310) | 同goods_or_service_name |
| `amount` | 金额 | number(18,2) | 不含税金额 |
| `tax_rate` | 税率 | number(8,5) | 0.09（9%） |
| `tax_amount` | 税额 | number(18,2) | 税额 |
| `deduction_amount` | 扣除额 | number(18,2) | 通常为0 |
| `tax_classification_code` | 商品和服务税收分类合并编码 | string | 税收分类编码 |

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 开票日期 | `YYYY-MM-DD` | `YYYYMMDD` | 格式转换：`2025-12-30` ↔ `20251230` |
| 乘车日期 | `YYYY-MM-DD` | `YYYYMMDD` | 格式转换：`2025-12-30` ↔ `20251230` |

**转换逻辑**：
```javascript
// 长软 → 本公司
function formatDate(yyyymmdd) {
  // "20251230" → "2025-12-30"
  return `${yyyymmdd.substring(0,4)}-${yyyymmdd.substring(4,6)}-${yyyymmdd.substring(6,8)}`;
}

// 本公司 → 长软
function toChangruanDate(date) {
  // "2025-12-30" → "20251230"
  return date.replace(/-/g, '');
}
```

### 4.2 时间格式转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 出发时间 | `HH:mm` | `HHmmss` 或 `HHMM` | 格式转换：`14:30` ↔ `143000` 或 `1430` |

**转换逻辑**：
```javascript
// 长软 → 本公司
function formatTime(cfsj) {
  // "143000" → "14:30" 或 "1430" → "14:30"
  if (cfsj.length === 6) {
    return `${cfsj.substring(0,2)}:${cfsj.substring(2,4)}`;
  } else if (cfsj.length === 4) {
    return `${cfsj.substring(0,2)}:${cfsj.substring(2,4)}`;
  }
  return cfsj;
}

// 本公司 → 长软
function toChangruanTime(time) {
  // "14:30" → "1430"
  return time.replace(':', '');
}
```

### 4.3 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额、税额 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 本公司→长软: `.toFixed(2)`<br>长软→本公司: `parseFloat()` |
| 票价 | `string` | `VARCHAR2(32)` 字符串 | 直接映射（本公司也是string） |
| 税率 | `string` | `NUMBER(8,5)` | 本公司为string，长软为number，需要类型转换 |

**转换逻辑**：
```javascript
// 长软 → 本公司
function parseAmount(amountStr) {
  // "10000.00" → 10000.00
  return parseFloat(amountStr);
}

// 本公司 → 长软
function formatAmount(amount) {
  // 10000.00 → "10000.00"
  return amount.toFixed(2);
}

// 税率转换
function parseTaxRate(rateNum) {
  // 0.09 → "0.09000"
  return rateNum.toFixed(5);
}
```

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **FPZT** (发票状态) → `invoice_status_flag`

### 5.2 铁路电子客票特有枚举映射

⚠️ **重要**: 以下枚举为**该发票类型特有**，不在通用枚举文档中。

#### 5.2.1 业务类型 (YWLX)

| 长软值 | 含义 | 本公司映射 (business_type_name) |
|-------|------|--------------------------------|
| 01 | 正常购票 | `"正常购票"` |
| 02 | 退票 | `"退票"` |
| 03 | 改签 | `"改签"` |
| 04 | 变更到站 | `"变更到站"` |

**映射逻辑**：
```javascript
const BUSINESS_TYPE_MAP = {
  '01': '正常购票',
  '02': '退票',
  '03': '改签',
  '04': '变更到站'
};

function mapBusinessType(ywlx) {
  return BUSINESS_TYPE_MAP[ywlx] || ywlx;
}
```

#### 5.2.2 铁路客票优惠类型 (railway_discount_type)

本字段为**本公司独有**，长软API无对应字段。需要根据票种（PZ）等信息推断。

| 优惠类型 | 说明 | 适用票种 |
|---------|------|---------|
| `"无优惠"` | 全价票 | 成人票 |
| `"学生优惠"` | 学生票优惠（75折） | 学生票 |
| `"残军优惠"` | 残疾军人优惠票 | 残军票 |
| `"儿童优惠"` | 儿童票优惠 | 儿童票 |
| `"其他优惠"` | 其他优惠类型 | - |

---

## 六、铁路电子客票特殊性说明

### 6.1 该类型的独特特性

1. **无发票代码**：
   - 铁路电子客票是纯电子发票，无纸质发票代码（FPDM为空）
   - 仅使用20位数字的电子发票号码（FPHM）作为唯一标识

2. **无货物明细结构**：
   - 不同于普通增值税发票，铁路客票无CHILDLIST结构
   - 所有票务信息都在主信息层级

3. **特定要素丰富**：
   - 包含大量铁路专属字段：车次、车厢、席别、席位、出发站、到达站等
   - 这些字段在 `railway_specific_elements` 对象中集中管理

4. **业务类型多样**：
   - 支持正常购票、退票、改签、变更到站等多种业务场景
   - 退票和改签时需要关联原发票信息

5. **乘客信息**：
   - 包含乘客姓名（XM）和证件号（ZJH）
   - 购买方信息（GMFMC、GFSH）仅在企业报销时填写

6. **税率固定**：
   - 铁路旅客运输服务适用9%增值税率（SLV=0.09）

7. **时间信息**：
   - 包含开票日期（KPRQ）、乘车日期（CCRQ）、出发时间（CFSJ）三个时间维度
   - 需要注意区分这三个时间字段的用途

### 6.2 与其他类型的区别

| 特性 | 铁路电子客票(51) | 增值税专用发票(01) | 航空客票(61) |
|------|----------------|------------------|-------------|
| 发票代码 | ❌ 无 | ✅ 有（12位） | ❌ 无 |
| 发票号码 | 20位数字 | 8位数字 | 20位数字 |
| 货物明细 | ❌ 无 | ✅ 有 | ❌ 无 |
| 校验码 | ❌ 无 | ❌ 无（专票无） | ❌ 无 |
| 特定要素 | ✅ railway_specific_elements | ❌ 无 | ✅ air_specific_elements |
| 购买方 | 可选（企业报销时必填） | 必填 | 可选 |
| 销售方 | 中国铁路 | 各销售企业 | 各航空公司 |
| 税率 | 固定9% | 13%/9%/6%等 | 固定9% |
| 业务类型 | 购票/退票/改签 | - | 购票/退票/改签 |

### 6.3 特殊处理逻辑

#### 6.3.1 退票和改签处理

**退票场景** (YWLX=02):
1. `is_blue_invoice` 设置为 `false` (红字发票)
2. `original_invoice_no` 填写被退票的原发票号码
3. `refunded_amount` 填写退款金额（扣除手续费后）
4. 其他字段保留原票信息

**改签场景** (YWLX=03):
1. `is_blue_invoice` 设置为 `true` (蓝字发票，新票)
2. `original_invoice_no` 填写被改签的原发票号码
3. `original_fare` 填写原票票价
4. `original_departure_station` 和 `original_arrival_station` 填写原票车站信息
5. 当前发票的 `departure_station`、`arrival_station`、`fare` 为改签后的新信息

#### 6.3.2 企业报销处理

**个人购票** (不报销):
- `buyer_name` 为空或填写乘客姓名
- `buyer_tax_no` 为空

**企业报销**:
- `buyer_name` 填写报销企业名称
- `buyer_tax_no` 填写企业纳税人识别号或统一社会信用代码
- 这两个字段在长软返回时为 `GMFMC` 和 `GFSH`

#### 6.3.3 车站拼音转换

本公司API提供 `departure_station_pinyin` 和 `arrival_station_pinyin` 字段，但长软API无对应字段。

**处理流程**:
1. 维护车站中文名到拼音简码的映射表
2. 根据 `CFZ` 和 `DDZ` 查询映射表获取拼音
3. 如果映射表中无对应车站，使用拼音库进行转换

**示例映射表**:
```javascript
const STATION_PINYIN_MAP = {
  '北京': 'BJP',
  '北京南': 'BJNP',
  '上海': 'SHH',
  '上海虹桥': 'SHHQ',
  '广州': 'GZQ',
  '广州南': 'GZNQ',
  '深圳': 'SZQ',
  '深圳北': 'SZBQ',
  // ... 更多车站
};
```

#### 6.3.4 销售方信息填充

长软API不返回销售方信息（XFMC、XFSBH等），需要系统填充：

**固定值**:
- `seller_name`: "中国铁路客票"
- `seller_tax_no`: "91110000100011239Q" (中国铁路总公司统一社会信用代码)
- `seller_address`: "北京市海淀区复兴路10号"
- `seller_phone`: "12306"

或根据实际出票铁路局配置相应信息。

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**：
- `FPHM` (发票号码) - 20位数字
- `KPRQ` (开票日期) - YYYYMMDD格式

**本公司API要求必填**：
- `invoice_category_code` (发票票种代码)
- `seller_tax_no` (销售方识别号)
- `seller_name` (销售方名称)
- `buyer_name` (购买方名称)
- `is_blue_invoice` (是否蓝字发票标志)
- `invoice_status` (发票状态)
- `railway_specific_elements.payment_amount` (支付金额)

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 30 | 20 | ✅ 本公司长度足够，实际20位 |
| passenger_name | 150 | 100 | ⚠️ 本公司更大，可容纳复杂姓名 |
| eticket_no | 30 | 100 | ⚠️ 长软更大，但实际电子客票号不超过30位 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| seat_no | 60 | 20 | ⚠️ 本公司更大，可容纳特殊席位描述 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数，本公司不提供
- `CYSJ` (查验时间) - 长软查验时间戳，本公司不提供
- `FPDM` (发票代码) - 铁路电子客票此字段为空

**本公司独有字段**（需从其他数据源获取或计算）:
- `payment_amount` (支付金额) - 从业务系统获取
- `refunded_amount` (已退金额) - 从业务系统获取
- `original_fare` (原票票价) - 改签时从业务系统获取
- `original_departure_station` (原票出发站) - 改签时从业务系统获取
- `original_arrival_station` (原票到达站) - 改签时从业务系统获取
- `railway_discount_type` (铁路客票优惠类型) - 根据票种推断
- `original_invoice_no` (原发票号码) - 退票/改签时从业务系统获取
- `departure_station_pinyin` (出发站拼音) - 通过映射表转换
- `arrival_station_pinyin` (到达站拼音) - 通过映射表转换
- `seller_name` / `seller_tax_no` / `seller_address` / `seller_phone` - 使用固定配置值
- `is_blue_invoice` - 根据业务类型判断
- `invoice_category_code` / `special_element_type_code` - 使用固定配置值
- `amount_with_tax` - 计算得出（JE + SE）

### 7.4 铁路电子客票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 查验请求参数

根据 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md)，铁路电子客票查验时：

**必填参数**:
- `invoice_type`: `"51"`
- `invoice_number`: 20位数字电子发票号码
- `issue_date`: `"YYYY-MM-DD"` 格式
- `invoice_amount`: 价税合计金额

**不需要的参数**:
- ❌ `invoice_code` - 铁路电子客票无发票代码
- ❌ `verification_code` - 铁路电子客票无校验码

**映射到长软**:
- `FPLX`: `"83"`
- `FPDM`: 空字符串
- `FPHM`: `invoice_number` (20位)
- `KPRQ`: `issue_date` 转为 YYYYMMDD
- `FPJE`: `invoice_amount` 转为字符串
- `JYM`: 空字符串

#### 7.4.2 响应字段补全策略

由于长软返回字段有限，需要补全以下字段：

1. **销售方信息**：使用预配置的中国铁路信息
2. **拼音字段**：通过车站映射表转换
3. **优惠类型**：根据票种（PZ）推断
4. **业务字段**：
   - 如果是退票（YWLX=02），`is_blue_invoice` = false
   - 如果是正常购票（YWLX=01），`is_blue_invoice` = true
5. **金额汇总**：
   - `amount_with_tax` = `JE` + `SE`
   - `total_amount` = `JE`
   - `total_tax_amount` = `SE`

#### 7.4.3 错误处理特殊情况

**常见错误**:
1. **发票号码格式错误** (CYJGDM=101)
   - 原因：发票号码不是20位数字
   - 处理：返回参数验证错误

2. **发票不存在** (CYJGDM=002)
   - 原因：该电子客票号未查询到
   - 处理：返回发票不存在错误

3. **发票已作废** (FPZT=02)
   - 原因：该票已退票
   - 处理：正常返回，invoice_status_flag标记为作废

4. **金额不符** (CYJGDM=003)
   - 原因：查验金额与实际不符
   - 处理：返回金额不一致错误

#### 7.4.4 数据一致性校验

在返回数据前，应进行以下校验：

1. **金额一致性**：
   ```javascript
   if (Math.abs((JE + SE) - amount_with_tax) > 0.01) {
     // 警告：金额计算不一致
   }
   ```

2. **税率一致性**：
   ```javascript
   if (SLV !== 0.09 && SLV !== 0.00) {
     // 警告：铁路客票税率异常
   }
   ```

3. **日期合理性**：
   ```javascript
   if (new Date(CCRQ) < new Date(KPRQ)) {
     // 警告：乘车日期早于开票日期
   }
   ```

4. **业务类型与发票状态一致性**：
   ```javascript
   if (YWLX === '02' && !is_blue_invoice) {
     // 退票应为红字发票
   }
   ```

#### 7.4.5 性能优化建议

1. **车站拼音映射表缓存**：
   - 将车站拼音映射表加载到内存中
   - 使用Redis缓存常用车站映射

2. **销售方信息缓存**：
   - 将中国铁路销售方信息配置缓存
   - 避免每次请求都查询配置

3. **批量查询优化**：
   - 如果需要批量查验铁路客票，考虑异步处理
   - 注意长软API的并发限制

---

**文档结束**
