# 发票查验API - 通用枚举映射说明

**文档版本**: v1.0
**创建日期**: 2025-12-29
**适用范围**: 所有发票类型

---

## 概述

本文档定义了本公司发票查验API与长软发票查验服务之间的**通用枚举字段映射关系**。

这些枚举映射适用于所有发票类型（01、03、04、10、11、14、15等），各发票类型的映射表文档应引用本文档，无需重复定义。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)

---

## 一、查验结果代码映射 (CYJGDM → result_code)

这是长软API返回的核心状态字段 `HEAD/CYJGDM`，需映射到本公司API的 `result_code` 和技术错误码。

### 1.1 业务查验结果映射（HTTP 200 OK + result_code）

| 长软API代码 | 长软API含义 | 本公司API result_code | 本公司API名称 | 映射说明 |
|---|---|---|---|---|
| 001 | 查验成功发票一致 | 00 | 成功 | 直接映射 |
| 006 | 查验成功发票不一致 | 03 | 查验不一致 | 发票要素与税局记录不符 |
| 009 | 所查发票不存在 | 02 | 查无数据 | 税局无此发票记录 |
| 106 | 查验异常 | 01 | 失败 | 通用查验失败 |

### 1.2 技术错误映射（HTTP 非2xx + error对象）

| 长软API代码 | 长软API含义 | 本公司API错误码 | HTTP状态码 | 说明 |
|---|---|---|---|---|
| 002 | 超过该张票当天查验次数 | `verification_daily_limit_exceeded` | 429 | 该发票今日已达税局查验次数上限（5次） |
| 003 | 超过该账户查验次数 | `company_verification_limit_exceeded` | 429 | 该企业已超过当前发票的当日查验次数限制 |
| 004 | 超过服务器最大请求数 | `verification_channel_rate_limited` | 429 | 查验请求过于频繁，已被通道限流 |
| 005 | 请求不合法 | `invoice_invalid_format` | 400 | 发票信息不规范，请检查必填字段 |
| 100 | 用户不存在 | `verification_channel_auth_failed` | 422 | 查验通道鉴权失败，企业无可用查验权限 |
| 101 | 密码不正确 | `verification_channel_auth_failed` | 422 | 查验通道鉴权失败，企业无可用查验权限 |
| 102 | 该用户无此权限 | `verification_channel_auth_failed` | 422 | 查验通道鉴权失败，企业无可用查验权限 |
| 103 | 不在查询IP地址范围内 | `verification_channel_auth_failed` | 422 | 查验通道鉴权失败，企业无可用查验权限 |
| 104 | 已超过最大查验量 | `verification_channel_quota_exceeded` | 422 | 查验通道额度已用完 |
| 105 | 查询发票不规范 | `invoice_invalid_format` | 400 | 发票信息不规范，请检查必填字段 |
| 107 | 非授权企业查验 | `verification_channel_auth_failed` | 422 | 查验通道鉴权失败，企业无可用查验权限 |
| 108 | 请求不规范 | `invoice_invalid_format` | 400 | 发票信息不规范，请检查必填字段 |
| 109 | 该地区服务暂停 | `local_etax_service_unstable` | 503 | 地方税局网络暂时不可用，请稍后重试 |

### 1.3 映射逻辑

```
长软CYJGDM 001, 006, 009, 106
  → HTTP 200 + result_code (业务查验结果)

长软CYJGDM 002, 003, 004, 005, 100-109
  → HTTP 4xx/5xx + error对象 (技术错误/业务规则阻止)
```

### 1.4 本公司API的result_code完整定义

| result_code | 名称 | 说明 | 对应长软代码 |
|---|---|---|---|
| 00 | 成功 | 查验成功，发票信息与税局记录一致 | 001 |
| 01 | 失败 | 查验失败（技术或业务原因） | 106 |
| 02 | 查无数据 | 税局无此发票记录 | 009 |
| 03 | 查验不一致 | 发票要素与税局记录不符 | 006 |
| 04 | 非本单位开具或取得 | 发票的购买方或销售方与当前企业不匹配 | - (本公司特有) |
| 05 | 不支持的发票类型 | 目前暂不支持"非税收入一般缴款书"查验 | - (本公司特有) |

---

## 二、发票状态/作废标志映射 (ZFBZ → invoice_status)

长软API在 `BODY/ZFBZ` 返回发票作废状态，映射到本公司API的 `invoice_status` 字段。

### 2.1 映射对照表

| 长软API (ZFBZ) | 长软API含义 | 本公司API (invoice_status) | 本公司API含义 | 映射说明 |
|---|---|---|---|---|
| 0 | 正常 | 0 | 正常 | 直接映射 |
| 1 | 正常 | 1 | 正常 | 直接映射 |
| N | 未作废 | 0 或 1 | 正常 | 字符转数字：N→0 |
| 2 | 作废 | 2 | 作废 | 直接映射 |
| Y | 作废 | 2 | 作废 | 字符转数字：Y→2 |
| 3 | 红冲 | 3 | 红冲 | 直接映射 |
| 7 | 部分红冲 | 7 | 部分红冲 | 直接映射 |
| 8 | 全额红冲 | 8 | 全额红冲 | 直接映射 |

### 2.2 注意事项

⚠️ **长软API同时使用字符（Y/N）和数字（0-8）表示状态，需统一转换为数字。**

转换规则：
```javascript
// 伪代码
if (ZFBZ === 'N') return 0;
if (ZFBZ === 'Y') return 2;
return parseInt(ZFBZ);
```

---

## 三、特殊票种标志映射 (TSPZBZ → special_invoice_type)

长软API在 `BODY/TSPZBZ` 返回特殊票种标志，映射到本公司API的 `special_invoice_type` 字段。

### 3.1 完全一致的映射

| 长软API (TSPZBZ) | 长软API含义 | 本公司API (special_invoice_type) | 本公司API含义 | 映射方式 |
|---|---|---|---|---|
| 05 | 石脑油发票 | 05 | 石脑油 | ✅ 直接映射 |
| 08 | 成品油发票 | 08 | 成品油发票 | ✅ 直接映射 |
| 20 | 会员单位投资性黄金 | 20 | 会员单位投资性黄金 | ✅ 直接映射 |
| 21 | 会员单位非投资性黄金 | 21 | 会员单位非投资性黄金 | ✅ 直接映射 |
| 22 | 客户标准黄金 | 22 | 客户标准黄金 | ✅ 直接映射 |

### 3.2 需要语义转换的映射

| 长软API (TSPZBZ) | 长软API含义 | 本公司API (special_invoice_type) | 本公司API含义 | 映射方式 |
|---|---|---|---|---|
| 04 | 农产品收购发票 | 02 | 农产品收购 | ⚠️ 代码不同，语义相同 |
| 02 | 稀土发票 | 03 或 04 | 稀土矿产品/稀土产成品 | ⚠️ 长软未细分，需业务判断 |

### 3.3 长软独有（本公司API暂不支持）

| 长软API (TSPZBZ) | 长软API含义 | 建议处理方式 |
|---|---|---|
| 01 | 成品油发票 | 已被08替代，建议映射到08 |
| 03 | 机动车发票 | 通过发票类型识别，非特殊票种 |
| 06 | 卷烟发票 | 扩展本公司API枚举值 |
| 07 | 建筑服务发票 | 扩展本公司API枚举值 |
| 08 | 货物运输服务发票 | 扩展本公司API枚举值 |
| 09 | 不动产销售服务发票 | 扩展本公司API枚举值 |
| 10 | 不动产经营租赁服务 | 扩展本公司API枚举值 |
| 11 | 代收车船税发票 | 扩展本公司API枚举值 |
| 12 | 旅客运输服务发票 | 扩展本公司API枚举值 |
| 13 | 自产农产品销售发票 | 扩展本公司API枚举值 |
| 14 | 通行费发票 | 通过发票类型识别，非特殊票种 |
| 15-19 | 医疗、拖拉机、二手车、光伏、出口等 | 扩展本公司API枚举值 |
| 21 | 农产品发票 | 扩展本公司API枚举值 |
| 22 | 报废产品收购发票 | 扩展本公司API枚举值 |

### 3.4 映射策略建议

1. **完全一致的代码**：直接映射（05, 08, 20-22）
2. **语义相同代码不同**：建立转换规则（TSPZBZ=04 → special_invoice_type=02）
3. **长软独有票种**：
   - 短期：记录原始值到扩展字段，返回时提示"不支持的票种类型"
   - 长期：扩展本公司API的 `special_invoice_type` 枚举值

---

## 四、枚举映射示例

### 示例1：查验成功的发票

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>001</CYJGDM>
</HEAD>
<BODY>
  <ZFBZ>0</ZFBZ>
  <TSPZBZ>08</TSPZBZ>
</BODY>
```

**映射到本公司API**（HTTP 200）：
```json
{
  "result_code": "00",
  "result_message": "成功",
  "invoice_status": 0,
  "special_invoice_type": "08"
}
```

---

### 示例2：发票不存在

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>009</CYJGDM>
</HEAD>
```

**映射到本公司API**（HTTP 200）：
```json
{
  "result_code": "02",
  "result_message": "查无数据"
}
```

---

### 示例3：超过查验次数

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>002</CYJGDM>
</HEAD>
```

**映射到本公司API**（HTTP 429）：
```json
{
  "error": {
    "code": "verification_daily_limit_exceeded",
    "type": "business_error",
    "message": "该发票今日已达到税局查验次数上限（5次）"
  }
}
```

---

### 示例4：红冲发票

**长软API返回**：
```xml
<BODY>
  <ZFBZ>3</ZFBZ>
  <TSPZBZ>04</TSPZBZ>
</BODY>
```

**映射到本公司API**：
```json
{
  "invoice_status": 3,
  "special_invoice_type": "02"
}
```

**注**：TSPZBZ=04农产品收购 映射为 special_invoice_type=02

---

### 示例5：字符型作废标志

**长软API返回**：
```xml
<BODY>
  <ZFBZ>Y</ZFBZ>
</BODY>
```

**映射到本公司API**：
```json
{
  "invoice_status": 2
}
```

**注**：字符'Y'转换为数字2

---

## 五、版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|---|---|---|---|
| v1.0 | 2025-12-29 | 从01增值税专用发票映射表中提取通用枚举映射，创建独立文档 | Claude |

---

## 六、参考文档

1. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf`
2. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0)
3. 各发票类型映射表: `docs/mappings/`目录下各文档

---

**文档结束**
