# 发票查验API - 通用枚举映射说明

**文档版本**: v2.2
**创建日期**: 2025-12-29
**更新日期**: 2025-12-31
**适用范围**: 所有发票类型

**版本更新说明**:
- v2.2 (2025-12-31): 🆕 新增第五章 - 特殊政策标识（TSZCBS）枚举映射，包含V4.1.2新增的02、04值
- v2.1 (2025-12-31): 新增QDLX（数电发票类型）枚举映射，包含V4.1.2新增的90、91值
- v2.0 (2025-12-31): 重大更新 - 废弃result_code/result_message，改用HTTP状态码+error对象

---

## 概述

本文档定义了本公司发票查验API与长软发票查验服务之间的**通用枚举字段映射关系**。

这些枚举映射适用于所有发票类型（01、03、04、10、11、14、15等），各发票类型的映射表文档应引用本文档，无需重复定义。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)

---

## 一、查验结果代码映射 (CYJGDM → HTTP状态码 + error.code)

这是长软API返回的核心状态字段 `HEAD/CYJGDM`，需映射到本公司API的 **HTTP状态码** 和 **error.code**（仅失败时）。

⚠️ **重大变更**: 本公司API已废弃 `result_code` 和 `result_message` 字段，改用标准HTTP状态码 + error对象。

### 1.1 查验成功映射

| 长软API代码 | 长软API含义 | 本公司API HTTP状态码 | 响应结构 | 映射说明 |
|---|---|---|---|---|
| 001 | 查验成功发票一致 | 200 OK | 直接返回 `invoice_type` + `verification_data` | **成功时无error对象，无result_code字段** |

### 1.2 查验失败映射（业务层）

| 长软API代码 | 长软API含义 | HTTP状态码 | error.code | error.message示例 |
|---|---|---|---|---|
| 009 | 所查发票不存在 | 404 | `invoice_not_found` | 税局无此发票记录 |
| 006 | 查验成功发票不一致 | 422 | `invoice_verification_mismatch` | 发票要素与税局记录不符 |
| 106 | 查验异常 | 503 | `etax_service_unstable` | 税局查验服务暂时不可用，请稍后重试 |

### 1.3 查验失败映射（技术/系统层）

| 长软API代码 | 长软API含义 | HTTP状态码 | error.code | error.message示例 |
|---|---|---|---|---|
| 002 | 超过该张票当天查验次数 | 429 | `verification_daily_limit_exceeded` | 该发票今日已达税局查验次数上限（5次） |
| 003 | 超过该账户查验次数 | 429 | `company_verification_limit_exceeded` | 该企业已超过当前发票的当日查验次数限制 |
| 004 | 超过服务器最大请求数 | 429 | `verification_channel_rate_limited` | 查验请求过于频繁，已被通道限流 |
| 005 | 请求不合法 | 400 | `invoice_invalid_format` | 发票信息不规范，请检查必填字段 |
| 100 | 用户不存在 | 422 | `verification_channel_auth_failed` | 查验通道鉴权失败，企业无可用查验权限 |
| 101 | 密码不正确 | 422 | `verification_channel_auth_failed` | 查验通道鉴权失败，企业无可用查验权限 |
| 102 | 该用户无此权限 | 422 | `verification_channel_auth_failed` | 查验通道鉴权失败，企业无可用查验权限 |
| 103 | 不在查询IP地址范围内 | 422 | `verification_channel_auth_failed` | 查验通道鉴权失败，企业无可用查验权限 |
| 104 | 已超过最大查验量 | 422 | `verification_channel_quota_exceeded` | 查验通道额度已用完 |
| 105 | 查询发票不规范 | 400 | `invoice_invalid_format` | 发票信息不规范，请检查必填字段 |
| 107 | 非授权企业查验 | 422 | `verification_channel_auth_failed` | 查验通道鉴权失败，企业无可用查验权限 |
| 108 | 请求不规范 | 400 | `invoice_invalid_format` | 发票信息不规范，请检查必填字段 |
| 109 | 该地区服务暂停 | 503 | `local_etax_service_unstable` | 地方税局网络暂时不可用，请稍后重试 |

### 1.4 本公司API特有错误码（无对应长软代码）

以下错误码由本公司业务逻辑产生，不直接对应长软API的CYJGDM：

| HTTP状态码 | error.code | 触发场景 | error.message示例 |
|---|---|---|---|
| 403 | `invoice_not_belong_to_company` | 发票的购买方或销售方与当前企业不匹配 | 该发票不属于当前企业 |
| 422 | `invoice_type_not_supported` | 发票类型不在支持范围内 | 暂不支持该类型发票的查验 |
| 422 | `invoice_too_old` | 发票开票日期超过可查验期限 | 发票开票日期已超过5年查验期限 |

---

## 二、发票状态/作废标志映射 (ZFBZ → invoice_status)

长软API在 `BODY/ZFBZ` 返回发票作废状态，映射到本公司API的 `invoice_status` 字段。

### 2.1 映射对照表

| 长软API (ZFBZ) | 长软API含义 | 本公司API (invoice_status) | 本公司API含义 | 映射说明 |
|---|---|---|---|---|
| 0 | 正常 | 0 | 正常 | 直接映射 |
| 1 | 正常 | 1 | 正常 | 直接映射 |
| N | 未作废 | 0 或 1 | 正常 | 字符转数字：N→0 |
| 2 | 作废 | 2 | 作废 | 直接映射 |
| Y | 作废 | 2 | 作废 | 字符转数字：Y→2 |
| 3 | 红冲 | 3 | 红冲 | 直接映射 |
| 7 | 部分红冲 | 7 | 部分红冲 | 直接映射 |
| 8 | 全额红冲 | 8 | 全额红冲 | 直接映射 |

### 2.2 注意事项

⚠️ **长软API同时使用字符（Y/N）和数字（0-8）表示状态，需统一转换为数字。**

转换规则：
```javascript
// 伪代码
if (ZFBZ === 'N') return 0;
if (ZFBZ === 'Y') return 2;
return parseInt(ZFBZ);
```

---

## 三、特殊票种标志映射 (TSPZBZ → special_invoice_type)

长软API在 `BODY/TSPZBZ` 返回特殊票种标志，映射到本公司API的 `special_invoice_type` 字段。

### 3.1 完全一致的映射

| 长软API (TSPZBZ) | 长软API含义 | 本公司API (special_invoice_type) | 本公司API含义 | 映射方式 |
|---|---|---|---|---|
| 05 | 石脑油发票 | 05 | 石脑油 | ✅ 直接映射 |
| 08 | 成品油发票 | 08 | 成品油发票 | ✅ 直接映射 |
| 20 | 会员单位投资性黄金 | 20 | 会员单位投资性黄金 | ✅ 直接映射 |
| 21 | 会员单位非投资性黄金 | 21 | 会员单位非投资性黄金 | ✅ 直接映射 |
| 22 | 客户标准黄金 | 22 | 客户标准黄金 | ✅ 直接映射 |

### 3.2 需要语义转换的映射

| 长软API (TSPZBZ) | 长软API含义 | 本公司API (special_invoice_type) | 本公司API含义 | 映射方式 |
|---|---|---|---|---|
| 04 | 农产品收购发票 | 02 | 农产品收购 | ⚠️ 代码不同，语义相同 |
| 02 | 稀土发票 | 03 或 04 | 稀土矿产品/稀土产成品 | ⚠️ 长软未细分，需业务判断 |

### 3.3 长软独有（本公司API暂不支持）

| 长软API (TSPZBZ) | 长软API含义 | 建议处理方式 |
|---|---|---|
| 01 | 成品油发票 | 已被08替代，建议映射到08 |
| 03 | 机动车发票 | 通过发票类型识别，非特殊票种 |
| 06 | 卷烟发票 | 扩展本公司API枚举值 |
| 07 | 建筑服务发票 | 扩展本公司API枚举值 |
| 08 | 货物运输服务发票 | 扩展本公司API枚举值 |
| 09 | 不动产销售服务发票 | 扩展本公司API枚举值 |
| 10 | 不动产经营租赁服务 | 扩展本公司API枚举值 |
| 11 | 代收车船税发票 | 扩展本公司API枚举值 |
| 12 | 旅客运输服务发票 | 扩展本公司API枚举值 |
| 13 | 自产农产品销售发票 | 扩展本公司API枚举值 |
| 14 | 通行费发票 | 通过发票类型识别，非特殊票种 |
| 15 | 医疗服务（住院）发票 | 🆕 **V4.1.2新增** 配合QDLX=90使用 |
| 16 | 医疗服务（门诊）发票 | 🆕 **V4.1.2新增** 配合QDLX=91使用 |
| 17 | 拖拉机和联合收割机发票 | 扩展本公司API枚举值 |
| 18 | 二手车发票 | 扩展本公司API枚举值 |
| 19 | 光伏收购发票 | 扩展本公司API枚举值 |
| 20 | 出口发票 | 扩展本公司API枚举值 |
| 21 | 农产品发票 | 扩展本公司API枚举值 |
| 22 | 报废产品收购发票 | 扩展本公司API枚举值 |

### 3.4 映射策略建议

1. **完全一致的代码**：直接映射（05, 08, 20-22）
2. **语义相同代码不同**：建立转换规则（TSPZBZ=04 → special_invoice_type=02）
3. **长软独有票种**：
   - 短期：记录原始值到扩展字段，返回时提示"不支持的票种类型"
   - 长期：扩展本公司API的 `special_invoice_type` 枚举值

---

## 四、枚举映射示例

### 示例1：查验成功的发票

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>001</CYJGDM>
</HEAD>
<BODY>
  <ZFBZ>0</ZFBZ>
  <TSPZBZ>08</TSPZBZ>
  <FPHM>12345678</FPHM>
  <FPDM>1100182130</FPDM>
</BODY>
```

**映射到本公司API**（HTTP 200 OK）：
```json
{
  "request_id": "req_abc123",
  "invoice_type": "04",
  "verification_data": {
    "invoice_number": "12345678",
    "invoice_code": "1100182130",
    "invoice_status": 0,
    "special_invoice_type": "08"
  }
}
```

**注**：成功响应中**无error对象**，**无result_code/result_message字段**。

---

### 示例2：发票不存在

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>009</CYJGDM>
</HEAD>
```

**映射到本公司API**（HTTP 404 Not Found）：
```json
{
  "error": {
    "code": "invoice_not_found",
    "message": "税局无此发票记录",
    "type": "invalid_request",
    "request_id": "req_abc123"
  }
}
```

**注**：失败响应只返回**error对象**，不返回任何业务数据。

---

### 示例3：发票要素不一致

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>006</CYJGDM>
</HEAD>
```

**映射到本公司API**（HTTP 422 Unprocessable Entity）：
```json
{
  "error": {
    "code": "invoice_verification_mismatch",
    "message": "发票要素与税局记录不符",
    "type": "invalid_request",
    "request_id": "req_abc123"
  }
}
```

---

### 示例4：超过查验次数

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>002</CYJGDM>
</HEAD>
```

**映射到本公司API**（HTTP 429 Too Many Requests）：
```json
{
  "error": {
    "code": "verification_daily_limit_exceeded",
    "message": "该发票今日已达到税局查验次数上限（5次）",
    "type": "rate_limit_error",
    "request_id": "req_abc123"
  }
}
```

---

### 示例5：红冲发票（查验成功）

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>001</CYJGDM>
</HEAD>
<BODY>
  <ZFBZ>3</ZFBZ>
  <TSPZBZ>04</TSPZBZ>
  <FPHM>12345678</FPHM>
</BODY>
```

**映射到本公司API**（HTTP 200 OK）：
```json
{
  "request_id": "req_abc123",
  "invoice_type": "01",
  "verification_data": {
    "invoice_number": "12345678",
    "invoice_status": 3,
    "special_invoice_type": "02"
  }
}
```

**注**：
- 查验成功（CYJGDM=001），返回200 OK
- ZFBZ=3（红冲）映射为 invoice_status=3
- TSPZBZ=04（农产品收购）映射为 special_invoice_type=02

---

### 示例6：字符型作废标志（查验成功）

**长软API返回**：
```xml
<HEAD>
  <CYJGDM>001</CYJGDM>
</HEAD>
<BODY>
  <ZFBZ>Y</ZFBZ>
  <FPHM>87654321</FPHM>
</BODY>
```

**映射到本公司API**（HTTP 200 OK）：
```json
{
  "request_id": "req_abc123",
  "invoice_type": "04",
  "verification_data": {
    "invoice_number": "87654321",
    "invoice_status": 2
  }
}
```

**注**：字符'Y'（作废）转换为数字2

---

## 四、数电发票类型映射 (QDLX → digital_invoice_subtype)

长软API在 `HEAD/QDLX` 返回数电发票的具体类型，仅当 `FPLX=09` （数电发票）且查验结果为一致时才有值。

### 4.1 QDLX枚举映射

⚠️ **注意**: QDLX字段仅在查验数电发票（FPLX=09）且查验成功时返回。

| 长软API (QDLX) | 长软API含义 | 本公司API发票类型代码 | 本公司API发票类型名称 | 映射说明 |
|---|---|---|---|---|
| 01 | 增值税纸质专票 | 85 | 数电发票（纸质专票） | 数电纸质专用发票 |
| 04 | 增值税纸质普票 | 86 | 数电发票（纸质普票） | 数电纸质普通发票 |
| 03 | 机动车发票 | 83 或 87 | 数电发票（电子机动车）或（纸质机动车） | 需根据是否有纸质发票代码区分 |
| 15 | 二手车发票 | 84 或 88 | 数电发票（电子二手车）或（纸质二手车） | 需根据是否有纸质发票代码区分 |
| 10 | 增值税电子普票 | 82 | 数电发票（普票） | 数电普通发票 |
| 20 | 增值税电子专票 | 81 | 数电发票（专票） | 数电专用发票 |
| 90 | 医疗（住院）发票 | 82 | 数电发票（普票-医疗住院） | 🆕 **V4.1.2新增** 医疗住院发票 |
| 91 | 医疗（门诊）发票 | 82 | 数电发票（普票-医疗门诊） | 🆕 **V4.1.2新增** 医疗门诊发票 |

### 4.2 QDLX与本公司发票类型对应关系

本公司API的发票类型代码与长软FPLX+QDLX的组合关系：

| 本公司类型码 | 本公司类型名 | 长软FPLX | 长软QDLX | 长软章节 |
|---|---|---|---|---|
| 81 | 数电发票（专票） | 09 | 20 | 3.2.3.9 |
| 82 | 数电发票（普票） | 09 | 10 | 3.2.3.10 |
| 82 | 数电发票（普票-医疗住院） | 09 | 90 | 3.2.3.20 🆕 |
| 82 | 数电发票（普票-医疗门诊） | 09 | 91 | 3.2.3.21 🆕 |
| 83 | 数电发票（电子机动车） | 09 | 03 | 3.2.3.15 |
| 84 | 数电发票（电子二手车） | 09 | 15 | 3.2.3.16 |
| 85 | 数电发票（纸质专票） | 09 | 01 | 3.2.3.12 |
| 86 | 数电发票（纸质普票） | 09 | 04 | 3.2.3.13 |
| 87 | 数电发票（纸质机动车） | 09 | 03 | 3.2.3.17 |
| 88 | 数电发票（纸质二手车） | 09 | 15 | 3.2.3.18 |

### 4.3 医疗发票特殊说明 🆕

**V4.1.2版本新增**：医疗住院（QDLX=90）和医疗门诊（QDLX=91）发票。

#### 4.3.1 识别方式

通过请求参数 `REQTYPE` 控制医疗发票的返回格式：

- **REQTYPE=V1** 或 **不填**（默认）：医疗发票按标准数电普票格式返回（QDLX=10）
- **REQTYPE=V2**：医疗发票按专用格式返回（QDLX=90或91）

#### 4.3.2 特殊票种标志 (TSPZBZ)

医疗发票同时使用TSPZBZ字段标识：
- **TSPZBZ=15**：医疗服务（住院）发票
- **TSPZBZ=16**：医疗服务（门诊）发票

#### 4.3.3 映射逻辑

```
如果 FPLX=09 且 QDLX=90 且 TSPZBZ=15：
  → 本公司发票类型码 = 82（数电普票）
  → 子类型 = "医疗住院"
  → 使用医疗住院明细结构（medical_inpatient_detail_list）

如果 FPLX=09 且 QDLX=91 且 TSPZBZ=16：
  → 本公司发票类型码 = 82（数电普票）
  → 子类型 = "医疗门诊"
  → 使用医疗门诊明细结构（medical_outpatient_detail_list）
```

### 4.4 版本兼容性说明

**V4.1.2 → V4.1.2 变化**：
- 新增 QDLX=90（医疗住院）
- 新增 QDLX=91（医疗门诊）
- 新增 TSPZBZ=15（医疗服务-住院）
- 新增 TSPZBZ=16（医疗服务-门诊）
- 新增请求参数 REQTYPE（V1/V2）

**向后兼容性**：
- 旧系统不传REQTYPE或传V1，医疗发票仍按QDLX=10标准普票格式返回
- 新系统传REQTYPE=V2，医疗发票按专用格式（QDLX=90/91）返回

---

## 五、特殊政策标识映射 (TSZCBS → special_policy_code)

长软API在货物明细的 `CHILDLIST/CHILD/TSZCBS` 返回特殊政策标识，映射到本公司API的 `items[].special_policy_code` 字段。

⚠️ **重要**: 这是货物明细级别的字段，用于标识该商品适用的税收优惠政策。

### 5.1 完整枚举映射

| 长软API (TSZCBS) | 长软API含义 | 本公司API (special_policy_code) | 映射说明 |
|---|---|---|---|
| 1 | 免税 | 01 | ⚠️ 代码转换：1 → 01 |
| 2 | 不征税 | 02 | ⚠️ 代码转换：2 → 02 |
| 3 | 0税率 | 03 | ⚠️ 代码转换：3 → 03 |
| 01 | 不征税 | 01 | ✅ 直接映射 |
| 02 | 零税率 | 02 | 🆕 **V4.1.2新增** 直接映射 |
| 04 | 免税 | 04 | 🆕 **V4.1.2新增** 直接映射 |

### 5.2 语义对照说明

长软API使用了**混合编码**（数字1-3和字符串01、02、04），需要统一处理：

| 税收政策 | 长软旧编码 | 长软新编码（V4.1.2） | 本公司统一编码 | 说明 |
|---------|----------|-------------------|---------------|------|
| 免税 | 1 | 04 | 04 或 01 | 🆕 V4.1.2新增04编码 |
| 不征税 | 2 | 01 | 01 或 02 | 01和02含义相同 |
| 零税率 / 0税率 | 3 | 02 | 02 或 03 | 🆕 V4.1.2新增02编码（零税率） |

### 5.3 映射转换规则

**长软API → 本公司API 转换逻辑**：

```javascript
// 伪代码
function mapTSZCBS(tszcbs) {
  const mapping = {
    '1': '04',   // 免税（旧）→ 免税（新）
    '2': '01',   // 不征税（旧）→ 不征税
    '3': '02',   // 0税率（旧）→ 零税率（新）
    '01': '01',  // 不征税 → 不征税
    '02': '02',  // 零税率 → 零税率（V4.1.2新增）
    '04': '04'   // 免税 → 免税（V4.1.2新增）
  };
  return mapping[tszcbs] || tszcbs;
}
```

### 5.4 版本兼容性说明

**V4.1.2 → V4.1.2 变化**：
- 新增 **TSZCBS=02**（零税率）- 替代旧的"3"
- 新增 **TSZCBS=04**（免税）- 替代旧的"1"
- 保留 **TSZCBS=01**（不征税）- 替代旧的"2"

**编码演进**：
```
旧版本（单字符）  →  新版本V4.1.2（双字符）
    1 (免税)      →     04 (免税)
    2 (不征税)    →     01 (不征税)
    3 (0税率)     →     02 (零税率)
```

**建议处理策略**：
1. **优先使用新编码**（01、02、04）作为本公司API的标准值
2. **兼容处理旧编码**（1、2、3），映射到对应的新编码
3. **数据库存储**使用双字符格式（01、02、04）

### 5.5 业务含义区分

| special_policy_code | 税收政策 | 税率特征 | 抵扣规则 | 典型场景 |
|---------------------|---------|---------|---------|---------|
| 01 | 不征税 | 无税率 | 不可抵扣 | 政府补贴、代收款项 |
| 02 | 零税率 | 税率=0% | 可抵扣进项税 | 出口货物、国际运输 |
| 03 | 0税率（同02） | 税率=0% | 可抵扣进项税 | 同零税率 |
| 04 | 免税 | 税率=0% | 不可抵扣进项税 | 农产品、古旧图书 |

**关键区别**：
- **零税率（02/03）**：税率为0但可以抵扣进项税额（如出口退税）
- **免税（04）**：税率为0但不能抵扣进项税额（如农产品销售）
- **不征税（01）**：不属于增值税征税范围（如财政补贴）

### 5.6 使用示例

#### 示例1：出口货物（零税率）

**长软API返回**（货物明细）：
```xml
<CHILD>
  <HWMC>出口钢材</HWMC>
  <SLV>0</SLV>
  <SE>0</SE>
  <TSZCBS>02</TSZCBS>
</CHILD>
```

**映射到本公司API**：
```json
{
  "items": [{
    "name": "出口钢材",
    "tax_rate": 0,
    "tax_amount": 0,
    "special_policy_code": "02"  // 零税率，可抵扣进项税
  }]
}
```

#### 示例2：免税农产品

**长软API返回**（可能返回旧编码）：
```xml
<CHILD>
  <HWMC>新鲜蔬菜</HWMC>
  <SLV>0</SLV>
  <SE>0</SE>
  <TSZCBS>1</TSZCBS>
</CHILD>
```

**映射到本公司API**（转换为新编码）：
```json
{
  "items": [{
    "name": "新鲜蔬菜",
    "tax_rate": 0,
    "tax_amount": 0,
    "special_policy_code": "04"  // 免税，不可抵扣进项税（从"1"转换）
  }]
}
```

---

## 六、版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|---|---|---|---|
| v2.2 | 2025-12-31 | 🆕 新增第五章：特殊政策标识（TSZCBS）枚举映射；新增V4.1.2的02、04值；补充业务含义区分 | Claude |
| v2.1 | 2025-12-31 | 新增QDLX（数电发票类型）枚举映射章节；新增QDLX=90/91医疗发票说明；更新TSPZBZ枚举增加15/16 | Claude |
| v2.0 | 2025-12-31 | **重大更新**：废弃result_code/result_message，改用HTTP状态码+error对象；更新所有映射表和示例 | Claude |
| v1.0 | 2025-12-29 | 从01增值税专用发票映射表中提取通用枚举映射，创建独立文档 | Claude |

---

## 七、参考文档

1. 长软API文档: `【长软】发票查验服务调用说明V4.1.2.pdf`
2. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0)
3. 各发票类型映射表: `docs/mappings/`目录下各文档
4. 医疗发票映射表:
   - `本公司82_数电普票（医疗住院）→长软09(QDLX=90).md`
   - `本公司82_数电普票（医疗门诊）→长软09(QDLX=91).md`

---

**文档结束**
