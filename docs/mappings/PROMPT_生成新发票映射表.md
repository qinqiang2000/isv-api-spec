# 📋 发票查验API映射表生成规范

**用途**: 在新会话中快速生成发票类型映射表
**版本**: v2.0 (2025-12-30更新)
**重要更新**: 采用折中方案 - 只引用2个通用文档，其他内容完全自包含

---

## 一、项目背景

### 1.1 系统架构

```
用户/业务系统
    ↓ 调用
本公司发票查验API (RESTful JSON)
    ↓ 转换映射
长软发票查验服务 (SOAP XML)
    ↓
返回查验结果
```

### 1.2 接口对比

| 维度 | 本公司API | 长软API |
|------|-----------|---------|
| 定义文档 | `invoice_verification.apifox.json` | `【长软】发票查验服务调用说明V4.0.16.pdf` |
| 协议 | HTTP REST | HTTP POST |
| 格式 | JSON | XML |
| 发票类型数 | 19个 (01,02,03,04,08,10,11,14,15,51,61,81-88,F1) | 12个基础类型 (01,03,04,10,11,14,15,20,09,83,61,72) |

### 1.3 发票类型映射关系

#### 一对一映射
```
本公司01 → 长软01  (增值税专用发票)
本公司02 → 长软01  (货运专票，实际也走01)
本公司03 → 长软03  (机动车发票)
本公司04 → 长软04  (增值税普通发票)
本公司08 → 长软20  (电子专票)
本公司10 → 长软10  (电子普票)
本公司11 → 长软11  (卷式发票)
本公司14 → 长软14  (通行费发票)
本公司15 → 长软15  (二手车发票)
本公司51 → 长软83  (铁路客票)
本公司61 → 长软61  (航空客票)
```

#### 一对多映射（长软09数电发票）
```
本公司81 → 长软09(QDLX=20)  (数电专票)
本公司82 → 长软09(QDLX=10)  (数电普票)
本公司83 → 长软09(QDLX=03)  (数电机动车)
本公司84 → 长软09(QDLX=15)  (数电二手车)
本公司85 → 长软09(QDLX=01)  (数电纸质专票)
本公司86 → 长软09(QDLX=04)  (数电纸质普票)
本公司87 → 长软09(QDLX=03)  (数电纸质机动车)
本公司88 → 长软09(QDLX=15)  (数电纸质二手车)
```

---

## 二、文档组织方案 ⚠️ 重要

### 2.1 文件命名规范

```
本公司{类型码}_{中文名}→长软{类型码}.md

示例:
- 本公司01_增值税专用发票→长软01.md
- 本公司81_数电专票→长软09(QDLX=20).md
```

### 2.2 引用规则（折中方案）

**✅ 只有以下2个文档允许被引用**：
1. `00_通用说明_请求参数映射.md` - 请求参数对所有类型都一样
2. `00_通用说明_枚举映射.md` - 通用枚举值(CYJGDM查验结果, ZFBZ作废标志, TSPZBZ特殊票种等)

**❌ 其他所有内容必须自包含**，包括：
- ✅ 响应字段映射表（完整，不引用任何文档）
- ✅ 数据格式转换规则（完整说明，不引用）
- ✅ 特殊票种的枚举（如机动车版本信息BBXX）
- ✅ 特定要素的枚举（如航空舱位等级ZWDJ）
- ✅ 该类型的特殊处理逻辑
- ✅ 完整的XML→JSON映射示例

**🚫 不需要包含的内容**（用户明确要求）：
- ❌ 完整代码示例
- ❌ 测试用例

### 2.3 设计目标

**核心原则**: AI只需读取 **1个映射表文档 + 2个通用文档**，即可生成准确的生产对接代码。

---

## 三、映射表文档模板

```markdown
# 本公司{XX}_{发票类型名称}→长软{YY} 字段映射表

**文档版本**: v1.0
**创建日期**: YYYY-MM-DD
**发票类型**: {XX} - {发票类型名称}

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"{发票类型名称}"的完整字段映射关系。

- **本公司API**: invoice_verification.apifox.json (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: {XX}
- **长软发票类型代码**: {YY} [如果是09，需标注QDLX值]
- **长软文档章节**: 3.2.3.{N}

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `{XX}` | `{YY}` | [如有特殊说明] |
| 发票类型名称 | {中文名} | {长软中文名} | |
| 数据结构定义 | `#/definitions/{ID}` | `3.2.3.{N}` | |
| 数电发票类型 | - | `QDLX={值}` | 仅09类型需要标注 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| ... | ... | ... | ... | ... | ... | ... |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，查验次数统计 |
| `void_date` | 作废日期 | string(19) | - | - | - | **本公司独有**，从业务系统获取 |
| ... | ... | ... | ... | ... | ... | ... |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `tax_rate` | 计算得出 | 取items中第一个非零税率，或计算加权平均税率 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `void_date` | 业务系统 | 从企业业务系统获取，长软只返回ZFBZ标志 |
| `proxy_seller_tax_no` | 解析得出 | 当TSPZBZ=02(农产品收购)时，从备注或特定字段解析 |
| ... | ... | ... |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**: [根据实际情况说明]
- ✅ 该发票类型有货物明细结构
- ❌ 该发票类型无货物明细（如卷式发票）
- 🔄 该发票类型使用特殊结构（如机动车车辆信息、二手车买卖双方信息）

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 明细序号 | integer | - | - | - | **本公司独有**，用于排序 |
| `name` | 货物名称 | string(310) | `HWMC` | 货物或应税劳务名称 | VARCHAR2(320) | 直接映射 |
| `specification` | 规格型号 | string(64) | `GGXH` | 规格型号 | VARCHAR2(64) | 直接映射 |
| ... | ... | ... | ... | ... | ... | ... |

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**JavaScript转换代码**:
```javascript
// 本公司 → 长软
const kprq = issueDate.replace(/-/g, '').substring(0, 8); // "2025-12-30" → "20251230"

// 长软 → 本公司
const issueDate = `${kprq.substring(0,4)}-${kprq.substring(4,6)}-${kprq.substring(6,8)}`; // "20251230" → "2025-12-30"
```

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额、税额 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 本公司→长软: `.toString()`<br>长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 同上 |
| 税率 | `number` (8,5) | `NUMBER(8,5)` | 类型一致，直接映射 |

**JavaScript转换代码**:
```javascript
// 本公司 → 长软
const fpje = invoiceAmount?.toString(); // 10000.50 → "10000.50"

// 长软 → 本公司
const amount = parseFloat(responseBody.JE); // "10000.50" → 10000.50
```

### 4.3 XML与JSON结构差异

**长软返回 (XML)**:
```xml
<MSG>
  <HEAD>
    <FPLX>{YY}</FPLX>
    <CYJGDM>001</CYJGDM>
  </HEAD>
  <BODY>
    <FPDM>1234567890</FPDM>
    <FPHM>12345678</FPHM>
    <KPRQ>20251230</KPRQ>
    <GFMC>购方名称</GFMC>
    <XFMC>销方名称</XFMC>
    <JE>10000.00</JE>
    <SE>1300.00</SE>
    <JSHJ>11300.00</JSHJ>
    <CHILDLIST>
      <CHILD>
        <HWMC>货物名称</HWMC>
        <JE>10000.00</JE>
        <SE>1300.00</SE>
      </CHILD>
    </CHILDLIST>
  </BODY>
</MSG>
```

**本公司返回 (JSON)**:
```json
{
  "result_code": "00",
  "invoice_type": "{XX}",
  "verification_data": {
    "invoice_code": "1234567890",
    "invoice_number": "12345678",
    "issue_date": "2025-12-30",
    "buyer_name": "购方名称",
    "seller_name": "销方名称",
    "amount": 10000.00,
    "tax_amount": 1300.00,
    "total_amount": 11300.00,
    "items": [
      {
        "sequence_no": 1,
        "name": "货物名称",
        "amount": 10000.00,
        "tax_amount": 1300.00
      }
    ]
  }
}
```

---

## 五、枚举值映射

### 5.1 通用枚举映射

以下通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

快速参考：

#### 查验结果代码 (CYJGDM)
| 长软代码 | 含义 | 映射到本公司 |
|---------|------|-------------|
| 001 | 查验成功发票一致 | `result_code: "00"` |
| 006 | 查验成功发票不一致 | `result_code: "03"` |
| 009 | 所查发票不存在 | `result_code: "02"` |
| 其他 | 各类错误 | `error.code: "{代码}"` |

#### 作废标志 (ZFBZ)
| 长软值 | 本公司值 | 说明 |
|-------|---------|------|
| 0, 1, N | 0 或 1 | 正常 |
| 2, Y | 2 | 作废 |
| 3 | 3 | 红冲 |
| 7, 8 | 7, 8 | 部分/全额红冲 |

#### 特殊票种标志 (TSPZBZ)
| 长软值 | 本公司映射 | 说明 |
|-------|-----------|------|
| 01 | `special_invoice_type: "01"` | 成品油发票 |
| 02 | `special_invoice_type: "02"` | 农产品收购 |
| 03 | `special_invoice_type: "03"` | 稀土发票 |
| ... | ... | [查看通用文档] |

### 5.2 {类型}特有枚举映射

⚠️ **重要**: 以下枚举为**该发票类型特有**，不在通用枚举文档中。

[如果该类型有特殊枚举，在此详细列出完整映射表]

#### 示例：机动车版本信息 (BBXX)
| 长软值 | 含义 | 本公司映射 |
|-------|------|-----------|
| 0 | 旧版机动车发票 | `vehicle_version: "old"` |
| 1 | 新版机动车发票 | `vehicle_version: "new"` |

#### 示例：航空舱位等级 (ZWDJ)
| 长软值 | 本公司映射 | 说明 |
|-------|-----------|------|
| F | `seat_class: "first"` | 头等舱 |
| C | `seat_class: "business"` | 商务舱 |
| Y | `seat_class: "economy"` | 经济舱 |

---

## 六、{类型}特殊性说明

### 6.1 该类型的独特特性

[根据实际发票类型详细说明其业务特性]

**示例参考**（根据实际类型调整）：

1. **增值税专用发票 (01)**:
   - 无校验码（JYM字段为空）
   - 可抵扣进项税
   - 必须有货物明细
   - 农产品收购时购销方信息反向存储

2. **机动车发票 (03)**:
   - 购方可能是个人（使用身份证号而非税号）
   - 包含车辆识别代号、合格证号等特殊字段
   - 无货物明细，为车辆信息结构
   - 含税控设备编号(SKPH)

3. **二手车发票 (15)**:
   - 涉及买卖双方、经营单位、二手车市场四方信息
   - 车价合计为不含税价
   - 有反向开票标志(FXKPBZ)

4. **卷式发票 (11)**:
   - 无货物明细，只有项目级信息
   - 可能为定额发票
   - 含收款员信息(SHY)

### 6.2 与其他类型的区别

| 特性 | {本类型} | {对比类型1} | {对比类型2} |
|------|---------|-----------|-----------|
| 校验码 | ... | ... | ... |
| 抵扣 | ... | ... | ... |
| 明细结构 | ... | ... | ... |
| 特殊字段 | ... | ... | ... |

### 6.3 特殊处理逻辑

[详细说明该类型需要的特殊代码逻辑]

**处理流程**:
1. **步骤1**: [说明]
2. **步骤2**: [说明]
3. ...

**伪代码示例**（如需）:
```javascript
// 特殊处理示例
if (tspzbz === '02') {
  // 农产品收购：购销方信息反向
  const temp = {
    buyer_name: response.XFMC,
    seller_name: response.GFMC
  };
}
```

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（但本公司API可选）:
- [列出字段]

**本公司API要求必填**（但长软API可选）:
- [列出字段]

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 10 | ⚠️ 本公司长度更大，但实际8位足够 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| ... | ... | ... | ... |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数
- `CYSJ` (查验时间) - 长软查验时间戳
- `JQBH` (机器编号) - 税控设备编号
- ...

**本公司独有字段**（需从其他数据源获取）:
- `void_date` (作废日期) - 从业务系统获取
- `proxy_seller_*` (代开信息) - 从业务规则解析
- `vehicle_abnormal_flag` (机动车异常) - 从业务系统获取
- ...

### 7.4 {类型}特殊集成要点

[针对该发票类型的特殊集成注意事项]

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

---

## 八、映射示例

### 示例1: 标准{类型}发票查验成功

**场景**: 查验一张正常的{发票类型名称}

**长软API返回** (XML):
```xml
<MSG>
  <HEAD>
    <FPLX>{YY}</FPLX>
    <FPDM>1234567890</FPDM>
    <FPHM>12345678</FPHM>
    <KPRQ>20251230</KPRQ>
    <FPJE>10000.00</FPJE>
    <JYM></JYM>
    <CYJGDM>001</CYJGDM>
  </HEAD>
  <BODY>
    <FPDM>1234567890</FPDM>
    <FPHM>12345678</FPHM>
    <KPRQ>20251230</KPRQ>
    <GFMC>购方公司名称</GFMC>
    <GFSBH>91110000000000001X</GFSBH>
    <XFMC>销方公司名称</XFMC>
    <XFSBH>91110000000000002Y</XFSBH>
    <JE>10000.00</JE>
    <SE>1300.00</SE>
    <JSHJ>11300.00</JSHJ>
    <ZFBZ>0</ZFBZ>
    ...
  </BODY>
</MSG>
```

**映射到本公司API** (JSON):
```json
{
  "request_id": "req_xxx",
  "result_code": "00",
  "result_message": "查验成功",
  "invoice_type": "{XX}",
  "verification_data": {
    "invoice_code": "1234567890",
    "invoice_number": "12345678",
    "issue_date": "2025-12-30",
    "invoice_status": "00",
    "buyer_name": "购方公司名称",
    "buyer_tax_no": "91110000000000001X",
    "seller_name": "销方公司名称",
    "seller_tax_no": "91110000000000002Y",
    "amount": 10000.00,
    "tax_amount": 1300.00,
    "total_amount": 11300.00,
    "invoice_status_flag": "1",
    ...
  }
}
```

### 示例2: [特殊场景]

[如有该类型特殊场景（如作废、红冲、农产品收购等），添加更多示例]

---

## 九、版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2025-12-30 | 初始版本，创建{类型}发票字段映射表 | AI |

---

## 十、参考文档

1. 本公司API定义: `invoice_verification.apifox.json`
   - 数据结构: `#/definitions/{ID}`
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf`
   - 章节: 3.2.3.{N}
3. 通用请求参数映射: [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md)
4. 通用枚举映射: [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

---

**文档结束**
```

---

## 四、新会话生成Prompt 🚀

### 方式1：完整Prompt（推荐）

```
我需要生成一个发票类型的完整字段映射表。

## 任务信息

- **发票类型**: 本公司{XX} - {发票类型名称}
- **长软类型**: {YY}
- **长软章节**: 3.2.3.{N}
- **数电类型** (如适用): QDLX={值}

## 数据源文件

请读取以下文件作为数据源：

1. **本公司API定义**:
   @/Users/qinqiang02/workspace/api_spec/isv-api-spec/invoice_verification.apifox.json
   - 搜索数据结构: `#/definitions/{ID}`

2. **长软API文档**:
   @/Users/qinqiang02/workspace/api_spec/isv-api-spec/docs/【长软】发票查验服务调用说明V4.0.16.pdf
   - 阅读章节: 3.2.3.{N}

3. **生成规范文档**:
   @/Users/qinqiang02/workspace/api_spec/isv-api-spec/docs/mappings/PROMPT_生成新发票映射表.md
   - 使用第三部分的完整模板

4. **参考示例**:
   @/Users/qinqiang02/workspace/api_spec/isv-api-spec/docs/mappings/01_增值税专用发票_字段映射表.md

## 生成要求

1. **严格遵守模板**: 使用规范文档中的完整模板结构
2. **完全自包含**: 除了引用2个通用文档外，所有内容必须完整
3. **字段映射完整**: 列出长软PDF中该类型的所有字段
4. **准确映射**: 仔细对比两个数据源，确保映射关系准确
5. **枚举完整**: 通用枚举引用文档，特有枚举详细列出
6. **特殊说明**: 详细说明该类型的特殊性和注意事项
7. **示例完整**: 提供真实的XML→JSON映射示例

## 特别注意

- ⚠️ 只引用2个通用文档：请求参数映射、枚举映射
- ⚠️ 响应字段映射必须完整，不引用其他文档
- ⚠️ 特有枚举必须详细列出（如机动车BBXX、航空ZWDJ等）
- ⚠️ 第六章"特殊性说明"必须根据业务特性详细填写
- ⚠️ 不需要代码示例和测试用例

## 输出

生成完整的markdown文档，保存为:
`/Users/qinqiang02/workspace/api_spec/isv-api-spec/docs/mappings/本公司{XX}_{发票类型名称}→长软{YY}.md`
```

### 方式2：快速Prompt（信息充足时）

```
基于以下文件生成发票类型{XX}的完整映射表：

数据源：
- @invoice_verification.apifox.json (#/definitions/{ID})
- @docs/【长软】发票查验服务调用说明V4.0.16.pdf (3.2.3.{N})
- @docs/mappings/PROMPT_生成新发票映射表.md (模板)
- @docs/mappings/01_增值税专用发票_字段映射表.md (参考)

要求：严格遵守规范文档第三部分的模板，完全自包含，只引用2个通用文档。

输出文件名：本公司{XX}_{中文名}→长软{YY}.md
```

---

## 五、常见发票类型速查

| 本公司代码 | 发票名称 | 长软代码 | 长软章节 | 本公司Schema ID | 明细结构 |
|----------|---------|---------|---------|----------------|---------|
| 01 | 增值税专用发票 | 01 | 3.2.3.1 | 231697053 | ✅ 有货物明细 |
| 02 | 货运专票 | 01 | 3.2.3.1 | 231697053 | ✅ 有货物明细 |
| 03 | 机动车发票 | 03 | 3.2.3.2 | 231697056 | 🚗 车辆信息 |
| 04 | 增值税普通发票 | 04 | 3.2.3.3 | 231697053 | ✅ 有货物明细 |
| 08 | 电子专票 | 20 | 3.2.3.8 | 231697053 | ✅ 有货物明细 |
| 10 | 电子普票 | 10 | 3.2.3.4 | 231697053 | ✅ 有货物明细 |
| 11 | 卷式发票 | 11 | 3.2.3.5 | 231697054 | ❌ 无明细 |
| 14 | 通行费发票 | 14 | 3.2.3.6 | 231697055 | 🚗 通行记录 |
| 15 | 二手车发票 | 15 | 3.2.3.7 | 231697057 | 🚗 交易信息 |
| 51 | 铁路客票 | 83 | 3.2.3.11 | 231697059 | 🚂 行程信息 |
| 61 | 航空客票 | 61 | 3.2.3.14 | 231697058 | ✈️ 航段信息 |
| 81 | 数电专票 | 09 | 3.2.3.9 | 231697052 | ✅ 有货物明细 |
| 82 | 数电普票 | 09 | 3.2.3.10 | 231697052 | ✅ 有货物明细 |
| 83 | 数电机动车 | 09 | 3.2.3.15 | 231697060 | 🚗 车辆信息 |
| 84 | 数电二手车 | 09 | 3.2.3.16 | 231697061 | 🚗 交易信息 |
| 85 | 数电纸质专票 | 09 | 3.2.3.12 | 231697052 | ✅ 有货物明细 |
| 86 | 数电纸质普票 | 09 | 3.2.3.13 | 231697052 | ✅ 有货物明细 |
| 87 | 数电纸质机动车 | 09 | 3.2.3.17 | 231697060 | 🚗 车辆信息 |
| 88 | 数电纸质二手车 | 09 | 3.2.3.18 | 231697061 | 🚗 交易信息 |
| F1 | 财政票据 | - | - | ? | ? |

---

## 六、质量检查清单 ✓

生成映射表后，请逐项检查：

- [ ] 文件名符合规范：`本公司{XX}_{中文名}→长软{YY}.md`
- [ ] 所有占位符`{XX}` `{YY}` `{N}` `{ID}`已替换
- [ ] 第二章字段映射表包含长软PDF该章节的所有字段
- [ ] 第三章明细映射根据实际情况正确填写或删除
- [ ] 第五章2通用枚举引用正确，特有枚举详细列出
- [ ] 第六章特殊性说明详细填写，不是模板占位符
- [ ] 第八章示例使用真实XML和JSON格式
- [ ] 所有表格格式正确，列对齐
- [ ] 所有代码块使用正确的语言标记（xml/json/javascript）
- [ ] 只引用了2个通用文档：请求参数、枚举映射

---

**文档结束 - 可直接在新会话中使用！** 🎉
