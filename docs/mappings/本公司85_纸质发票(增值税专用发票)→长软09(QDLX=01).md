# 本公司85_纸质发票(增值税专用发票)→长软09(QDLX=01) 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 85 - 纸质发票(增值税专用发票) / 数字化电子发票-纸质专票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"纸质发票(增值税专用发票)"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 85
- **长软发票类型代码**: 09 (数电发票)
- **长软数电发票类型**: QDLX=01 (纸质专票)
- **长软文档章节**: 3.2.3.9

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `85` | `09` | 长软数电发票统一类型代码 |
| 数电发票子类型 | - | `QDLX=01` | **关键**：长软用QDLX区分数电子类型 |
| 发票类型名称 | 纸质发票(增值税专用发票) | 数电发票(纸质专票) | |
| 数据结构定义 | `#/definitions/231697052` | `3.2.3.9` | 本定义也包含81/82/86类型 |
| 发票介质 | 纸质（数电发票打印版） | 纸质 | 有纸质发票代码和号码 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 纸质发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射，纸质票有12位发票代码 |
| `paper_invoice_no` | 纸质发票号码 | string(20) | - | - | - | **本公司独有**，存储纸质票号 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | 直接映射，数电纸质票号20位 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `buyer_name` | 购买方名称 | string(150) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方识别号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射 |
| `buyer_address` | 购买方地址 | string(300) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | **可能为空**，数电票简化 |
| `buyer_phone` | 购买方电话 | string(60) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | **可能为空**，需拆分 |
| `buyer_bank_name` | 购买方开户行 | string(120) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | **可能为空**，需拆分 |
| `buyer_account_number` | 购买方账号 | string(100) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | **可能为空**，需拆分 |
| `seller_name` | 销售方名称 | string(150) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_address` | 销货方地址 | string(250) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | **可能为空**，需拆分 |
| `seller_phone` | 销售方电话 | string(60) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | **可能为空**，需拆分 |
| `seller_bank_name` | 销售方开户行 | string(120) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | **可能为空**，需拆分 |
| `seller_account_number` | 销售方账号 | string(100) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | **可能为空**，需拆分 |
| - | - | - | `BODY/JE` | 金额合计 | VARCHAR2(32) | **长软独有**，本公司从items计算 |
| `total_tax_amount` | 合计税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `total_amount` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `amount_with_tax_in_words` | 价税合计(大写) | string(300) | - | - | - | **本公司独有**，需自行计算 |
| `remark` | 备注 | string(450) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/SDSJBZ` | 数电发票实际备注 | VARCHAR2(750) | **长软独有**，数电票特有备注 |
| - | - | - | `BODY/JQBH` | 机器编号 | VARCHAR2(16) | **长软字段为空**，数电票无税控设备 |
| - | - | - | `BODY/JYM` | 校验码 | VARCHAR2(32) | **长软字段为空**，数电票无校验码 |
| `invoice_status` | 发票状态 | 枚举 | `BODY/ZFBZ` | 作废标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | 废止，以TSPZBZ为准 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| - | - | - | `BODY/QDBZ` | 清单标志 | VARCHAR2(2) | **长软独有**，参见通用枚举 |
| - | - | - | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/HZDK` | 汇总代开标志 | VARCHAR2(2) | **长软独有**，参见通用枚举 |
| `issuer` | 开票人 | string(300) | - | - | - | **本公司独有**，数电票无此字段 |
| `reviewer` | 复核人姓名 | string(75) | `BODY/SDFHR` | 数电发票复核人 | VARCHAR2(150) | 直接映射，可空 |
| `payee` | 收款人姓名 | string(150) | `BODY/SDSKR` | 数电发票收款人 | VARCHAR2(150) | 直接映射，可空 |
| `is_blue_invoice` | 蓝字/红字标识 | 枚举(Y/N) | - | - | - | **本公司独有**，从ZFBZ推断 |
| `original_blue_invoice_no` | 对应蓝字发票号码 | string(20) | - | - | - | **本公司独有**，红票时填写 |
| `original_blue_paper_invoice_code` | 对应蓝字纸质发票代码 | string(12) | - | - | - | **本公司独有**，红票时填写 |
| `original_blue_paper_invoice_no` | 对应蓝字纸质发票号码 | string(20) | - | - | - | **本公司独有**，红票时填写 |
| `seller_taxpayer_type_code` | 销方纳税人类型代码 | string | - | - | - | **本公司独有**，1=一般纳税人 |
| `item_count` | 明细条数 | integer | - | - | - | **本公司独有**，items数组长度 |
| `deduction_amount` | 扣除额 | number(18,2) | - | - | - | **本公司独有**，差额征税扣除额 |
| `settlement_method_code` | 结算方式 | string(2) | - | - | - | **本公司独有** |
| `vat_immediate_refund_code` | 增值税即征即退代码 | string(2) | - | - | - | **本公司独有** |
| `export_tax_refund_type_code` | 出口退税类代码 | string(2) | - | - | - | **本公司独有** |
| `refined_oil_abnormal_flag` | 成品油异常标识 | string(1) | - | - | - | **本公司独有**，9=正常 |
| `invoice_category_code` | 发票票种代码 | string | - | - | - | **本公司独有** |
| `special_element_type_code` | 特定要素类型代码 | string | - | - | - | **本公司独有** |
| - | - | - | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算
- **可能为空**: 数电票特性可能导致长软返回空值

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `paper_invoice_no` | 映射得出 | 将FPHM映射到纸质发票号码字段 |
| `original_blue_paper_invoice_code` | 业务系统 | 红字发票对应的原蓝字纸质发票代码 |
| `original_blue_paper_invoice_no` | 业务系统 | 红字发票对应的原蓝字纸质发票号码 |
| `amount_with_tax_in_words` | 计算得出 | 将total_amount数字转换为中文大写 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `is_blue_invoice` | 推断得出 | 根据ZFBZ判断：0/1→Y(蓝字)，3/7/8→N(红字) |
| `original_blue_invoice_no` | 业务系统 | 红字发票对应的原蓝字发票号，从业务系统获取 |
| `seller_taxpayer_type_code` | 业务规则 | 数电纸质专票一般都是一般纳税人开具，固定为"1" |
| `deduction_amount` | 计算得出 | 差额征税时的扣除额，从items中计算 |
| `issuer` | - | 数电票无开票人字段，返回null |
| `refined_oil_abnormal_flag` | 业务规则 | 成品油异常标识，非成品油票固定为"9" |
| `invoice_category_code` | 业务规则 | 发票票种代码，根据业务规则设置 |
| `special_element_type_code` | 业务规则 | 特定要素类型代码 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**:
- ✅ **数电纸质专票有货物明细结构**
- 明细数据记录货物或应税劳务的详细信息
- 一张发票可以有多个明细行
- 数电纸质票明细字段与数电专票（81）完全一致

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 序号 | integer | - | - | - | **本公司独有**，用于排序 |
| `name` / `goods_or_service_name` | 货物或应税劳务名称 | string(300/600) | `HWMC` | 货物或应税劳务名称 | VARCHAR2(320) | 直接映射 |
| `specification` | 规格型号 | string(150) | `GGXH` | 规格型号 | VARCHAR2(64) | 直接映射 |
| `unit` | 单位 | string(300) | `DW` | 单位 | VARCHAR2(52) | 直接映射 |
| `quantity` | 发票交易数量 | string(25) | `SL` | 数量 | VARCHAR2(25) | 直接映射 |
| `unit_price` | 发票交易单价 | string(25) | `DJ` | 单价 | VARCHAR2(25) | 直接映射 |
| `amount` | 金额 | number(8,2) | `JE` | 金额 | NUMBER(20,2) | 直接映射 |
| `tax_rate` | 税率 | number(6,6) | `SLV` | 税率 | NUMBER(8,5) | 直接映射 |
| `tax_amount` | 税额 | number(8,6) | `SE` | 税额 | NUMBER(20,2) | 直接映射 |
| `tax_classification_code` | 商品税收分类编码 | string(19) | - | - | - | **本公司独有** |
| `deduction_amount` | 扣除额 | number(8,2) | - | - | - | **本公司独有**，差额征税 |
| `item_short_name` | 商品服务简称 | string(120) | - | - | - | **本公司独有** |
| `product_barcode` | 商品条码 | string(300) | - | - | - | **本公司独有** |

**说明**：
- 长软API中明细字段的金额、税额、税率都是NUMBER类型，可以直接映射
- 其他字段（数量、单价）都是字符串类型
- 本公司独有字段需要从业务系统或Apifox定义中获取
- 数电纸质专票的明细结构与数电专票（81）完全一致

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**：
```javascript
// 长软 → 本公司
function formatDate(yyyymmdd) {
  if (!yyyymmdd || yyyymmdd.length !== 8) return null;
  return `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`;
}
// 示例: "20251230" → "2025-12-30"
```

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额合计 | 本公司从items计算 | `VARCHAR2(32)` 字符串 | 长软JE字段存在但本公司不使用 |
| 税额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细金额 | `number` (8,2) | `NUMBER(20,2)` | 类型一致，直接映射 |
| 明细税额 | `number` (8,6) | `NUMBER(20,2)` | 精度不同，注意转换 |
| 明细税率 | `number` (6,6) | `NUMBER(8,5)` | 精度不同，注意转换 |

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 20 | ✅ 长度一致，数电纸质票号20位 |
| invoice_code | 12 | 20 | ✅ 纸质票代码12位，长软更宽松 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需注意截断 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **作废标志** (ZFBZ → invoice_status)
- **特殊票种标志** (TSPZBZ → special_invoice_type)
- **清单标志** (QDBZ)
- **汇总代开标志** (HZDK)

### 5.2 数电纸质专票特有枚举映射

⚠️ **重要**: 数电纸质专票**没有特有枚举**，所有枚举都使用通用枚举映射。

但需要注意以下特殊情况：

#### 5.2.1 发票类型区分 (QDLX)

数电发票统一使用长软类型代码09，通过QDLX字段区分子类型：

| QDLX值 | 含义 | 本公司发票类型 |
|-------|------|--------------|
| 01 | 数电纸质专票 | 85 |
| 04 | 数电纸质普票 | 86 |
| 20 | 数电专票（电子） | 81 |
| 10 | 数电普票（电子） | 82 |
| 03 | 数电机动车（电子） | 83 |
| 15 | 数电二手车（电子） | 84 |

**说明**：
- 长软在消息头 `HEAD/QDLX` 返回此字段
- **本映射表仅处理QDLX=01（数电纸质专票）**
- 其他QDLX值应路由到对应的映射表

#### 5.2.2 发票状态的特殊性

数电纸质发票的发票状态（ZFBZ）与传统发票一致：

| ZFBZ值 | 含义 | 说明 |
|-------|------|------|
| 0 或 1 | 正常 | 数电纸质票正常状态 |
| 2 | 作废 | 数电票作废（很少见） |
| 3 | 红冲 | 红字发票（数电票常用） |
| 7 | 部分红冲 | 部分红字 |
| 8 | 全额红冲 | 全额红字 |

**数电纸质票的特殊性**：
- 数电纸质票同样很少使用"作废"（ZFBZ=2），通常使用"红冲"（ZFBZ=3）
- 红字数电纸质票会在 `original_blue_invoice_no` 等字段中记录被红冲的蓝字发票信息

---

## 六、数电纸质专票特殊性说明

### 6.1 该类型的独特特性

1. **有发票代码**
   - 数电纸质专票**有12位发票代码**（FPDM）
   - 这是与纯电子数电专票（81）的最大区别
   - 纸质版本通过打印输出，具有纸质发票的外观

2. **有纸质发票号码字段**
   - `paper_invoice_no` 字段存储纸质票号
   - 与 `invoice_number` 字段内容相同，都是20位发票号码
   - 这是数电发票体系的特殊设计

3. **发票号码20位**
   - 不同于传统专票（01）的8位发票号码
   - 与数电电子专票（81）的号码长度一致
   - 发票代码仍为12位

4. **无校验码**
   - 数电纸质专票**没有校验码**字段（JYM为空）
   - 防伪验证依赖数电发票体系的电子签名
   - 虽然有纸质形态，但仍属于数电发票体系

5. **无税控设备信息**
   - **没有机器编号**（JQBH为空）
   - 数电票通过电子税务局开具，打印输出为纸质
   - 不依赖传统税控设备

6. **四方信息可能简化**
   - 长软返回的 `GFDZDH`、`GFYHZH`、`XFDZDH`、`XFYHZH` **可能为空**
   - 数电票不强制要求地址电话、开户行账号信息
   - 即使是纸质打印版，四方信息也可能简化

7. **可抵扣进项税**
   - 数电纸质专票与传统专票、数电电子专票效力相同
   - 可以抵扣进项税额
   - 一般纳税人取得数电纸质专票可按票面税额抵扣

8. **必须有货物明细**
   - 数电纸质专票必须包含货物或应税劳务明细
   - CHILDLIST不能为空
   - 每个明细行需要包含完整的税率、税额信息

9. **红字发票处理**
   - 数电纸质票很少作废，通常通过开具红字发票冲销
   - 红字发票需要记录对应的原蓝字发票号码及纸质发票信息

10. **数电特有字段**
    - `SDSKR`（数电发票收款人）：可空
    - `SDFHR`（数电发票复核人）：可空
    - `SDSJBZ`（数电发票实际备注）：可空，可能与BZ不同

### 6.2 与其他类型的区别

| 特性 | 数电纸质专票(85) | 数电专票(81) | 增值税专用发票(01) | 电子专票(08) |
|------|----------------|-------------|------------------|-------------|
| 发票代码 | ✅ 12位 | ❌ 无 | ✅ 12位 | ✅ 12位 |
| 发票号码 | ✅ 20位 | ✅ 20位 | ✅ 8位 | ✅ 8位 |
| 校验码 | ❌ 无 | ❌ 无 | ❌ 无 | ❌ 无 |
| 抵扣 | ✅ 可抵扣 | ✅ 可抵扣 | ✅ 可抵扣 | ✅ 可抵扣 |
| 明细结构 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 |
| 四方信息 | ⚠️ 可能简化 | ⚠️ 简化 | ✅ 完整 | ✅ 完整 |
| 发票介质 | 纸质（打印） | 电子 | 纸质 | 电子 |
| 长软类型码 | 09 (QDLX=01) | 09 (QDLX=20) | 01 | 20 |
| 税控设备 | ❌ 无 | ❌ 无 | ✅ 有 | ✅ 有 |
| 所属体系 | 数电发票 | 数电发票 | 传统发票 | 传统电子发票 |

**关键区别总结**：
- **85 vs 81**：85有纸质代码，81无代码；85是纸质打印，81是纯电子
- **85 vs 01**：85号码20位无校验码，01号码8位无校验码；85属数电体系，01属传统体系
- **85 vs 08**：85属数电体系无税控设备，08属传统电子发票体系有税控设备

### 6.3 特殊处理逻辑

#### 6.3.1 发票类型识别

由于长软对所有数电票统一返回类型码09，必须通过QDLX区分：

**处理流程**:
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 根据QDLX路由：
   - QDLX=01 → 使用本映射表（数电纸质专票）
   - QDLX=20 → 路由到数电专票映射表（81）
   - QDLX=10 → 路由到数电普票映射表（82）
   - QDLX=04 → 路由到数电纸质普票映射表（86）
   - 其他值 → 返回不支持的数电类型错误

**业务背景**：
- 数电发票是中国税务总局推出的全电发票
- 纸质版是数电发票的打印输出形式，具有与电子版相同的法律效力
- 长软系统将所有数电发票归为一个大类（09），通过QDLX细分
- 本公司API需要将数电纸质专票映射为独立类型（85）

#### 6.3.2 发票代码与号码的映射

数电纸质专票同时有代码和号码，需要特殊处理：

**映射规则**：
1. `invoice_code` ← `BODY/FPDM`（12位发票代码）
2. `invoice_number` ← `BODY/FPHM`（20位发票号码）
3. `paper_invoice_no` ← `BODY/FPHM`（与invoice_number相同）

**唯一标识**：
- 数电纸质专票的唯一标识：(invoice_code + invoice_number)
- 与传统专票相同，需要代码+号码组合查询
- 与数电电子专票不同，数电电子专票只需号码

#### 6.3.3 四方信息处理

数电纸质票的四方信息可能简化，需要特殊处理：

**处理策略**：
1. **接受可能的空值**：
   - buyer_address、buyer_phone可能为null
   - seller_address、seller_phone可能为null
   - buyer_bank_name、buyer_account_number可能为null
   - seller_bank_name、seller_account_number可能为null

2. **字段拆分**：
   - `GFDZDH` 包含地址和电话，需拆分为 `buyer_address` 和 `buyer_phone`
   - `XFDZDH` 包含地址和电话，需拆分为 `seller_address` 和 `seller_phone`
   - `GFYHZH` 包含开户行和账号，需拆分为 `buyer_bank_name` 和 `buyer_account_number`
   - `XFYHZH` 包含开户行和账号，需拆分为 `seller_bank_name` 和 `seller_account_number`

3. **业务规则补全**（可选）：
   - 如果业务系统已有购销双方完整信息，可从业务系统补全
   - 如果无法补全，返回null，不影响查验结果

**注意事项**：
- 不要因为四方信息缺失而认为查验失败
- 数电票的简化是税务总局的政策要求，属于正常现象
- 只要购销双方名称和税号一致即可

#### 6.3.4 红字发票处理

数电纸质票的红字处理逻辑：

**处理流程**:
1. **识别红字发票**：
   - 检查 `ZFBZ` 是否为 3/7/8
   - 设置 `is_blue_invoice = 'N'`

2. **记录原票信息**（需要业务系统支持）：
   - `original_blue_invoice_no`: 原蓝字发票号码（20位）
   - `original_blue_paper_invoice_code`: 原蓝字纸质发票代码（12位）
   - `original_blue_paper_invoice_no`: 原蓝字纸质发票号码（20位）
   - 建立红蓝字发票关联关系

3. **红字列表处理**：
   - 长软09类型暂不返回红字列表（HZLIST）
   - 需要从业务系统维护红蓝字关系

**业务背景**：
- 数电纸质票不支持作废，只能通过红字发票冲销
- 一张蓝字发票可能对应多张部分红字发票
- 需要建立完整的红蓝字发票链条追踪机制

#### 6.3.5 明细数据完整性验证

**验证逻辑**：
1. **金额验证**：
   - 价税合计 = 金额合计 + 税额合计
   - 允许2分钱的误差

2. **明细汇总验证**：
   - 汇总明细金额 = 金额合计
   - 汇总明细税额 = 税额合计

3. **税率一致性**：
   - 每个明细的税率应在合理范围内（0%, 1%, 3%, 5%, 6%, 9%, 13%等）

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（但本公司API可选）:
- 无特殊要求

**本公司API要求必填**（但长软API可选）:
- `invoice_code` (纸质发票代码) - 必填，12位数字
- `invoice_number` (发票号码) - 必填，20位数字
- `paper_invoice_no` (纸质发票号码) - 必填，与invoice_number相同
- `seller_name` (销售方名称) - 必填
- `buyer_name` (购买方名称) - 必填
- `total_amount` (价税合计) - 必填
- `total_tax_amount` (合计税额) - 必填
- `amount_with_tax_in_words` (价税合计大写) - 必填，需自行计算
- `is_blue_invoice` (蓝字/红字标识) - 必填，从ZFBZ推断
- `invoice_status` (发票状态) - 必填，从ZFBZ映射

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_code | 12 | 20 | ✅ 长软更宽松，纸质票代码12位足够 |
| invoice_number | 20 | 20 | ✅ 长度一致，数电纸质票号20位 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |
| seller_name | 150 | 300 | ⚠️ 长软更大，需截断超长名称 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数
- `CYSJ` (查验时间) - 长软查验时间戳
- `JE` (金额合计) - 长软返回，本公司从items计算
- `JQBH` (机器编号) - 数电票为空
- `JYM` (校验码) - 数电票为空
- `GFDZDH` (购方地址电话) - 可能为空
- `GFYHZH` (购方开户行账号) - 可能为空
- `XFDZDH` (销方地址电话) - 可能为空
- `XFYHZH` (销方开户行账号) - 可能为空
- `QDBZ` (清单标志) - 是否有销货清单
- `HZDK` (汇总代开标志) - 是否汇总代开
- `SDSJBZ` (数电发票实际备注) - 数电票特有备注

**本公司独有字段**（需从其他数据源获取）:
- `paper_invoice_no` (纸质发票号码) - 从FPHM映射
- `original_blue_paper_invoice_code` (原蓝字纸质发票代码) - 从业务系统获取
- `original_blue_paper_invoice_no` (原蓝字纸质发票号码) - 从业务系统获取
- `amount_with_tax_in_words` (价税合计大写) - 从total_amount计算
- `item_count` (明细条数) - 从items数组长度计算
- `is_blue_invoice` (蓝字/红字标识) - 从ZFBZ推断
- `original_blue_invoice_no` (原蓝字发票号) - 从业务系统获取
- `issuer` (开票人) - 数电票无此字段
- `seller_taxpayer_type_code` (销方纳税人类型) - 固定为"1"（一般纳税人）
- `deduction_amount` (扣除额) - 从items计算
- `settlement_method_code` (结算方式) - 从业务系统获取
- `vat_immediate_refund_code` (即征即退代码) - 从业务系统获取
- `export_tax_refund_type_code` (出口退税类代码) - 从业务系统获取
- `refined_oil_abnormal_flag` (成品油异常标识) - 非成品油固定为"9"
- `tax_classification_code` (商品税收分类编码) - 从业务系统获取
- `invoice_category_code` (发票票种代码) - 从业务规则设置
- `special_element_type_code` (特定要素类型代码) - 从业务规则设置

### 7.4 数电纸质专票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 发票类型路由

**挑战**：长软对所有数电票统一返回类型码09，需要根据QDLX路由到正确的处理器。

**解决方案**：
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 根据QDLX路由：
   - QDLX=01 → 使用本映射表（数电纸质专票）
   - QDLX=20 → 路由到数电专票映射表（81）
   - QDLX=10 → 路由到数电普票映射表（82）
   - QDLX=04 → 路由到数电纸质普票映射表（86）
   - 其他值 → 返回不支持的数电类型错误

**业务背景**：
- 数电发票纸质版是通过数电发票平台开具后打印输出
- 纸质版与电子版具有相同的法律效力
- 长软系统将所有数电发票归为一个大类（09），通过QDLX细分
- 本公司API需要将数电纸质专票映射为独立类型（85）

#### 7.4.2 发票唯一标识

**挑战**：数电纸质票既有代码又有号码，如何设计唯一标识？

**解决方案**：
1. **存储策略**：
   - invoice_code: 12位发票代码（主键之一）
   - invoice_number: 20位发票号码（主键之一）
   - paper_invoice_no: 20位纸质发票号码（与invoice_number相同）
   - invoice_type: "85"（标识为数电纸质专票）

2. **查询策略**：
   - 用户查验时需提供发票代码+发票号码
   - 开票日期和金额作为辅助验证
   - 不需要提供校验码（数电票无校验码）

3. **去重策略**：
   - 以 (invoice_code, invoice_number, invoice_type) 作为唯一键
   - 同一张数电纸质票的多次查验应能识别为同一张票

**对比**：
- 传统专票（01）：代码12位+号码8位，无校验码
- 数电纸质专票（85）：代码12位+号码20位，无校验码
- 数电电子专票（81）：无代码+号码20位，无校验码

#### 7.4.3 四方信息缺失处理

**挑战**：数电纸质票的四方信息可能简化，长软返回的地址电话、开户行账号可能为空。

**解决方案**：
1. **接受空值**：buyer_address、buyer_phone等字段返回null
2. **字段拆分**：
   - `GFDZDH` → 拆分为 `buyer_address` 和 `buyer_phone`
   - `XFDZDH` → 拆分为 `seller_address` 和 `seller_phone`
   - `GFYHZH` → 拆分为 `buyer_bank_name` 和 `buyer_account_number`
   - `XFYHZH` → 拆分为 `seller_bank_name` 和 `seller_account_number`
3. **业务规则补全**（可选）：
   - 如果业务系统已有购销双方完整信息，可从业务系统补全
   - 如果无法补全，返回null，不影响查验结果

**注意事项**：
- 不要因为四方信息缺失而认为查验失败
- 数电票的简化是税务总局的政策要求，属于正常现象
- 只要购销双方名称和税号一致即可

#### 7.4.4 红字发票链条追踪

**挑战**：数电纸质票红字发票需要追踪原蓝字发票的完整信息。

**解决方案**：
1. **识别红字发票**：
   - 检查 `ZFBZ` 是否为 3/7/8
   - 设置 `is_blue_invoice = 'N'`

2. **记录原票信息**（需要业务系统支持）：
   - `original_blue_invoice_no`: 原蓝字发票号码（20位）
   - `original_blue_paper_invoice_code`: 原蓝字纸质发票代码（12位）
   - `original_blue_paper_invoice_no`: 原蓝字纸质发票号码（20位）
   - 建立红蓝字发票关联关系

3. **红字列表处理**：
   - 长软09类型暂不返回红字列表（HZLIST）
   - 需要从业务系统维护红蓝字关系

**业务背景**：
- 数电纸质票不支持作废，只能通过红字发票冲销
- 一张蓝字发票可能对应多张部分红字发票
- 需要建立完整的红蓝字发票链条追踪机制
- 纸质版与电子版的红冲机制一致

#### 7.4.5 明细数据完整性验证

**挑战**：确保明细数据与汇总数据一致。

**解决方案**：
1. **金额验证**：
   - 验证：价税合计 = 金额合计 + 税额合计
   - 允许2分钱的误差

2. **明细汇总验证**：
   - 汇总明细金额应等于金额合计
   - 汇总明细税额应等于税额合计

3. **税率一致性检查**：
   - 每个明细的税率应在合理范围内

#### 7.4.6 纸质与电子版本的关系处理

**挑战**：数电纸质票是数电发票的打印输出，如何处理与电子版的关系？

**解决方案**：
1. **独立处理**：
   - 数电纸质票（85）与数电电子票（81）作为独立的发票类型处理
   - 虽然同属数电体系，但介质不同，类型代码不同

2. **关联识别**（可选）：
   - 如果业务需要识别同一张数电发票的纸质版和电子版
   - 可以通过发票号码建立关联（纸质版和电子版的发票号码相同）
   - 但发票代码不同：纸质版有代码，电子版无代码

3. **法律效力**：
   - 纸质版和电子版具有相同的法律效力
   - 不需要同时保存纸质版和电子版
   - 任选其一即可用于财务记账和抵扣

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697052)
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf` (第13-14页，3.2.3.9节)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 数电专票映射表: `本公司81_数电专票→长软09(QDLX=20).md` (相关参考)
6. 国家税务总局全电发票平台: https://etax.chinatax.gov.cn/

---

**文档结束**
