# 本公司11_增值税普通发票（卷式）→长软11 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 11 - 增值税普通发票（卷式）

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"增值税普通发票（卷式）"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 11
- **长软发票类型代码**: 11
- **长软文档章节**: 3.2.3.5

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `11` | `11` | 一致 |
| 发票类型名称 | 增值税普通发票（卷式） | 增值税普通发票（卷式） | |
| 数据结构定义 | `verification_data` | `3.2.3.5` | |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `seller_name` | 销售方名称 | string(300) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSH` | 销方纳税人识别号 | VARCHAR2(64) | 直接映射 |
| `buyer_name` | 购买方名称 | string(300) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方税号 | string(20) | `BODY/GFSH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射 |
| `amount_including_tax` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：number ← string |
| `remark` | 备注 | string(610) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| `verification_code` | 校验码 | string(32) | `BODY/JYM` | 校验码 | VARCHAR2(32) | 直接映射 |
| - | - | - | `BODY/JQBH` | 机器编号 | VARCHAR2(16) | **长软独有**，税控设备编号 |
| - | - | - | `BODY/SHY` | 收款员 | VARCHAR2(20) | **长软独有**，收款员信息 |
| `invoice_status` | 发票状态 | string(1) | `BODY/ZFBZ` | 作废标志 | CHAR(1) | 枚举映射，见通用说明 |
| `special_invoice_type` | 特殊票种 | string(2) | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | 枚举映射，见通用说明 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | **长软独有**，废止字段 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，查验次数统计 |
| `void_date` | 作废日期 | string(19) | - | - | - | **本公司独有**，从业务系统获取 |
| `tax_payer_id` | 报税纳税人识别号 | string(20) | - | - | - | **本公司独有**，纳税人系统标识 |
| `invoice_status_flag` | 发票状态标志 | string(1) | - | - | - | **本公司独有**，状态标志 |
| `amount_excluding_tax` | 合计金额(不含税) | number(18,2) | - | - | - | **本公司独有**，从明细汇总计算 |
| `tax_amount` | 合计税额 | number(18,2) | - | - | - | **本公司独有**，从明细汇总计算 |
| `tax_rate` | 税率 | number(8,5) | - | - | - | **本公司独有**，从明细取值或计算 |
| `item_count` | 明细条数 | integer | - | - | - | **本公司独有**，items数组长度 |
| `non_taxable_amount` | 不征税金额 | number(18,2) | - | - | - | **本公司独有**，业务计算 |
| `seller_address_phone` | 销售方地址电话 | string(120) | - | - | - | **本公司独有**，卷式发票无此信息 |
| `seller_bank_account` | 销售方银行账号 | string(120) | - | - | - | **本公司独有**，卷式发票无此信息 |
| `buyer_address_phone` | 购买方地址电话 | string(120) | - | - | - | **本公司独有**，卷式发票无此信息 |
| `buyer_bank_account` | 购买方银行账号 | string(120) | - | - | - | **本公司独有**，卷式发票无此信息 |
| `proxy_seller_name` | 代开发票真实销售方名称 | string(300) | - | - | - | **本公司独有**，代开场景使用 |
| `proxy_seller_tax_no` | 代开发票真实销售方识别号 | string(20) | - | - | - | **本公司独有**，代开场景使用 |
| `taxation_voucher` | 完税凭证号 | string(200) | - | - | - | **本公司独有**，完税凭证信息 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **枚举映射**: 需要进行枚举值映射
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `amount_excluding_tax` | 计算得出 | 从items明细中汇总所有amount（不含税金额） |
| `tax_amount` | 计算得出 | 从items明细中汇总所有tax_amount（税额） |
| `tax_rate` | 计算得出 | 取items中第一个非零税率，或计算加权平均税率 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `void_date` | 业务系统 | 从企业业务系统获取，长软只返回ZFBZ标志 |
| `non_taxable_amount` | 业务计算 | 根据TSPZBZ特殊票种标志计算不征税金额 |
| `seller_address_phone` | 默认空 | 卷式发票不包含销方地址电话信息，返回空字符串 |
| `seller_bank_account` | 默认空 | 卷式发票不包含销方银行账号信息，返回空字符串 |
| `buyer_address_phone` | 默认空 | 卷式发票不包含购方地址电话信息，返回空字符串 |
| `buyer_bank_account` | 默认空 | 卷式发票不包含购方银行账号信息，返回空字符串 |
| `proxy_seller_name` | 业务规则 | 当发票为代开时，从备注或特定标识解析 |
| `proxy_seller_tax_no` | 业务规则 | 当发票为代开时，从备注或特定标识解析 |
| `taxation_voucher` | 默认空 | 卷式发票通常无完税凭证号 |
| `tax_payer_id` | 业务系统 | 查验企业的纳税人识别号 |
| `invoice_status_flag` | 映射转换 | 根据ZFBZ映射为本公司的状态标志 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**: 卷式发票的明细结构较为简化
- ✅ 该发票类型有货物明细结构
- ⚠️ 卷式发票明细信息较少，仅包含：项目、数量、含税单价、含税金额
- ⚠️ 长软返回的是含税金额和含税单价，本公司需计算不含税金额和税额

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 明细序号 | integer | - | - | - | **本公司独有**，用于排序，从1开始递增 |
| `name` | 项目 | string(310) | `XM` | 项目 | VARCHAR2(160) | 直接映射 |
| `quantity` | 数量 | string(25) | `SL` | 数量 | VARCHAR2(25) | 直接映射 |
| `unit_price_with_tax` | 含税单价 | number(18,2) | `HSDJ` | 含税单价 | VARCHAR2(32) | 类型转换：number ← string |
| `total_amount` | 含税金额 | number(18,2) | `HSJE` | 含税金额 | VARCHAR2(32) | 类型转换：number ← string |
| `unit_price` | 不含税单价 | number(18,2) | - | - | - | **本公司独有**，计算：含税单价 / (1 + 税率) |
| `amount` | 不含税金额 | number(18,2) | - | - | - | **本公司独有**，计算：含税金额 / (1 + 税率) |
| `tax_rate` | 税率 | number(8,5) | - | - | - | **本公司独有**，从主表获取或默认值 |
| `tax_amount` | 税额 | number(18,2) | - | - | - | **本公司独有**，计算：不含税金额 × 税率 |
| `product_code` | 商品编码 | string(20) | - | - | - | **本公司独有**，卷式发票无商品编码 |

**字段计算说明**：
- 卷式发票长软只返回含税单价和含税金额
- 本公司需根据税率反推不含税金额和税额
- 计算公式：
  - 不含税金额 = 含税金额 / (1 + 税率)
  - 税额 = 不含税金额 × 税率
  - 不含税单价 = 含税单价 / (1 + 税率)

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换逻辑**：
- 长软→本公司：将8位字符串转为带横杠格式，如 20251230 → 2025-12-30
- 本公司→长软：去除横杠，如 2025-12-30 → 20251230

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 本公司→长软: `.toString()`<br>长软→本公司: `parseFloat()` |
| 含税单价 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 同上 |
| 含税金额 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 同上 |
| 数量 | `string` (25) | `VARCHAR2(25)` 字符串 | 直接映射，保持字符串格式 |

### 4.3 卷式发票特殊计算

由于卷式发票长软API只返回含税金额，本公司需要进行反算：

1. **获取税率**：
   - 从主表`tax_rate`字段获取（如果已计算）
   - 或使用默认税率（通常卷式发票为3%或免税）
   - 根据`TSPZBZ`特殊票种标志判断

2. **计算不含税金额**：
   ```
   不含税金额 = 含税金额 / (1 + 税率)
   ```

3. **计算税额**：
   ```
   税额 = 不含税金额 × 税率
   ```

4. **精度处理**：
   - 保留2位小数
   - 汇总时可能存在尾差，需处理

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **作废标志** (ZFBZ → invoice_status)
- **特殊票种标志** (TSPZBZ → special_invoice_type)
- CPYBZ（成品油标志，已废止）

### 5.2 卷式发票无特有枚举

卷式发票不包含特殊的枚举字段，所有枚举均使用通用枚举映射。

---

## 六、卷式发票特殊性说明

### 6.1 卷式发票的独特特性

1. **简化的发票格式**：
   - 卷式发票是最简化的增值税普通发票
   - 通常用于小额零售、餐饮、出租车等行业
   - 采用卷筒式连续打印

2. **字段信息较少**：
   - 无购销双方地址电话、开户行账号信息
   - 无机器编号（JQBH）信息
   - 明细仅包含项目名称、数量、含税单价、含税金额

3. **含校验码**：
   - 与增值税普通发票（04、10）一样，有校验码（JYM）
   - 校验码为发票查验的重要验证字段

4. **收款员信息**：
   - 长软返回收款员（SHY）字段
   - 本公司API未包含此字段，可忽略或扩展

5. **可能为定额发票**：
   - 部分卷式发票为定额发票
   - 定额发票通常只有固定金额，无明细

6. **税额计算方式**：
   - 长软只返回含税金额，不返回税额和不含税金额
   - 需根据税率反算

### 6.2 与其他类型的区别

| 特性 | 卷式发票(11) | 增值税普通发票(04) | 增值税专用发票(01) |
|------|-------------|-------------------|-------------------|
| 校验码 | 有 | 有 | 无 |
| 抵扣 | 不可抵扣 | 不可抵扣 | 可抵扣 |
| 地址电话 | 无 | 有 | 有 |
| 开户行账号 | 无 | 有 | 有 |
| 明细信息 | 简化（含税） | 完整（含税+不含税） | 完整（不含税） |
| 使用场景 | 小额零售 | 一般销售 | B2B销售 |
| 机器编号 | 有（SHY收款员） | 有（JQBH） | 有（JQBH） |

### 6.3 特殊处理逻辑

**处理流程**：

1. **接收长软XML响应**：
   - 解析XML，提取BODY节点
   - 获取发票主信息和CHILDLIST明细

2. **处理主信息**：
   - 直接映射基本字段（发票代码、号码、日期等）
   - 处理枚举字段（ZFBZ、TSPZBZ）
   - 将长软空缺字段设为null或空字符串

3. **处理明细信息**：
   ```
   对每个CHILD明细：
   a. 获取XM（项目）、SL（数量）、HSDJ（含税单价）、HSJE（含税金额）
   b. 确定税率（从主表或默认值）
   c. 计算不含税金额 = HSJE / (1 + 税率)
   d. 计算税额 = 不含税金额 × 税率
   e. 计算不含税单价 = HSDJ / (1 + 税率)
   f. 添加sequence_no序号
   ```

4. **汇总计算**：
   ```
   a. 汇总所有明细的不含税金额 → amount
   b. 汇总所有明细的税额 → tax_amount
   c. 统计明细数量 → item_count
   d. 价税合计已在主表JSHJ，直接映射
   ```

5. **验证数据一致性**：
   ```
   验证：amount + tax_amount ≈ total_amount（允许小额尾差）
   ```

6. **返回JSON响应**：
   - 组装本公司API的verification_data对象
   - 返回给用户

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（卷式发票查验时）:
- FPDM（发票代码）
- FPHM（发票号码）
- KPRQ（开票日期）
- JYM（校验码） ⚠️ **卷式发票必须提供校验码**

**本公司API要求必填**（但长软API可选）:
- 无额外必填字段

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 10 | ⚠️ 本公司长度更大，但卷式发票号码8位，足够 |
| seller_tax_no | 20 | 64 | ✅ 长软更大，中国税号18位，20位足够 |
| name（项目） | 310 | 160 | ⚠️ 本公司长度更大，但需注意长软返回可能截断 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数，可忽略
- `CYSJ` (查验时间) - 长软查验时间戳，可忽略
- `JQBH` (机器编号) - 税控设备编号，本公司未返回
- `SHY` (收款员) - 收款员信息，本公司未返回
- `CPYBZ` (成品油标志) - 已废止字段，可忽略

**本公司独有字段**（需从其他数据源获取或计算）:
- `amount` (金额) - **从明细汇总计算**
- `tax_amount` (税额) - **从明细汇总计算**
- `tax_rate` (税率) - **从明细取值或计算**
- `item_count` (明细条数) - **计算items数组长度**
- `void_date` (作废日期) - 从业务系统获取
- `seller_address_phone` (销方地址电话) - **卷式发票无此信息，返回空**
- `seller_bank_account` (销方银行账号) - **卷式发票无此信息，返回空**
- `buyer_address_phone` (购方地址电话) - **卷式发票无此信息，返回空**
- `buyer_bank_account` (购方银行账号) - **卷式发票无此信息，返回空**
- `proxy_seller_name` (代开销方) - 从备注或业务规则解析
- `proxy_seller_tax_no` (代开销方税号) - 从备注或业务规则解析
- `taxation_voucher` (完税凭证号) - 通常为空
- `tax_payer_id` (报税纳税人识别号) - 从业务系统获取
- `invoice_status_flag` (发票状态标志) - 根据ZFBZ映射
- `non_taxable_amount` (不征税金额) - 根据TSPZBZ计算

### 7.4 卷式发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 税额反算的准确性

**问题**：长软只返回含税金额，需反算不含税金额和税额，可能存在精度问题。

**解决方案**：
1. 使用高精度decimal计算，避免浮点误差
2. 按照税务规则进行四舍五入
3. 允许汇总时存在合理的尾差（通常≤0.05元）
4. 验证：`汇总不含税金额 + 汇总税额 ≈ 价税合计`

#### 7.4.2 税率的确定

**问题**：长软不返回税率，如何确定明细税率？

**解决方案**：
1. **优先级1**：如果能从发票代码或号码识别发票性质，使用对应税率
2. **优先级2**：根据TSPZBZ特殊票种标志判断
   - 成品油发票：通常13%或9%
   - 免税：0%
   - 其他：根据业务场景默认税率（如3%）
3. **优先级3**：使用业务配置的默认税率
4. **建议**：提供税率配置功能，允许业务方自定义

#### 7.4.3 定额发票的处理

**问题**：部分卷式发票为定额发票，可能无明细或明细为空。

**解决方案**：
1. 如果CHILDLIST为空或无CHILD节点
2. 创建一个默认明细项：
   ```json
   {
     "sequence_no": 1,
     "name": "定额发票",
     "quantity": "1",
     "unit_price_with_tax": total_amount,
     "total_amount": total_amount,
     "unit_price": 计算值,
     "amount": 计算值,
     "tax_rate": 默认税率,
     "tax_amount": 计算值
   }
   ```

#### 7.4.4 校验码的必要性

**关键点**：卷式发票查验**必须提供校验码**（JYM）

**处理**：
1. 用户调用本公司API时必须传入verification_code
2. 如果用户未提供，返回错误提示
3. 查验时将verification_code映射为长软的JYM参数

#### 7.4.5 收款员信息的处理

**问题**：长软返回SHY（收款员），本公司API未定义此字段。

**选项**：
1. **方案A**：忽略此字段，不返回给用户
2. **方案B**：扩展本公司API，增加`cashier`字段
3. **建议**：采用方案A，除非业务明确需要

#### 7.4.6 地址电话等缺失信息

**处理原则**：
- 卷式发票本身不包含购销双方地址电话、开户行账号
- 本公司API中这些字段应返回null或空字符串
- 不要尝试从其他来源补充，保持数据真实性

#### 7.4.7 代开发票的识别

**识别方法**：
1. 检查备注（BZ）字段是否包含"代开"关键字
2. 检查特殊票种标志（TSPZBZ）
3. 如果是代开，解析真实销售方信息

**解析逻辑**：
```
如果备注包含"代开"：
  从备注提取真实销售方名称和税号
  填充到proxy_seller_name和proxy_seller_tax_no
否则：
  proxy_seller_name = null
  proxy_seller_tax_no = null
```

---

**文档结束**
