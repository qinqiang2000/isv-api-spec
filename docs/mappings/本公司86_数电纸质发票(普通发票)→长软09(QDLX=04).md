# 本公司86_数电纸质发票(普通发票)→长软09(QDLX=04) 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 86 - 纸质发票(普通发票) / 数字化电子发票-纸质普通发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间,针对"数电纸质普票"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.1.2.pdf (XML格式)
- **本公司发票类型代码**: 86
- **长软发票类型代码**: 09 (数电发票)
- **长软数电发票类型**: QDLX=04 (纸质普票)
- **长软文档章节**: 3.2.3.9

### 依赖的通用文档

本映射表引用以下通用文档,使用前请先了解:
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射(CYJGDM, ZFBZ, TSPZBZ等)

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `86` | `09` | 长软数电发票统一类型代码 |
| 数电发票子类型 | - | `QDLX=04` | **关键**:长软用QDLX区分数电子类型 |
| 发票类型名称 | 纸质发票(普通发票) | 数电发票(纸质普票) | |
| 数据结构定义 | `#/definitions/231697052` | `3.2.3.9` | 本定义也包含81/82/85类型 |
| 发票介质 | 纸质+电子 | 纸质+电子 | 同时具有纸质和电子形态 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**,请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(20) | **双重号码**:可为8位纸质号或20位数电号 |
| `invoice_code` | 纸质发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 纸质发票代码,12位 |
| `paper_invoice_no` | 纸质发票号码 | string(20) | - | - | - | **本公司独有**,存储8位纸质号码 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**,记录查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换:YYYY-MM-DD ← YYYYMMDD |
| `buyer_name` | 购买方名称 | string(150) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方识别号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射,个人可为空 |
| `buyer_address` | 购买方地址 | string(300) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | 直接映射,可能为空 |
| `buyer_phone` | 购买方电话 | string(60) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | 从GFDZDH中解析,可能为空 |
| `buyer_bank_name` | 购买方开户行 | string(120) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | 直接映射,可能为空 |
| `buyer_account_number` | 购买方账号 | string(100) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | 从GFYHZH中解析,可能为空 |
| `seller_name` | 销售方名称 | string(150) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_address` | 销货方地址 | string(250) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | 直接映射,可能为空 |
| `seller_phone` | 销售方电话 | string(60) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | 从XFDZDH中解析,可能为空 |
| `seller_bank_name` | 销售方开户行 | string(120) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | 直接映射,可能为空 |
| `seller_account_number` | 销售方账号 | string(100) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | 从XFYHZH中解析,可能为空 |
| - | - | - | `BODY/JE` | 金额合计 | VARCHAR2(32) | **长软独有**,本公司从items计算 |
| `tax_amount` | 合计税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换:长软为字符串 |
| `amount_including_tax` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换:长软为字符串 |
| `amount_in_words` | 价税合计(大写) | string(300) | - | - | - | **本公司独有**,需自行计算 |
| `remark` | 备注 | string(450) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/SDSJBZ` | 数电发票实际备注 | VARCHAR2(750) | **长软独有**,数电票特有备注 |
| - | - | - | `BODY/JQBH` | 机器编号 | VARCHAR2(16) | **长软字段为空**,数电票无税控设备 |
| - | - | - | `BODY/JYM` | 校验码 | VARCHAR2(32) | **特殊处理**:用数电发票号后6位 |
| `invoice_status` | 发票状态 | 枚举 | `BODY/ZFBZ` | 作废标志 | VARCHAR2(2) | 枚举映射:参见通用枚举文档 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | 废止,以TSPZBZ为准 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**,查验时间戳 |
| - | - | - | `BODY/QDBZ` | 清单标志 | VARCHAR2(2) | **长软独有**,参见通用枚举 |
| - | - | - | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | 枚举映射:参见通用枚举文档 |
| - | - | - | `BODY/HZDK` | 汇总代开标志 | VARCHAR2(2) | **长软独有**,参见通用枚举 |
| `issuer` | 开票人 | string(300) | - | - | - | **本公司独有**,数电票无此字段 |
| `reviewer` | 复核人姓名 | string(75) | `BODY/SDFHR` | 数电发票复核人 | VARCHAR2(150) | 直接映射,可空 |
| `payee` | 收款人姓名 | string(150) | `BODY/SDSKR` | 数电发票收款人 | VARCHAR2(150) | 直接映射,可空 |
| `is_blue_invoice` | 蓝字/红字标识 | 枚举(Y/N) | - | - | - | **本公司独有**,从ZFBZ推断 |
| `original_blue_invoice_no` | 对应蓝字发票号码 | string(20) | - | - | - | **本公司独有**,红票时填写 |
| `seller_taxpayer_type_code` | 销方纳税人类型代码 | string | - | - | - | **本公司独有**,1=一般纳税人/2=小规模 |
| `item_count` | 明细条数 | integer | - | - | - | **本公司独有**,items数组长度 |
| `deduction_amount` | 扣除额 | number(18,2) | - | - | - | **本公司独有**,差额征税扣除额 |
| `settlement_method_code` | 结算方式 | string(2) | - | - | - | **本公司独有** |
| `vat_immediate_refund_code` | 增值税即征即退代码 | string(2) | - | - | - | **本公司独有** |
| `export_tax_refund_type_code` | 出口退税类代码 | string(2) | - | - | - | **本公司独有** |
| `refined_oil_abnormal_flag` | 成品油异常标识 | string(1) | - | - | - | **本公司独有**,9=正常 |
| - | - | - | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**,查验状态码,参见通用枚举文档 |

**字段分类说明**:
- **直接映射**: 字段名和含义一致,直接对应
- **格式转换**: 需要进行格式转换(如日期、金额格式)
- **类型转换**: 需要进行数据类型转换(如string ↔ number)
- **长软独有**: 长软API独有字段,本公司API无此字段
- **本公司独有**: 本公司API独有字段,需从其他数据源获取或计算
- **双重号码**: 数电纸质票同时具有纸质号码和数电号码

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `paper_invoice_no` | 长软返回 | 当使用纸质号码查验时,存储8位纸质号码 |
| `amount_in_words` | 计算得出 | 将amount_including_tax数字转换为中文大写 |
| `item_count` | 计算得出 | items数组长度,即明细条数 |
| `is_blue_invoice` | 推断得出 | 根据ZFBZ判断:0/1→Y(蓝字),3/7/8→N(红字) |
| `original_blue_invoice_no` | 业务系统 | 红字发票对应的原蓝字发票号,从业务系统获取 |
| `seller_taxpayer_type_code` | 业务规则 | 数电普票可由一般纳税人或小规模纳税人开具,需从业务系统判断 |
| `deduction_amount` | 计算得出 | 差额征税时的扣除额,从items中计算 |
| `issuer` | - | 数电票无开票人字段,返回null |
| `refined_oil_abnormal_flag` | 业务规则 | 成品油异常标识,非成品油票固定为"9" |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**:
- ✅ **数电纸质普票有货物明细结构**
- 明细数据记录货物或应税劳务的详细信息
- 一张发票可以有多个明细行
- 数电纸质普票明细字段与传统普票、数电普票完全一致

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 序号 | integer | - | - | - | **本公司独有**,用于排序 |
| `name` / `goods_or_service_name` | 货物或应税劳务名称 | string(300/600) | `HWMC` | 货物或应税劳务名称 | VARCHAR2(320) | 直接映射 |
| `specification` | 规格型号 | string(150) | `GGXH` | 规格型号 | VARCHAR2(64) | 直接映射 |
| `unit` | 单位 | string(300) | `DW` | 单位 | VARCHAR2(52) | 直接映射 |
| `quantity` | 发票交易数量 | string(25) | `SL` | 数量 | VARCHAR2(25) | 直接映射 |
| `unit_price` | 发票交易单价 | string(25) | `DJ` | 单价 | VARCHAR2(25) | 直接映射 |
| `amount` | 金额 | number(8,2) | `JE` | 金额 | NUMBER(20,2) | 直接映射 |
| `tax_rate` | 税率 | number(6,6) | `SLV` | 税率 | NUMBER(8,5) | 直接映射 |
| `tax_amount` | 税额 | number(8,6) | `SE` | 税额 | NUMBER(20,2) | 直接映射 |
| `tax_classification_code` | 商品税收分类编码 | string(19) | - | - | - | **本公司独有** |
| `deduction_amount` | 扣除额 | number(8,2) | - | - | - | **本公司独有**,差额征税 |
| `item_short_name` | 商品服务简称 | string(120) | - | - | - | **本公司独有** |
| `product_barcode` | 商品条码 | string(300) | - | - | - | **本公司独有** |

**说明**:
- 长软API中明细字段的金额、税额、税率都是NUMBER类型,可以直接映射
- 其他字段(数量、单价)都是字符串类型
- 本公司独有字段需要从业务系统或Apifox定义中获取
- 数电纸质普票的明细结构与传统增值税普通发票(04)完全一致

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**:
- 长软→本公司: `"20251230"` → `"2025-12-30"`
- 实现: `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额合计 | 本公司从items计算 | `VARCHAR2(32)` 字符串 | 长软JE字段存在但本公司不使用 |
| 合计税额 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细金额 | `number` (8,2) | `NUMBER(20,2)` | 类型一致,直接映射 |
| 明细税额 | `number` (8,6) | `NUMBER(20,2)` | 精度不同,注意转换 |
| 明细税率 | `number` (6,6) | `NUMBER(8,5)` | 精度不同,注意转换 |

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 20 | ✅ 长度一致,支持8位或20位 |
| invoice_code | 12 | 20 | ✅ 纸质代码12位,长度足够 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更宽松,但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松,但实际18位够用(个人可无) |
| buyer_name | 150 | 300 | ⚠️ 长软更大,需注意截断 |
| seller_name | 150 | 300 | ⚠️ 长软更大,需注意截断 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括:
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **作废标志** (ZFBZ → invoice_status)
- **特殊票种标志** (TSPZBZ → special_invoice_type)
- **清单标志** (QDBZ)
- **汇总代开标志** (HZDK)

### 5.2 数电纸质普票特有枚举映射

⚠️ **重要**: 数电纸质普票**没有特有枚举**,所有枚举都使用通用枚举映射。

但需要注意以下特殊情况:

#### 5.2.1 发票类型区分 (QDLX)

数电发票统一使用长软类型代码09,通过QDLX字段区分子类型:

| QDLX值 | 含义 | 本公司发票类型 |
|-------|------|--------------|
| 10 | 数电普票(电子) | 82 |
| 20 | 数电专票(电子) | 81 |
| 01 | 数电纸质专票 | 85 |
| 04 | 数电纸质普票 | 86 |
| 03 | 数电机动车(电子/纸质) | 83/87 |
| 15 | 数电二手车(电子/纸质) | 84/88 |

**说明**:
- 长软在消息头 `HEAD/QDLX` 返回此字段
- **本映射表仅处理QDLX=04(数电纸质普票)**
- 其他QDLX值应路由到对应的映射表

#### 5.2.2 销方纳税人类型 (seller_taxpayer_type_code)

数电纸质普票可由不同类型纳税人开具:

| 代码 | 含义 | 说明 |
|-----|------|------|
| 1 | 一般纳税人 | 可开具普票和专票 |
| 2 | 小规模纳税人 | 只能开具普票 |
| 3 | 转登记小规模纳税人 | 只能开具普票 |
| 4 | 辅导期一般纳税人 | 可开具普票 |
| 5 | 自然人 | 代开普票 |

**注意**: 长软API不返回此字段,需要从业务系统判断或根据税率推断。

#### 5.2.3 发票状态的特殊性

数电纸质发票的发票状态(ZFBZ)与传统发票一致:

| ZFBZ值 | 含义 | 说明 |
|-------|------|------|
| 0 或 1 | 正常 | 数电纸质票正常状态 |
| 2 | 作废 | 数电票作废(很少见) |
| 3 | 红冲 | 红字发票(数电票常用) |
| 7 | 部分红冲 | 部分红字 |
| 8 | 全额红冲 | 全额红字 |

**数电票的特殊性**:
- 数电票很少使用"作废"(ZFBZ=2),通常使用"红冲"(ZFBZ=3)
- 红字数电票会在 `original_blue_invoice_no` 中记录被红冲的蓝字发票号

---

## 六、数电纸质普票特殊性说明

### 6.1 该类型的独特特性

1. **双重号码系统**
   - 数电纸质普票**同时具有纸质发票号码和数电发票号码**
   - **纸质发票号码**: 8位数字,印制在纸质发票上
   - **数电发票号码**: 20位数字,在电子税务局系统中生成
   - 两个号码都可以用于查验,但推荐使用纸质号码

2. **双重查验方式**
   - **方式一(推荐)**: 使用纸质发票代码(12位) + 纸质发票号码(8位) + 校验码后6位
   - **方式二**: 使用数电发票号码(20位) + 开票日期 + 价税合计
   - 长软API会根据提供的参数自动选择查验方式

3. **校验码的特殊处理**
   - 使用纸质号码查验时: 提供传统校验码后6位
   - 使用数电号码查验时: 使用**数电发票号码后6位**作为JYM参数
   - 长软返回的JYM字段可能为空

4. **发票代码的存在性**
   - 数电纸质普票**有纸质发票代码**(12位)
   - 这是与数电电子普票(82)的最大区别
   - 发票代码印制在纸质发票上

5. **四方信息的完整性**
   - 数电纸质票的四方信息(购销双方地址电话、开户行账号)**可能存在也可能为空**
   - 比纯电子数电票(82)更可能有完整的四方信息
   - 但不如传统普票(04)的四方信息完整

6. **不可抵扣进项税**
   - 数电纸质普票**不能抵扣进项税额**
   - 这是与数电纸质专票(85)的核心区别
   - 主要用于最终消费或非增值税业务

7. **购买方可为个人**
   - 数电纸质普票购买方可以是个人(无税号)
   - `buyer_tax_no` 可为空
   - `buyer_name` 可以是个人姓名

8. **必须有货物明细**
   - 数电纸质普票必须包含货物或应税劳务明细
   - CHILDLIST不能为空
   - 每个明细行需要包含完整的税率、税额信息

9. **红字发票处理**
   - 数电票很少作废,通常通过开具红字发票冲销
   - 红字发票需要记录对应的原蓝字发票号码

10. **数电特有字段**
    - `SDSKR`(数电发票收款人):可空
    - `SDFHR`(数电发票复核人):可空
    - `SDSJBZ`(数电发票实际备注):可空,可能与BZ不同

11. **纸质+电子双重介质**
    - 既有实体纸质发票,也有电子版PDF
    - 纸质版用于传统流程,电子版用于数字化管理
    - 两者内容完全一致,法律效力相同

### 6.2 与其他类型的区别

| 特性 | 数电纸质普票(86) | 数电普票(82) | 传统普票(04) | 数电纸质专票(85) |
|------|----------------|-------------|-------------|----------------|
| 发票代码 | ✅ 12位纸质代码 | ❌ 无 | ✅ 12位 | ✅ 12位纸质代码 |
| 发票号码 | ✅ 8位+20位双号 | ✅ 20位数电号 | ✅ 8位 | ✅ 8位+20位双号 |
| 校验码 | ✅ 有(或用号码后6位) | ❌ 无 | ✅ 有 | ❌ 无(专票查验用金额) |
| 抵扣 | ❌ 不可抵扣 | ❌ 不可抵扣 | ❌ 不可抵扣 | ✅ 可抵扣 |
| 明细结构 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 |
| 四方信息 | ⚠️ 可能有 | ⚠️ 简化或无 | ✅ 完整 | ⚠️ 可能有 |
| 发票介质 | 纸质+电子 | 纯电子 | 纸质 | 纸质+电子 |
| 长软类型码 | 09 (QDLX=04) | 09 (QDLX=10) | 04 | 09 (QDLX=01) |
| 税控设备 | ❌ 无 | ❌ 无 | ✅ 有 | ❌ 无 |
| 购方税号 | ⚠️ 可为空 | ⚠️ 可为空 | ⚠️ 可为空 | ✅ 必填 |
| 查验方式 | 双重查验 | 单一查验(数电号) | 单一查验(代码号码) | 双重查验 |

### 6.3 特殊处理逻辑

#### 6.3.1 双重查验方式识别

由于数电纸质普票支持两种查验方式,需要识别用户使用的是哪种:

**识别规则**:
1. **纸质号码查验**(方式一):
   - 提供了 `invoice_code` (12位)
   - `invoice_number` 为8位数字
   - 提供了 `verification_code` (校验码)
   - **推荐使用此方式**

2. **数电号码查验**(方式二):
   - 未提供 `invoice_code` 或为空
   - `invoice_number` 为20位数字
   - 提供了 `invoice_amount` (价税合计)

**处理流程**:
```
if (invoice_code 存在 && invoice_number.length == 8) {
    // 方式一: 纸质号码查验
    长软JYM = verification_code.substring(verification_code.length - 6)
    长软FPDM = invoice_code
    长软FPHM = invoice_number (8位)
} else if (invoice_number.length == 20) {
    // 方式二: 数电号码查验
    长软JYM = invoice_number.substring(14, 20)  // 数电号后6位
    长软FPDM = ""  // 空
    长软FPHM = invoice_number (20位)
    长软FPJE = invoice_amount
}
```

#### 6.3.2 发票类型识别

由于长软对所有数电票统一返回类型码09,必须通过QDLX区分:

**处理流程**:
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 根据QDLX路由:
   - QDLX=04 → 使用本映射表(数电纸质普票)
   - QDLX=10 → 路由到数电普票映射表(82)
   - QDLX=01 → 路由到数电纸质专票映射表(85)
   - 其他值 → 返回不支持的数电类型错误

**业务背景**:
- 数电发票是中国税务总局推出的全电发票
- 长软系统将所有数电发票归为一个大类(09),通过QDLX细分
- 本公司API需要将数电纸质普票映射为独立类型(86)

#### 6.3.3 四方信息处理

数电纸质票的四方信息可能存在也可能为空:

**处理方案**:
1. **接受空值**: buyer_address、buyer_phone等字段可能为空,返回null
2. **购方税号可为空**: 如果是个人购买,buyer_tax_no为null
3. **业务规则补全**(可选):
   - 如果业务系统已有购销双方完整信息,可从业务系统补全
   - 如果无法补全,返回null,不影响查验结果
4. **地址电话分离**: 长软的GFDZDH、XFDZDH字段包含地址和电话,需要解析分离

**注意事项**:
- 不要因为四方信息缺失而认为查验失败
- 数电纸质票的四方信息比纯电子数电票(82)更完整
- 只要购销双方名称一致即可(普票税号可为空)

#### 6.3.4 个人购买识别

数电纸质普票支持个人购买,需要特殊处理:

**识别规则**:
1. `buyer_tax_no` 为空或null → 个人购买
2. `buyer_name` 不含"公司"、"企业"等关键词 → 可能是个人
3. `buyer_name` 长度较短(如2-4个汉字) → 可能是个人姓名

**处理方案**:
- 购方税号为空时,不强制验证
- 购方名称可以是个人姓名
- 不需要购方地址、电话、开户行等信息

#### 6.3.5 销方纳税人类型推断

长软API不返回销方纳税人类型,需要从其他信息推断:

**推断规则**:
1. **税率为3%或1%** → 可能是小规模纳税人
2. **税率为13%、9%、6%** → 可能是一般纳税人
3. **特殊票种标志(TSPZBZ)** → 如果是代开(01),一般是小规模或自然人

**建议**:
- 如果业务系统有销方纳税人类型信息,优先使用业务系统数据
- 如果无法确定,可根据税率推断
- 对于查验API,此字段非关键,可返回null

#### 6.3.6 金额计算验证

数电纸质票的金额计算与传统发票一致:

**验证逻辑**:
1. 验证: 价税合计 = 金额合计 + 税额合计
2. 允许2分钱误差(因浮点数精度)
3. 验证明细金额汇总 = 汇总金额合计
4. 验证明细税额汇总 = 汇总税额合计

**公式**:
- total_amount = 不含税金额 + total_tax_amount
- total_tax_amount = 不含税金额 × 税率

#### 6.3.7 红字发票处理

数电票的红字处理逻辑:

**处理流程**:
1. **识别红字发票**:
   - 检查 `ZFBZ` 是否为 3/7/8
   - 设置 `is_blue_invoice = 'N'`

2. **记录原票信息**(需要业务系统支持):
   - `original_blue_invoice_no`: 原蓝字发票号码
   - 建立红蓝字发票关联关系

3. **红字列表处理**:
   - 长软09类型暂不返回红字列表(HZLIST)
   - 需要从业务系统维护红蓝字关系

**业务背景**:
- 数电票不支持作废,只能通过红字发票冲销
- 一张蓝字发票可能对应多张部分红字发票
- 需要建立完整的红蓝字发票链条追踪机制

#### 6.3.8 双号码存储策略

数电纸质票的双号码需要合理存储:

**存储方案**:
1. **主发票号码** (`invoice_number`):
   - 如果用户使用纸质号码查验,存储8位纸质号码
   - 如果用户使用数电号码查验,存储20位数电号码
   - 优先存储用户提供的号码

2. **纸质发票号码** (`paper_invoice_no`):
   - 专门存储8位纸质号码
   - 如果用户提供的是20位数电号,此字段可能为空

3. **数电发票号码**:
   - 本公司API当前无专门字段存储数电号码
   - 建议扩展字段 `digital_invoice_number` 存储20位数电号
   - 或在 `invoice_number` 字段中根据长度自动识别

4. **发票代码** (`invoice_code`):
   - 存储12位纸质发票代码
   - 数电纸质票必有此字段

**查询策略**:
- 支持用户使用8位纸质号或20位数电号查询
- 查询时需要同时匹配 `invoice_number` 和 `paper_invoice_no`
- 建立双号码索引提高查询效率

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**(但本公司API可选):
- 无特殊要求

**本公司API要求必填**(但长软API可选):
- `invoice_number` (发票号码) - 必填,8位或20位
- `invoice_code` (发票代码) - 方式一查验时必填,12位
- `verification_code` (校验码) - 方式一查验时必填
- `invoice_amount` (价税合计) - 方式二查验时必填
- `seller_name` (销售方名称) - 必填
- `buyer_name` (购买方名称) - 必填
- `amount_including_tax` (价税合计) - 必填
- `tax_amount` (合计税额) - 必填
- `amount_in_words` (价税合计大写) - 必填,需自行计算
- `is_blue_invoice` (蓝字/红字标识) - 必填,从ZFBZ推断
- `invoice_status` (发票状态) - 必填,从ZFBZ映射

**注意**: 购方税号(`buyer_tax_no`)对于普票**不是必填**,个人购买时为空。

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 20 | ✅ 长度一致,支持8位或20位 |
| invoice_code | 12 | 20 | ✅ 纸质代码12位,长度足够 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大,但中国税号18位,20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大,但中国税号18位,20位足够(可为空) |
| buyer_name | 150 | 300 | ⚠️ 长软更大,需截断超长名称 |
| seller_name | 150 | 300 | ⚠️ 长软更大,需截断超长名称 |

### 7.3 数据完整性

**长软独有字段**(本公司API无对应):
- `CYCS` (查验次数) - 长软统计查验次数
- `CYSJ` (查验时间) - 长软查验时间戳
- `JE` (金额合计) - 长软返回,本公司从items计算
- `JQBH` (机器编号) - 数电票为空
- `QDBZ` (清单标志) - 是否有销货清单
- `HZDK` (汇总代开标志) - 是否汇总代开
- `SDSJBZ` (数电发票实际备注) - 数电票特有备注

**本公司独有字段**(需从其他数据源获取):
- `paper_invoice_no` (纸质发票号码) - 存储8位纸质号
- `amount_with_tax_in_words` (价税合计大写) - 从total_amount计算
- `item_count` (明细条数) - 从items数组长度计算
- `is_blue_invoice` (蓝字/红字标识) - 从ZFBZ推断
- `original_blue_invoice_no` (原蓝字发票号) - 从业务系统获取
- `issuer` (开票人) - 数电票无此字段
- `seller_taxpayer_type_code` (销方纳税人类型) - 从业务系统或税率推断
- `deduction_amount` (扣除额) - 从items计算
- `settlement_method_code` (结算方式) - 从业务系统获取
- `vat_immediate_refund_code` (即征即退代码) - 从业务系统获取
- `export_tax_refund_type_code` (出口退税类代码) - 从业务系统获取
- `refined_oil_abnormal_flag` (成品油异常标识) - 非成品油固定为"9"
- `tax_classification_code` (商品税收分类编码) - 从业务系统获取

### 7.4 数电纸质普票特殊集成要点

⚠️ **这是最重要的部分,必须根据业务特性详细说明!**

#### 7.4.1 双重查验方式支持

**挑战**: 数电纸质普票支持两种查验方式,需要正确识别和处理。

**解决方案**:
1. **前端输入识别**:
   - 如果用户输入12位发票代码 + 8位发票号码 → 方式一
   - 如果用户输入20位发票号码 → 方式二
   - 前端应提供智能识别或两种输入模式

2. **后端参数构建**:
   - 方式一: 提供FPDM、FPHM(8位)、JYM(校验码后6位)
   - 方式二: 提供FPHM(20位)、FPJE、JYM(数电号后6位)

3. **推荐策略**:
   - **优先使用方式一**(纸质号码查验)
   - 纸质发票上印制的信息更直观
   - 用户更容易从纸质发票上获取代码、号码、校验码

**业务背景**:
- 数电纸质票是过渡性产品,兼顾传统纸质和数字化需求
- 两种查验方式都能查到同一张发票
- 长软系统会自动关联纸质号码和数电号码

#### 7.4.2 发票类型路由

**挑战**: 长软对所有数电票统一返回类型码09,需要根据QDLX路由到正确的处理器。

**解决方案**:
1. 检查 `HEAD/FPLX` 是否为 "09"
2. 检查 `HEAD/QDLX` 的值
3. 根据QDLX路由:
   - QDLX=04 → 使用本映射表(数电纸质普票)
   - QDLX=10 → 路由到数电普票映射表(82)
   - QDLX=01 → 路由到数电纸质专票映射表(85)
   - 其他值 → 返回不支持的数电类型错误

4. **区分纸质和电子**:
   - 有invoice_code → 纸质数电票(85/86)
   - 无invoice_code → 电子数电票(81/82)

**业务背景**:
- 数电发票是中国税务总局推出的全电发票
- 长软系统将所有数电发票归为一个大类(09),通过QDLX细分
- 本公司API需要将数电纸质普票映射为独立类型(86)

#### 7.4.3 个人购买场景处理

**挑战**: 数电纸质普票支持个人购买,购方可能无税号,需要特殊处理。

**解决方案**:
1. **购方税号验证**:
   - 如果buyer_tax_no为空,不报错
   - 如果buyer_tax_no有值,验证格式(18位统一社会信用代码或15位税号)

2. **购方名称验证**:
   - 个人购买时,buyer_name可以是2-4个汉字
   - 企业购买时,buyer_name通常包含"公司"、"企业"等关键词

3. **查验规则**:
   - 长软查验时,购方税号可为空
   - 主要验证发票号码、开票日期、金额(或校验码)

**注意事项**:
- 不要因为购方税号为空而拒绝查验
- 个人购买是普票的常见场景,属于正常现象
- 只要发票号码和金额一致即可

#### 7.4.4 四方信息缺失处理

**挑战**: 数电纸质票的四方信息可能存在也可能为空。

**解决方案**:
1. **接受空值**: buyer_address、buyer_phone等字段可能为空,返回null
2. **地址电话分离**:
   - 长软的GFDZDH、XFDZDH包含"地址 电话"格式
   - 需要解析分离为address和phone两个字段
   - 常见分隔符: 空格、逗号、"电话:"等

3. **开户行账号分离**:
   - 长软的GFYHZH、XFYHZH包含"开户行 账号"格式
   - 需要解析分离为bank_name和account_number两个字段

4. **业务规则补全**(可选):
   - 如果业务系统已有购销双方完整信息,可从业务系统补全
   - 如果无法补全,返回null,不影响查验结果

**注意事项**:
- 不要因为四方信息缺失而认为查验失败
- 数电纸质票的四方信息比纯电子数电票更完整,但不如传统普票
- 只要购销双方名称一致即可

#### 7.4.5 双号码存储与查询

**挑战**: 数电纸质票同时具有纸质号码和数电号码,需要合理存储。

**解决方案**:
1. **存储策略**:
   - invoice_code: 12位纸质发票代码(必存)
   - invoice_number: 用户提供的号码(8位或20位)
   - paper_invoice_no: 8位纸质号码(如果已知)
   - 建议扩展: digital_invoice_number存储20位数电号

2. **查询策略**:
   - 支持用户使用8位纸质号或20位数电号查询
   - 查询时需要匹配: (invoice_code + invoice_number) 或 (digital_invoice_number)
   - 建立双号码索引提高查询效率

3. **去重策略**:
   - 以 (invoice_code, invoice_number, invoice_type) 作为唯一键
   - 同一张数电纸质票的多次查验应能识别为同一张票
   - 纸质号和数电号查验的结果应关联为同一张票

**业务背景**:
- 数电纸质票是税务数字化转型的过渡产品
- 既保留纸质介质(方便传统流程),又有电子化管理
- 双号码系统确保新旧系统的兼容

#### 7.4.6 红字发票链条追踪

**挑战**: 数电纸质票红字发票需要追踪原蓝字发票。

**解决方案**:
1. **识别红字发票**:
   - 检查 `ZFBZ` 是否为 3/7/8
   - 设置 `is_blue_invoice = 'N'`

2. **记录原票信息**(需要业务系统支持):
   - `original_blue_invoice_no`: 原蓝字发票号码
   - 建立红蓝字发票关联关系
   - 支持纸质号和数电号的双重关联

3. **红字列表处理**:
   - 长软09类型暂不返回红字列表(HZLIST)
   - 需要从业务系统维护红蓝字关系

**业务背景**:
- 数电票不支持作废,只能通过红字发票冲销
- 一张蓝字发票可能对应多张部分红字发票
- 需要建立完整的红蓝字发票链条追踪机制

#### 7.4.7 销方纳税人类型判断

**挑战**: 长软API不返回销方纳税人类型,但业务系统可能需要此信息。

**解决方案**:
1. **税率推断**:
   - 税率3%或1% → 可能是小规模纳税人
   - 税率13%、9%、6% → 可能是一般纳税人

2. **特殊票种标志推断**:
   - TSPZBZ=01(代开) → 可能是小规模或自然人

3. **业务系统补全**:
   - 如果业务系统有销方纳税人类型信息,优先使用
   - 否则根据税率推断

**注意事项**:
- 此字段非查验关键字段,可为null
- 推断结果仅供参考,不保证100%准确

#### 7.4.8 明细数据完整性验证

**挑战**: 确保明细数据与汇总数据一致。

**解决方案**:
与传统普票相同,验证:
1. 明细金额汇总 = 汇总金额合计
2. 明细税额汇总 = 汇总税额合计
3. 价税合计 = 金额合计 + 税额合计
4. 允许2分钱误差

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697052)
2. 长软API文档: `【长软】发票查验服务调用说明V4.1.2.pdf` (第13-14页)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 国家税务总局全电发票平台: https://etax.chinatax.gov.cn/
6. 参考映射表: `本公司82_数电普票→长软09(QDLX=10).md`
7. 参考映射表: `本公司85_数电纸质专票→长软09(QDLX=01).md`

---

**文档结束**
