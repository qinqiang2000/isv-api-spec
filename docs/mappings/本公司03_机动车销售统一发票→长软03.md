# 本公司03_机动车销售统一发票→长软03 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 03 - 机动车销售统一发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"机动车销售统一发票"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 03
- **长软发票类型代码**: 03
- **长软文档章节**: 3.2.3.2

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `03` | `03` | 完全一致 |
| 发票类型名称 | 机动车销售统一发票 | 机动车销售统一发票 | |
| 数据结构定义 | `#/definitions/231697056` | `3.2.3.2` | |
| 数电发票类型 | - | - | 非数电发票 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射，本公司支持更长 |
| `paper_invoice_no` | 纸质发票号码 | string(8) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录该发票被查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `tax_control_code` | 税控码 | string(200) | `BODY/SKPH` | 机器编码 | VARCHAR2(16) | 直接映射，税控设备编号 |
| `buyer_name` | 购买方名称 | string(370) | `BODY/GHDW` | 购买方名称 | VARCHAR2(370) | 直接映射 |
| `id_card_no` | 身份证号码/组织机构代码 | string(70) | `BODY/SFZHM` | 身份证号码/组织机构代码 | VARCHAR2(70) | 直接映射，个人购车时使用身份证号 |
| `buyer_tax_no` | 购买方纳税人识别号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射，企业购车时使用 |
| `vehicle_type_code` | 车辆类型 | string(128) | `BODY/CLLX` | 车辆类型 | VARCHAR2(128) | 直接映射 |
| `product_model` | 厂牌型号 | string(210) | `BODY/CPXH` | 厂牌型号 | VARCHAR2(160) | 直接映射 |
| `origin_place` | 产地 | string(128) | `BODY/CD` | 产地 | VARCHAR2(128) | 直接映射 |
| `compliance_no` | 合格证书 | string(160) | `BODY/HGZS` | 合格证号 | VARCHAR2(160) | 直接映射 |
| `vehicle_price` | 车价及价外费用(不含增值税) | number(18,2) | `BODY/CJFY` | 不含税价 | NUMBER(18,2) | 直接映射 |
| `inspection_no` | 商检单号 | string(128) | `BODY/SJDH` | 商检单号 | VARCHAR2(128) | 直接映射 |
| `engine_no` | 发动机号码 | string(190) | `BODY/FDJHM` | 发动机号 | VARCHAR2(190) | 直接映射 |
| `vehicle_identification_no` | 车架号码/车辆识别号 | string(40) | `BODY/CJHM` | 车辆识别代号/车架号码 | VARCHAR2(40) | 直接映射，VIN码 |
| `import_no` | 进口证明书号 | string(128) | `BODY/JKZMSH` | 进口证明书号 | VARCHAR2(128) | 直接映射 |
| `seller_name` | 销货单位名称 | string(300) | `BODY/XHDWMC` | 销货单位名称 | VARCHAR2(300) | 直接映射 |
| `seller_phone` | 电话 | string(120) | `BODY/DH` | 电话 | VARCHAR2(120) | 直接映射 |
| `seller_tax_no` | 销货单位纳税人识别号 | string(20) | `BODY/NSRSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_account_number` | 帐号 | string(300) | `BODY/ZH` | 账号 | VARCHAR2(300) | 直接映射 |
| `seller_address` | 地址 | string(250) | `BODY/DZ` | 地址 | VARCHAR2(250) | 直接映射 |
| `seller_bank_name` | 开户银行 | string(250) | `BODY/KHYH` | 开户银行 | VARCHAR2(250) | 直接映射 |
| `tax_rate` | 增值税税率或征收率 | number(8,5) | `BODY/ZZSSL` | 增值税税率或征收率 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `vat_tax_amount` | 增值税税额 | number(18,2) | `BODY/ZZSSE` | 增值税税额 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_bureau_code` | 主管税务机关代码 | string(11) | `BODY/SWJG_DM` | 主管税务机关代码 | VARCHAR2(11) | 直接映射 |
| `amount_including_tax` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `taxation_voucher` | 完税凭证号码 | string(200) | `BODY/WSPZHM` | 完税凭证号码 | VARCHAR2(200) | 直接映射 |
| `vehicle_weight` | 吨位 | string(64) | `BODY/DW` | 吨位 | VARCHAR2(64) | 直接映射 |
| `vehicle_capacity` | 限乘人数 | string(40) | `BODY/XCRS` | 限乘人数 | VARCHAR2(40) | 直接映射 |
| `invoice_status_flag` | 作废标志 | 枚举 | `BODY/ZFBZ` | 作废标志 | CHAR(1) | 枚举映射：参见通用枚举文档 |
| `tax_bureau_name` | 主管税务机关名称 | string(300) | `BODY/SWJG_MC` | 主管税务机关名称 | VARCHAR2(300) | 直接映射 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| `agent_unit_code` | 代开单位代码 | string(20) | `BODY/DKBZ` | 代开标志 | VARCHAR2(2) | 需要逻辑判断，DKBZ=2时为代开 |
| `agent_unit_name` | 代开单位名称 | string(300) | - | - | - | **本公司独有**，需从业务系统获取 |
| - | - | - | `BODY/TSZCBS` | 特殊政策标识 | VARCHAR2(2) | **长软独有**，特殊政策标识 |
| - | - | - | `BODY/SJSL` | 实际税率 | VARCHAR2(32) | **长软独有**，实际税率 |
| - | - | - | `BODY/SJSE` | 实际税额 | VARCHAR2(32) | **长软独有**，实际税额 |
| - | - | - | `BODY/BBXX` | 版本信息 | CHAR(1) | **长软独有**，0=旧版，1=新版 |
| `invoice_status` | 发票状态 | 枚举 | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |
| `issuer` | 开票人 | string(150) | - | - | - | **本公司独有**，开票人名称 |
| `deduction_flag` | 抵扣标志 | string(1) | - | - | - | **本公司独有** |
| `void_date` | 作废日期 | string(19) | - | - | - | **本公司独有** |
| `void_person` | 作废人 | string(150) | - | - | - | **本公司独有** |
| `receiver_code` | 接收人 | string(16) | - | - | - | **本公司独有** |
| `receiver_name` | 接收人名称 | string(150) | - | - | - | **本公司独有** |
| `receive_time` | 接收时间 | string | - | - | - | **本公司独有** |
| `receiving_tax_bureau_code` | 接收税务机关代码 | string(11) | - | - | - | **本公司独有** |
| `submission_method` | 报送方式 | string(1) | - | - | - | **本公司独有** |
| `code_table_version` | 编码表版本号 | string(21) | - | - | - | **本公司独有** |
| `product_code` | 商品编码 | string(20) | - | - | - | **本公司独有** |
| `custom_code` | 自行编码 | string(40) | - | - | - | **本公司独有** |
| `preferential_policy_flag` | 优惠政策标识 | string(1) | - | - | - | **本公司独有** |
| `vat_special_management` | 增值税特殊管理 | string(760) | - | - | - | **本公司独有** |
| `zero_tax_rate_flag` | 零税率标志 | 枚举 | - | - | - | **本公司独有** |
| `applicable_tax_rate_flag` | 适用税率标识 | string(1) | - | - | - | **本公司独有** |
| `three_percent_reason` | 3%税率开具理由 | string(2) | - | - | - | **本公司独有** |
| `vehicle_abnormal_flag` | 机动车异常标识 | string(1) | - | - | - | **本公司独有**，0=无风险,1=低风险,2=中风险,3=高风险 |
| `issue_type` | 开票类型 | 枚举 | - | - | - | **本公司独有** |
| `tax_payer_id` | 报税纳税人识别号 | string(20) | - | - | - | **本公司独有** |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `agent_unit_name` | 业务规则推断 | 当DKBZ=2时，需从备注或其他来源解析代开单位名称 |
| `issuer` | 业务系统 | 从企业业务系统获取开票人信息 |
| `void_date` | 业务系统 | 从企业业务系统获取，长软只返回ZFBZ标志 |
| `vehicle_abnormal_flag` | 业务系统 | 从企业风控系统获取机动车异常风险等级 |
| `deduction_flag` | 业务规则 | 根据购方纳税人类型和发票用途判断 |
| `receiver_*` | 业务系统 | 从电子发票接收系统获取 |
| `submission_method` | 业务系统 | 报送方式标识 |
| `product_code` | 业务系统 | 商品编码，机动车可能为车辆分类代码 |
| `preferential_policy_flag` | 业务规则 | 根据税率和特殊政策标识判断 |
| `vat_special_management` | 业务规则 | 增值税特殊管理说明 |
| `three_percent_reason` | 业务规则 | 当税率为3%时的开具理由 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`（不适用于机动车发票）
**长软API路径**: `BODY/CHILDLIST/CHILD[]`（机动车发票为空）

⚠️ **注意**:
- ❌ **机动车发票无货物明细结构**
- 机动车发票的商品信息已经包含在主信息中（车辆信息）
- 长软API返回的CHILDLIST为空数组
- 本公司API不返回items字段或返回空数组

### 3.2 车辆信息vs货物明细

机动车发票的特殊性在于：车辆信息直接在主信息中，而非作为明细行。

**传统发票（如01专票）**：
```
主信息: 购销方、金额合计
  └─ 明细: 货物1、货物2、货物3...
```

**机动车发票（03）**：
```
主信息: 购销方、车辆信息（厂牌型号、VIN码、发动机号...）、金额
  └─ 无明细
```

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**：
```javascript
// 长软 → 本公司
function formatDate(yyyymmdd) {
  if (!yyyymmdd || yyyymmdd.length !== 8) return null;
  return `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`;
}
// 示例: "20251230" → "2025-12-30"
```

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 车价（不含税价） | `number` (18,2) | `NUMBER(18,2)` | 类型一致，直接映射 |
| 增值税税额 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 增值税税率 | `number` (8,5) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |

**转换示例**：
```javascript
// 长软API返回
{
  "ZZSSL": "0.13",      // 13%税率
  "ZZSSE": "13000.00",  // 税额
  "JSHJ": "113000.00"   // 价税合计
}

// 转换为本公司API
{
  "tax_rate": 0.13,
  "vat_tax_amount": 13000.00,
  "total_amount": 113000.00
}
```

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 10 | ⚠️ 本公司更宽松，兼容数电发票20位 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → HTTP状态码 + error.code)
- **作废标志** (ZFBZ → invoice_status_flag)
- **特殊票种标志** (TSPZBZ → special_invoice_type)

### 5.2 机动车发票特有枚举映射

⚠️ **重要**: 以下枚举为**机动车发票特有**，不在通用枚举文档中。

#### 5.2.1 版本信息 (BBXX)

| 长软值 | 含义 | 本公司映射 | 说明 |
|-------|------|-----------|------|
| 0 | 旧版机动车发票 | 不映射（长软独有） | 2018年之前的旧版式 |
| 1 | 新版机动车发票 | 不映射（长软独有） | 2018年8月启用的新版式 |

**说明**：本公司API暂不包含版本信息字段，如需扩展可添加 `vehicle_invoice_version` 字段。

#### 5.2.2 代开标志 (DKBZ)

| 长软值 | 含义 | 本公司映射 | 处理逻辑 |
|-------|------|-----------|----------|
| 0 | 非代开 | `agent_unit_code: null` | 自开发票 |
| 1 | 自开 | `agent_unit_code: null` | 自开发票 |
| 2 | 代开 | `agent_unit_code: "..."` | 需填充代开单位代码 |

**处理规则**：
```javascript
if (DKBZ === '2') {
  // 代开发票，需从备注或其他字段解析代开单位信息
  invoice.agent_unit_code = parseAgentUnitCode(BODY.BZ);
  invoice.agent_unit_name = parseAgentUnitName(BODY.BZ);
}
```

#### 5.2.3 特殊政策标识 (TSZCBS)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 1 | 免税 | 享受免税政策 |
| 2 | 不征税 | 不征税项目 |
| 3 | 0税率 | 适用0税率 |
| 01 | 不征税 | 同2 |

**说明**：本公司API暂无对应字段，建议扩展时与 `preferential_policy_flag` 关联。

---

## 六、机动车发票特殊性说明

### 6.1 该类型的独特特性

1. **无货物明细结构**
   - 机动车发票的商品信息（车辆信息）直接在主信息中
   - 不使用CHILDLIST/CHILD结构
   - 一张发票对应一台车辆

2. **购方可能是个人**
   - 企业购车：使用 `buyer_tax_no`（纳税人识别号）
   - 个人购车：使用 `id_card_no`（身份证号码）
   - 需要同时支持两种标识方式

3. **车辆唯一标识**
   - **VIN码**（vehicle_identification_no / CJHM）：车辆识别代号，全球唯一，17位
   - **发动机号**（engine_no / FDJHM）：发动机号码
   - **合格证号**（compliance_no / HGZS）：车辆合格证书号

4. **含税控设备编号**
   - 字段：`tax_control_code` / `SKPH`
   - 用于税控设备管理和防伪验证

5. **不含税价的特殊含义**
   - 字段：`vehicle_price` / `CJFY`
   - 包含车价及价外费用，但不含增值税
   - 价税合计 = 不含税价 + 增值税税额

6. **版本差异**
   - 长软API返回BBXX字段标识新旧版本
   - 2018年8月1日启用新版机动车发票
   - 新版增加了税控编号等防伪措施

### 6.2 与其他类型的区别

| 特性 | 机动车发票(03) | 增值税专票(01) | 增值税普票(04) |
|------|---------------|---------------|---------------|
| 校验码 | ❌ 无 | ❌ 无 | ✅ 有 |
| 抵扣 | ✅ 可抵扣 | ✅ 可抵扣 | ❌ 不可抵扣 |
| 明细结构 | ❌ 无明细 | ✅ 有货物明细 | ✅ 有货物明细 |
| 特殊字段 | VIN码、发动机号、合格证号 | 无 | 无 |
| 购方标识 | 税号或身份证号 | 仅税号 | 仅税号 |
| 版本信息 | ✅ 有BBXX | ❌ 无 | ❌ 无 |
| 税控编号 | ✅ SKPH | ✅ JQBH | ✅ JQBH |

### 6.3 特殊处理逻辑

#### 6.3.1 购方标识判断

```javascript
// 伪代码：判断购方是企业还是个人
function identifyBuyer(body) {
  if (body.GFSBH && body.GFSBH.length >= 15) {
    // 有纳税人识别号，为企业购车
    return {
      buyer_tax_no: body.GFSBH,
      id_card_no: body.SFZHM || null  // 可能为空或组织机构代码
    };
  } else if (body.SFZHM && body.SFZHM.length === 18) {
    // 有18位身份证号，为个人购车
    return {
      buyer_tax_no: null,
      id_card_no: body.SFZHM
    };
  } else {
    // 其他情况
    return {
      buyer_tax_no: body.GFSBH || null,
      id_card_no: body.SFZHM || null
    };
  }
}
```

#### 6.3.2 金额计算验证

```javascript
// 伪代码：验证机动车发票金额逻辑
function validateVehicleInvoiceAmount(body) {
  const vehiclePrice = parseFloat(body.CJFY);    // 不含税价
  const vatAmount = parseFloat(body.ZZSSE);      // 增值税税额
  const totalAmount = parseFloat(body.JSHJ);     // 价税合计

  // 验证：价税合计 = 不含税价 + 增值税税额
  const calculated = vehiclePrice + vatAmount;
  const diff = Math.abs(calculated - totalAmount);

  if (diff > 0.02) {  // 允许2分钱误差
    console.warn(`金额计算不一致: ${calculated} != ${totalAmount}`);
  }

  return {
    vehicle_price: vehiclePrice,
    vat_tax_amount: vatAmount,
    total_amount: totalAmount
  };
}
```

#### 6.3.3 代开发票识别

```javascript
// 伪代码：识别代开发票并提取代开单位信息
function parseAgentInfo(body) {
  if (body.DKBZ !== '2') {
    return { agent_unit_code: null, agent_unit_name: null };
  }

  // 代开发票，从备注中解析代开单位信息
  // 格式可能为："代开单位：XX税务局，统一社会信用代码：123456789"
  const remark = body.BZ || '';
  const agentMatch = remark.match(/代开单位[：:](.*?)[，,]/);
  const codeMatch = remark.match(/统一社会信用代码[：:](.*?)(?:[，,\s]|$)/);

  return {
    agent_unit_code: codeMatch ? codeMatch[1].trim() : null,
    agent_unit_name: agentMatch ? agentMatch[1].trim() : null
  };
}
```

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（但本公司API可选）:
- 无特殊要求

**本公司API要求必填**（但长软API可选）:
- `invoice_status` (发票状态) - 从HEAD/CYJGDM映射

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 10 | ✅ 本公司长度更大，兼容数电票号 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| product_model | 210 | 160 | ⚠️ 本公司更大，兼容长厂牌型号 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数，可记录但不返回
- `CYSJ` (查验时间) - 长软查验时间戳，可记录但不返回
- `DKBZ` (代开标志) - 需转换为agent_unit_code是否为空
- `TSZCBS` (特殊政策标识) - 需映射到preferential_policy_flag
- `SJSL` (实际税率) - 实际征收税率，一般与ZZSSL一致
- `SJSE` (实际税额) - 实际征收税额，一般与ZZSSE一致
- `BBXX` (版本信息) - 发票新旧版本，可扩展字段支持

**本公司独有字段**（需从其他数据源获取）:
- `issuer` (开票人) - 从业务系统获取
- `void_date` (作废日期) - 从业务系统获取
- `agent_unit_name` (代开单位名称) - 从备注或业务系统解析
- `vehicle_abnormal_flag` (机动车异常标识) - 从风控系统获取
- `deduction_flag` (抵扣标志) - 从业务规则判断
- `receiver_*` (接收人信息) - 从电子发票接收系统获取
- 其他业务扩展字段

### 7.4 机动车发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 购方身份识别逻辑

**挑战**：机动车发票的购方可能是企业或个人，需要正确识别。

**解决方案**：
1. 优先判断 `GFSBH`（购方纳税人识别号）
   - 如果存在且长度≥15位，判定为企业，填充 `buyer_tax_no`
2. 其次判断 `SFZHM`（身份证号码）
   - 如果为18位数字，判定为个人，填充 `id_card_no`
3. 两者都存在时：
   - 企业购车：`buyer_tax_no` = GFSBH, `id_card_no` = 组织机构代码（如有）
   - 个人购车：`buyer_tax_no` = null, `id_card_no` = SFZHM

**验证规则**：
- 纳税人识别号：15-20位，通常18位
- 身份证号：18位
- 组织机构代码：9位（已停用，但可能存在）

#### 7.4.2 车辆唯一性验证

**挑战**：防止重复开票、套用发票。

**解决方案**：
1. **VIN码验证**（vehicle_identification_no / CJHM）
   - 必须为17位字符
   - 格式：世界制造厂识别代码(3位) + 车辆说明(6位) + 年份(1位) + 装配厂(1位) + 顺序号(6位)
   - 示例：LHGCM1649A0123456

2. **发动机号验证**（engine_no / FDJHM）
   - 长度不固定，一般6-20位
   - 格式因厂商而异

3. **合格证号验证**（compliance_no / HGZS）
   - 格式因厂商而异
   - 需与VIN码关联验证

**业务规则**：
- 查验时记录VIN码，防止同一车辆多次开票
- 结合发动机号和合格证号进行交叉验证
- 对于进口车辆，额外验证进口证明书号（import_no / JKZMSH）

#### 7.4.3 金额计算逻辑

**关键公式**：
```
价税合计 = 不含税价 + 增值税税额
增值税税额 = 不含税价 × 税率
```

**验证逻辑**：
```javascript
// 验证金额计算是否正确
const vehiclePrice = parseFloat(CJFY);      // 不含税价：100,000
const taxRate = parseFloat(ZZSSL);          // 税率：0.13 (13%)
const vatAmount = parseFloat(ZZSSE);        // 税额：13,000
const totalAmount = parseFloat(JSHJ);       // 价税合计：113,000

// 验证1：税额 = 不含税价 × 税率
const calculatedVat = vehiclePrice * taxRate;
assert(Math.abs(calculatedVat - vatAmount) < 0.02);

// 验证2：价税合计 = 不含税价 + 税额
const calculatedTotal = vehiclePrice + vatAmount;
assert(Math.abs(calculatedTotal - totalAmount) < 0.02);
```

**注意事项**：
- 允许±2分钱的计算误差（由于浮点数精度）
- 税率一般为13%、9%或0%（免税车辆）
- 二手车发票的计算逻辑不同（减按0.5%征收）

#### 7.4.4 代开发票处理

**识别规则**：
- `DKBZ` = "2" 表示代开发票
- 代开单位通常为税务机关
- 需要从备注（BZ）中解析代开单位信息

**解析示例**：
```
备注内容："代开单位：XX市税务局第一税务所，统一社会信用代码：12345678901234567X"

解析后：
- agent_unit_name: "XX市税务局第一税务所"
- agent_unit_code: "12345678901234567X"
```

**特殊情况**：
- 如果备注中无代开单位信息，可能需要通过 `SWJG_DM`（主管税务机关代码）推断
- 代开发票的销售方（XHDWMC）为实际销售方，代开单位信息在备注中

#### 7.4.5 新旧版本兼容

**版本差异**（BBXX字段）：
- **旧版**（BBXX=0）：2018年8月1日前使用
- **新版**（BBXX=1）：2018年8月1日起使用

**主要差异**：
- 新版增加了税控编号（SKPH）字段
- 新版防伪措施更强
- 字段布局和打印格式不同

**处理建议**：
- 查验时记录版本信息，用于后续追溯
- 新旧版本的字段映射逻辑相同
- 如需区分展示，可扩展 `vehicle_invoice_version` 字段

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0)
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf` (第5-6页)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 国家税务总局发票查验平台: https://inv-veri.chinatax.gov.cn/

---

**文档结束**
