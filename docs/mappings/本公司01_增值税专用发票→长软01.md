# 本公司01_增值税专用发票→长软01 字段映射表

**文档版本**: v1.0
**创建日期**: 2025-12-30
**发票类型**: 01 - 增值税专用发票

---

## 📋 概述

本文档定义了本公司发票查验API与长软发票查验服务之间，针对"增值税专用发票"的完整字段映射关系。

- **本公司API**: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (RESTful JSON格式)
- **长软API**: 【长软】发票查验服务调用说明V4.0.16.pdf (XML格式)
- **本公司发票类型代码**: 01
- **长软发票类型代码**: 01
- **长软文档章节**: 3.2.3.1

### 依赖的通用文档

本映射表引用以下通用文档，使用前请先了解：
- 📄 [00_通用说明_请求参数映射.md](./00_通用说明_请求参数映射.md) - 查验请求参数映射
- 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md) - 通用枚举值映射（CYJGDM, ZFBZ, TSPZBZ等）

---

## 一、类型映射关系

| 项目 | 本公司API | 长软API | 说明 |
|------|-----------|---------|------|
| 发票类型代码 | `01` | `01` | 完全一致 |
| 发票类型名称 | 增值税专用发票 | 增值税专用发票 | |
| 数据结构定义 | `#/definitions/231697053` | `3.2.3.1` | 本定义也包含02货运专票、04普票、08电子专票、10电子普票 |
| 数电发票类型 | - | - | 非数电发票 |

---

## 二、发票主信息字段映射

### 2.1 完整字段对照表

⚠️ **重要**: 本表格包含该发票类型的**所有响应字段**，请逐一核对。

| 本公司API字段路径 | 本公司API中文名 | 本公司API类型 | 长软API字段路径 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `invoice_code` | 发票代码 | string(12) | `BODY/FPDM` | 发票代码 | VARCHAR2(20) | 直接映射 |
| `invoice_number` | 发票号码 | string(20) | `BODY/FPHM` | 发票号码 | VARCHAR2(10) | 直接映射，本公司支持更长 |
| - | - | - | `BODY/CYCS` | 查验次数 | VARCHAR2(32) | **长软独有**，记录该发票被查验次数 |
| `issue_date` | 开票日期 | string(19) | `BODY/KPRQ` | 开票日期 | VARCHAR2(32) | 格式转换：YYYY-MM-DD ← YYYYMMDD |
| `buyer_name` | 购买方名称 | string(300) | `BODY/GFMC` | 购方名称 | VARCHAR2(300) | 直接映射 |
| `buyer_tax_no` | 购买方税号 | string(20) | `BODY/GFSBH` | 购方纳税人识别号 | VARCHAR2(64) | 直接映射 |
| `buyer_address_phone` | 购买方地址电话 | string(190) | `BODY/GFDZDH` | 购方地址、电话 | VARCHAR2(120) | 直接映射 |
| `buyer_bank_account` | 购买方银行账号 | string(300) | `BODY/GFYHZH` | 购方开户行及账号 | VARCHAR2(120) | 直接映射 |
| `seller_name` | 销售方名称 | string(300) | `BODY/XFMC` | 销方名称 | VARCHAR2(300) | 直接映射 |
| `seller_tax_no` | 销售方识别号 | string(20) | `BODY/XFSBH` | 销方纳税人识别号 | VARCHAR2(26) | 直接映射 |
| `seller_address_phone` | 销售方地址电话 | string(190) | `BODY/XFDZDH` | 销方地址电话 | VARCHAR2(120) | 直接映射 |
| `seller_bank_account` | 销售方银行账号 | string(300) | `BODY/XFYHZH` | 销方开户行及账号 | VARCHAR2(120) | 直接映射 |
| `amount` | 金额 | number(18,2) | `BODY/JE` | 金额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `tax_amount` | 税额 | number(18,2) | `BODY/SE` | 税额合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `total_amount` | 价税合计 | number(18,2) | `BODY/JSHJ` | 价税合计 | VARCHAR2(32) | 类型转换：长软为字符串 |
| `remark` | 备注 | string(610) | `BODY/BZ` | 备注 | VARCHAR2(610) | 直接映射 |
| - | - | - | `BODY/JQBH` | 机器编号 | VARCHAR2(16) | **长软独有**，税控设备编号 |
| `verification_code` | 校验码 | string(32) | `BODY/JYM` | 校验码 | VARCHAR2(32) | 直接映射，**专票无校验码**，此字段为空 |
| `invoice_status_flag` | 发票状态标志 | 枚举 | `BODY/ZFBZ` | 作废标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/CPYBZ` | 成品油标志 | VARCHAR2(2) | **长软独有**，已废止，以TSPZBZ为准 |
| - | - | - | `BODY/CYSJ` | 查验时间 | VARCHAR2(20) | **长软独有**，查验时间戳 |
| - | - | - | `BODY/QDBZ` | 清单标志 | VARCHAR2(2) | **长软独有**，0=无清单，1=有清单 |
| `special_invoice_type` | 特殊票种 | string | `BODY/TSPZBZ` | 特殊票种标志 | VARCHAR2(2) | 枚举映射：参见通用枚举文档 |
| - | - | - | `BODY/HZDK` | 汇总代开标志 | VARCHAR2(2) | **长软独有**，0=非汇总代开，1=汇总代开 |
| `invoice_status` | 发票状态 | 枚举 | `HEAD/CYJGDM` | 查验结果代码 | VARCHAR(3) | **关键字段**，查验状态码，参见通用枚举文档 |
| `proxy_seller_tax_no` | 代开发票真实销售方识别号 | string(20) | - | - | - | **本公司独有**，从业务规则解析（特殊票种02农产品收购时购销方反向） |
| `proxy_seller_name` | 代开发票真实销售方名称 | string(300) | - | - | - | **本公司独有**，从业务规则解析 |
| `void_date` | 作废日期 | string(19) | - | - | - | **本公司独有**，从业务系统获取 |
| `tax_rate` | 税率 | number(8,5) | - | - | - | **本公司独有**，从items明细中计算得出 |
| `tax_inclusive_rate_flag` | 含税税率标识 | string(1) | - | - | - | **本公司独有**，0=不含税税率，1=含税税率，2=差额征税 |
| `applicable_tax_rate_flag` | 适用税率标识 | string(1) | - | - | - | **本公司独有**，'1'=是，其他=否 |
| `item_count` | 明细条数 | string(30) | - | - | - | **本公司独有**，items数组长度 |
| `non_taxable_amount` | 不征税金额 | number(18,2) | - | - | - | **本公司独有**，从业务系统获取 |
| `seller_taxpayer_type_code` | 销方纳税人类型代码 | string | - | - | - | **本公司独有**，1=一般纳税人，2=小规模纳税人 |
| `vehicle_abnormal_flag` | 机动车异常标识 | string(1) | - | - | - | **本公司独有**，0=无风险，1=低风险，2=中风险，3=高风险 |
| `issue_type` | 开票类型 | 枚举 | - | - | - | **本公司独有**，仅乐企查验返回 |

**字段分类说明**：
- **直接映射**: 字段名和含义一致，直接对应
- **格式转换**: 需要进行格式转换（如日期、金额格式）
- **类型转换**: 需要进行数据类型转换（如string ↔ number）
- **长软独有**: 长软API独有字段，本公司API无此字段
- **本公司独有**: 本公司API独有字段，需从其他数据源获取或计算

### 2.2 本公司独有字段处理说明

| 本公司字段 | 数据来源 | 处理逻辑 |
|-----------|---------|----------|
| `tax_rate` | 计算得出 | 取items中第一个非零税率，或计算加权平均税率 |
| `item_count` | 计算得出 | items数组长度，即明细条数 |
| `void_date` | 业务系统 | 从企业业务系统获取，长软只返回ZFBZ标志 |
| `proxy_seller_tax_no` | 解析得出 | 当TSPZBZ=04(农产品收购)时，从备注或特定字段解析 |
| `proxy_seller_name` | 解析得出 | 当TSPZBZ=04(农产品收购)时，从备注或特定字段解析 |
| `tax_inclusive_rate_flag` | 业务规则 | 根据发票类型和税率判断 |
| `applicable_tax_rate_flag` | 业务规则 | 判断是否适用标准税率 |
| `non_taxable_amount` | 业务系统 | 不征税项目金额 |
| `seller_taxpayer_type_code` | 业务系统 | 销方纳税人类型 |
| `vehicle_abnormal_flag` | 业务系统 | 机动车异常风险等级，专票一般为0 |
| `issue_type` | 乐企查验 | 仅乐企查验接口返回 |

---

## 三、货物/明细字段映射

### 3.1 明细结构说明

**本公司API路径**: `items[]`
**长软API路径**: `BODY/CHILDLIST/CHILD[]`

⚠️ **注意**:
- ✅ **增值税专用发票有货物明细结构**
- 明细数据记录货物或应税劳务的详细信息
- 一张发票可以有多个明细行

### 3.2 完整明细字段对照表

| 本公司API字段 | 本公司API中文名 | 本公司API类型 | 长软API字段 | 长软API中文名 | 长软API类型 | 映射说明 |
|---|---|---|---|---|---|---|
| `sequence_no` | 货物明细序号 | integer | - | - | - | **本公司独有**，用于排序 |
| `name` | 货物名称 | string(310) | `HWMC` | 货物或应税劳务名称 | VARCHAR2(320) | 直接映射 |
| `specification` | 规格型号 | string(64) | `GGXH` | 规格型号 | VARCHAR2(64) | 直接映射 |
| `unit` | 计量单位 | string(52) | `DW` | 单位 | VARCHAR2(52) | 直接映射 |
| `quantity` | 数量 | string(25) | `SL` | 数量 | VARCHAR2(25) | 直接映射 |
| `unit_price` | 单价 | string(25) | `DJ` | 单价 | VARCHAR2(25) | 直接映射 |
| `amount` | 金额 | number(18,2) | `JE` | 金额 | NUMBER(20,2) | 直接映射 |
| `tax_rate` | 税率 | number(8,5) | `SLV` | 税率 | NUMBER(8,5) | 直接映射 |
| `tax_amount` | 税额 | number(18,2) | `SE` | 税额 | NUMBER(20,2) | 直接映射 |
| `product_code` | 商品编码 | string(45) | - | - | - | **本公司独有**，商品和服务税收分类编码 |
| `zero_tax_rate_flag` | 零税率标识 | 枚举 | - | - | - | **本公司独有**，零税率标志 |

**说明**：
- 长软API中明细字段的金额、税额、税率都是NUMBER类型，可以直接映射
- 其他字段（数量、单价）都是字符串类型
- 本公司独有字段需要从业务系统或Apifox定义中获取

---

## 四、数据格式转换说明

### 4.1 日期格式转换

| API | 格式 | 示例 |
|-----|------|------|
| 本公司API | `YYYY-MM-DD` 或 `YYYY-MM-DD HH:mm:ss` | 2025-12-30 或 2025-12-30 16:59:45 |
| 长软API | `YYYYMMDD` | 20251230 |

**转换规则**：
```javascript
// 长软 → 本公司
function formatDate(yyyymmdd) {
  if (!yyyymmdd || yyyymmdd.length !== 8) return null;
  return `${yyyymmdd.substr(0,4)}-${yyyymmdd.substr(4,2)}-${yyyymmdd.substr(6,2)}`;
}
// 示例: "20251230" → "2025-12-30"
```

### 4.2 数值类型转换

| 数据项 | 本公司API | 长软API | 转换说明 |
|--------|-----------|---------|----------|
| 金额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 税额合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 价税合计 | `number` (18,2) | `VARCHAR2(32)` 字符串 | 长软→本公司: `parseFloat()` |
| 明细金额 | `number` (18,2) | `NUMBER(20,2)` | 类型一致，直接映射 |
| 明细税额 | `number` (18,2) | `NUMBER(20,2)` | 类型一致，直接映射 |
| 明细税率 | `number` (8,5) | `NUMBER(8,5)` | 类型一致，直接映射 |

**转换示例**：
```javascript
// 长软API返回
{
  "JE": "10000.00",      // 金额合计（字符串）
  "SE": "1300.00",       // 税额合计（字符串）
  "JSHJ": "11300.00"     // 价税合计（字符串）
}

// 转换为本公司API
{
  "amount": 10000.00,
  "tax_amount": 1300.00,
  "total_amount": 11300.00
}
```

### 4.3 字符串长度适配

| 字段 | 本公司长度 | 长软长度 | 处理策略 |
|------|-----------|---------|----------|
| invoice_number | 20 | 10 | ⚠️ 本公司更宽松，兼容数电发票20位 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更宽松，但实际18位够用 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更宽松，但实际18位够用 |
| name | 310 | 320 | ⚠️ 长软略大，截断可能性极小 |

---

## 五、枚举值映射

### 5.1 通用枚举映射

通用枚举值详见: 📄 [00_通用说明_枚举映射.md](./00_通用说明_枚举映射.md)

包括：
- **查验结果代码** (CYJGDM → invoice_status)
- **作废标志** (ZFBZ → invoice_status_flag)
- **特殊票种标志** (TSPZBZ → special_invoice_type)

### 5.2 增值税专用发票特有枚举映射

⚠️ **重要**: 增值税专用发票**没有特有枚举**，所有枚举都使用通用枚举映射。

但需要注意以下特殊情况：

#### 5.2.1 农产品收购发票的特殊处理

当 `TSPZBZ = "04"` (农产品收购发票) 时：
- **购销方信息反向存储**：长软API中的GFMC(购方名称)实际是销售方，XFMC(销方名称)实际是购买方
- **需要进行字段反向映射**

| 长软字段 | 正常情况映射 | 农产品收购映射 | 说明 |
|---------|------------|--------------|------|
| GFMC | buyer_name | proxy_seller_name | 实际销售方（农户/个人） |
| GFSBH | buyer_tax_no | proxy_seller_tax_no | 实际销售方识别号 |
| XFMC | seller_name | buyer_name | 实际购买方（收购企业） |
| XFSBH | seller_tax_no | buyer_tax_no | 实际购买方税号 |

**处理示例**：
```javascript
// 伪代码：农产品收购发票的购销方反向处理
function mapBuyerSeller(body, tspzbz) {
  if (tspzbz === '04') {
    // 农产品收购发票：购销方反向
    return {
      buyer_name: body.XFMC,           // 实际购买方
      buyer_tax_no: body.XFSBH,
      seller_name: body.GFMC,          // 实际销售方
      seller_tax_no: body.GFSBH,
      proxy_seller_name: body.GFMC,    // 代开真实销售方
      proxy_seller_tax_no: body.GFSBH
    };
  } else {
    // 正常发票
    return {
      buyer_name: body.GFMC,
      buyer_tax_no: body.GFSBH,
      seller_name: body.XFMC,
      seller_tax_no: body.XFSBH,
      proxy_seller_name: null,
      proxy_seller_tax_no: null
    };
  }
}
```

#### 5.2.2 清单标志 (QDBZ)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 0 | 无清单 | 普通发票，明细直接在CHILDLIST中 |
| 1 | 有清单 | 销货清单，明细在独立的清单中 |

**说明**：本公司API暂无对应字段，可扩展时添加 `list_flag` 字段。

#### 5.2.3 汇总代开标志 (HZDK)

| 长软值 | 含义 | 说明 |
|-------|------|------|
| 0 | 非汇总代开 | 普通发票 |
| 1 | 汇总代开 | 税务机关汇总代开 |

**说明**：本公司API暂无对应字段，可扩展时添加 `aggregate_proxy_flag` 字段。

---

## 六、增值税专用发票特殊性说明

### 6.1 该类型的独特特性

1. **无校验码**
   - 增值税专用发票**没有校验码**字段（JYM为空）
   - 与普通发票的主要区别之一
   - 防伪验证依赖其他机制（如密码区等）

2. **可抵扣进项税**
   - 专用发票最核心的特征是可以抵扣进项税额
   - 一般纳税人取得专票可按票面税额抵扣
   - 小规模纳税人不能开具专票（除特定行业）

3. **必须有货物明细**
   - 专用发票必须包含货物或应税劳务明细
   - CHILDLIST不能为空
   - 每个明细行需要包含完整的税率、税额信息

4. **购销双方信息完整**
   - 必须同时包含购方和销方的完整信息
   - 包括：名称、税号、地址电话、开户行及账号
   - 这是与普通发票的另一重要区别

5. **农产品收购特殊处理**
   - 特殊票种TSPZBZ=04时，购销方信息**反向存储**
   - 购方信息实际是销售方（农户/个人）
   - 销方信息实际是购买方（收购企业）
   - 这是税收政策的特殊设计

6. **金额计算关系**
   ```
   价税合计 = 金额合计 + 税额合计
   税额合计 = Σ(明细金额 × 明细税率)
   金额合计 = Σ(明细金额)
   ```

### 6.2 与其他类型的区别

| 特性 | 增值税专用发票(01) | 增值税普通发票(04) | 电子专票(08) | 机动车发票(03) |
|------|------------------|------------------|-------------|---------------|
| 校验码 | ❌ 无 | ✅ 有 | ❌ 无 | ❌ 无 |
| 抵扣 | ✅ 可抵扣 | ❌ 不可抵扣 | ✅ 可抵扣 | ✅ 可抵扣 |
| 明细结构 | ✅ 有货物明细 | ✅ 有货物明细 | ✅ 有货物明细 | ❌ 无明细 |
| 购方完整信息 | ✅ 必需 | ⚠️ 可选 | ✅ 必需 | ✅ 必需 |
| 销方完整信息 | ✅ 必需 | ✅ 必需 | ✅ 必需 | ✅ 必需 |
| 特殊处理 | 农产品收购反向 | 无 | 无 | 车辆信息 |
| 发票介质 | 纸质 | 纸质 | 电子 | 纸质 |

### 6.3 特殊处理逻辑

#### 6.3.1 农产品收购发票识别与处理

```javascript
// 伪代码：完整的农产品收购发票处理流程
function processInvoice01(xmlBody) {
  const tspzbz = xmlBody.TSPZBZ;

  if (tspzbz === '04') {
    // 农产品收购发票：购销方反向处理
    return {
      invoice_code: xmlBody.FPDM,
      invoice_number: xmlBody.FPHM,
      issue_date: formatDate(xmlBody.KPRQ),

      // 购销方反向映射
      buyer_name: xmlBody.XFMC,           // 收购企业
      buyer_tax_no: xmlBody.XFSBH,
      buyer_address_phone: xmlBody.XFDZDH,
      buyer_bank_account: xmlBody.XFYHZH,

      seller_name: xmlBody.GFMC,          // 农户/个人
      seller_tax_no: xmlBody.GFSBH,
      seller_address_phone: xmlBody.GFDZDH,
      seller_bank_account: xmlBody.GFYHZH,

      // 代开信息
      proxy_seller_name: xmlBody.GFMC,    // 真实销售方
      proxy_seller_tax_no: xmlBody.GFSBH,

      // 其他字段正常映射
      amount: parseFloat(xmlBody.JE),
      tax_amount: parseFloat(xmlBody.SE),
      total_amount: parseFloat(xmlBody.JSHJ),
      special_invoice_type: '02',         // 映射到本公司的农产品收购枚举

      // 明细正常映射
      items: xmlBody.CHILDLIST.CHILD.map(mapItem)
    };
  } else {
    // 正常专用发票
    return {
      invoice_code: xmlBody.FPDM,
      invoice_number: xmlBody.FPHM,
      issue_date: formatDate(xmlBody.KPRQ),

      // 购销方正常映射
      buyer_name: xmlBody.GFMC,
      buyer_tax_no: xmlBody.GFSBH,
      buyer_address_phone: xmlBody.GFDZDH,
      buyer_bank_account: xmlBody.GFYHZH,

      seller_name: xmlBody.XFMC,
      seller_tax_no: xmlBody.XFSBH,
      seller_address_phone: xmlBody.XFDZDH,
      seller_bank_account: xmlBody.XFYHZH,

      // 无代开信息
      proxy_seller_name: null,
      proxy_seller_tax_no: null,

      // 其他字段正常映射
      amount: parseFloat(xmlBody.JE),
      tax_amount: parseFloat(xmlBody.SE),
      total_amount: parseFloat(xmlBody.JSHJ),
      special_invoice_type: xmlBody.TSPZBZ || null,

      // 明细正常映射
      items: xmlBody.CHILDLIST.CHILD.map(mapItem)
    };
  }
}
```

#### 6.3.2 金额计算验证

```javascript
// 伪代码：验证增值税专用发票金额逻辑
function validateInvoice01Amount(body) {
  const totalAmount = parseFloat(body.JSHJ);     // 价税合计
  const amount = parseFloat(body.JE);            // 金额合计
  const taxAmount = parseFloat(body.SE);         // 税额合计

  // 验证1：价税合计 = 金额合计 + 税额合计
  const calculated = amount + taxAmount;
  const diff = Math.abs(calculated - totalAmount);

  if (diff > 0.02) {  // 允许2分钱误差
    console.warn(`金额计算不一致: ${calculated} != ${totalAmount}`);
  }

  // 验证2：明细金额与税额之和应等于汇总
  const items = body.CHILDLIST.CHILD;
  const itemsAmount = items.reduce((sum, item) => sum + parseFloat(item.JE || 0), 0);
  const itemsTax = items.reduce((sum, item) => sum + parseFloat(item.SE || 0), 0);

  if (Math.abs(itemsAmount - amount) > 0.02) {
    console.warn(`明细金额合计与汇总不一致: ${itemsAmount} != ${amount}`);
  }

  if (Math.abs(itemsTax - taxAmount) > 0.02) {
    console.warn(`明细税额合计与汇总不一致: ${itemsTax} != ${taxAmount}`);
  }

  return {
    amount: amount,
    tax_amount: taxAmount,
    total_amount: totalAmount,
    is_valid: diff <= 0.02
  };
}
```

#### 6.3.3 税率计算

```javascript
// 伪代码：从明细中计算主税率
function calculateMainTaxRate(items) {
  if (!items || items.length === 0) return null;

  // 方法1：取第一个非零税率
  const firstNonZero = items.find(item => parseFloat(item.SLV || 0) > 0);
  if (firstNonZero) {
    return parseFloat(firstNonZero.SLV);
  }

  // 方法2：取最常见的税率
  const taxRates = items.map(item => parseFloat(item.SLV || 0));
  const rateCount = {};
  taxRates.forEach(rate => {
    rateCount[rate] = (rateCount[rate] || 0) + 1;
  });
  const mostCommonRate = Object.keys(rateCount).reduce((a, b) =>
    rateCount[a] > rateCount[b] ? a : b
  );

  return parseFloat(mostCommonRate);
}
```

---

## 七、集成注意事项

### 7.1 必填字段对比

**长软API要求必填**（但本公司API可选）:
- 无特殊要求

**本公司API要求必填**（但长软API可选）:
- `invoice_code` (发票代码) - 必填
- `invoice_number` (发票号码) - 必填
- `invoice_status` (发票状态) - 从HEAD/CYJGDM映射，必填
- `seller_tax_no` (销售方识别号) - 必填
- `buyer_name` (购买方名称) - 必填
- `seller_name` (销售方名称) - 必填

### 7.2 字段长度差异

| 字段 | 本公司长度 | 长软长度 | 实际风险评估 |
|------|-----------|---------|------------|
| invoice_number | 20 | 10 | ✅ 本公司长度更大，兼容数电票号 |
| seller_tax_no | 20 | 26 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| buyer_tax_no | 20 | 64 | ⚠️ 长软更大，但中国税号18位，20位足够 |
| name | 310 | 320 | ⚠️ 长软略大，截断风险极小 |

### 7.3 数据完整性

**长软独有字段**（本公司API无对应）:
- `CYCS` (查验次数) - 长软统计查验次数，可记录但不返回
- `CYSJ` (查验时间) - 长软查验时间戳，可记录但不返回
- `JQBH` (机器编号) - 税控设备编号，可扩展字段支持
- `CPYBZ` (成品油标志) - 已废止，以TSPZBZ为准
- `QDBZ` (清单标志) - 是否有销货清单，可扩展字段支持
- `HZDK` (汇总代开标志) - 是否汇总代开，可扩展字段支持

**本公司独有字段**（需从其他数据源获取）:
- `void_date` (作废日期) - 从业务系统获取
- `proxy_seller_*` (代开信息) - 从业务规则解析
- `tax_rate` (主税率) - 从明细计算得出
- `item_count` (明细条数) - 从items数组长度计算
- `tax_inclusive_rate_flag` (含税税率标识) - 从业务规则判断
- `applicable_tax_rate_flag` (适用税率标识) - 从业务规则判断
- `non_taxable_amount` (不征税金额) - 从业务系统获取
- `seller_taxpayer_type_code` (销方纳税人类型) - 从业务系统获取
- `vehicle_abnormal_flag` (机动车异常标识) - 从业务系统获取（专票一般为0）
- `issue_type` (开票类型) - 仅乐企查验返回

### 7.4 增值税专用发票特殊集成要点

⚠️ **这是最重要的部分，必须根据业务特性详细说明！**

#### 7.4.1 农产品收购发票的购销方反向处理

**挑战**：农产品收购发票的购销方信息在长软API中是反向存储的。

**解决方案**：
1. 首先判断 `TSPZBZ` 是否为 "04"
2. 如果是农产品收购发票，则：
   - `buyer_name` ← `XFMC` (销方名称实际是购买方)
   - `buyer_tax_no` ← `XFSBH`
   - `seller_name` ← `GFMC` (购方名称实际是销售方)
   - `seller_tax_no` ← `GFSBH`
   - `proxy_seller_name` ← `GFMC` (代开真实销售方)
   - `proxy_seller_tax_no` ← `GFSBH`
3. 如果是正常专票，则按常规映射

**业务背景**：
- 农产品收购发票是由收购企业（买方）向个人或农户（卖方）收购农产品时开具
- 由于卖方通常是个人或农户，无法自行开票
- 因此由买方（收购企业）代开发票
- 长软系统中购销方信息反向存储，以适应这种特殊业务场景

#### 7.4.2 明细数据完整性验证

**挑战**：确保明细数据与汇总数据一致。

**解决方案**：
1. **验证明细金额合计**
   ```
   Σ(items.amount) ≈ amount (允许±0.02误差)
   ```

2. **验证明细税额合计**
   ```
   Σ(items.tax_amount) ≈ tax_amount (允许±0.02误差)
   ```

3. **验证价税合计**
   ```
   amount + tax_amount ≈ total_amount (允许±0.02误差)
   ```

4. **验证每个明细的计算逻辑**
   ```
   item.tax_amount ≈ item.amount × item.tax_rate (允许±0.01误差)
   ```

**注意事项**：
- 由于浮点数计算精度问题，允许小额误差（通常2分钱以内）
- 如果误差超过阈值，应记录警告日志，但不影响查验结果
- 对于清单发票（QDBZ=1），明细可能为空，此时跳过明细验证

#### 7.4.3 税率识别与验证

**挑战**：专用发票的主税率需要从明细中提取。

**解决方案**：
1. 遍历所有明细，提取非零税率
2. 优先选择最常见的税率作为主税率
3. 如果所有明细税率一致，直接取该税率
4. 如果明细中有多种税率，可能是混合销售，取加权平均或最高税率

**常见税率**：
- 13%：一般货物
- 9%：农产品、交通运输服务等
- 6%：现代服务业、增值电信服务等
- 0%：出口货物等
- 免税：特定商品

#### 7.4.4 特殊票种识别

**成品油发票** (TSPZBZ=08):
- 明细中需要包含油品名称、单位、数量等信息
- 可能有特殊的格式要求

**建筑服务发票** (TSPZBZ=07):
- 可能包含工程项目信息
- 备注字段通常包含项目名称、地址等

**货物运输服务发票** (TSPZBZ=08):
- 包含起运地、到达地、运输工具等信息
- 明细中可能是运输服务而非货物

---

## 参考文档

1. 本公司API定义: [`/partners/invoice-verifications`](https://s.apifox.cn/2795ad32-31e7-4363-8294-578e8dc6202c/395314528e0) (Definition ID: 231697053)
2. 长软API文档: `【长软】发票查验服务调用说明V4.0.16.pdf` (第4-5页, 第29页)
3. 通用枚举映射: `00_通用说明_枚举映射.md`
4. 通用请求参数映射: `00_通用说明_请求参数映射.md`
5. 国家税务总局发票查验平台: https://inv-veri.chinatax.gov.cn/

---

**文档结束**
