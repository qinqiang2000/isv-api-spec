# 发票查验接口 API 规范

## 文件信息

- **文件名**: `发票查验接口.apifox.json`
- **格式**: Apifox 1.2.0
- **文件大小**: 2378 行
- **生成日期**: 2025-12-21

## API 概述

### Endpoint
```
POST /isv/invoice-verifications
```

### 功能描述
企业端业务系统通过此接口对开具、取得的各类发票发起查验申请，系统根据查验申请反馈查验结果。支持**10种发票类型**的实时查验。

## 请求格式

### Headers
| Header | 是否必须 | 说明 |
|--------|---------|------|
| Authorization | 是 | Bearer token格式：`Bearer <access_token>` |
| X-Request-Id | 是 | 全局唯一请求ID，格式：`req_{timestamp_ms}_{random_8}` |
| X-Customer-Id | 是 | 客户编号，10位数字 |
| Accept-Language | 否 | 语言设置，默认en-US，支持zh-CN |

### Request Body
```json
{
  "invoice_type": "81",           // 必填，发票类型代码（2位）
  "invoice_code": "123456789012", // 可选，发票代码（12位），纸质发票时必填
  "invoice_no": "12345678",       // 必填，发票号码（20位）
  "invoice_date": "2025-01-01",   // 必填，开票日期（YYYY-MM-DD）
  "verification_code": "123456",  // 可选，校验码（后6位）
  "invoice_amount": 10000.00,     // 可选，开票金额
  "taxpayer_id": "91510000XXXXXX" // 必填，纳税人识别号（20位）
}
```

## 响应格式

### 成功响应（200 OK）
```json
{
  "result_code": "00",          // 结果代码
  "result_message": "成功",     // 返回信息
  "verification_data": {        // 查验结果（已自动解压gzip+base64）
    // 根据invoice_type返回对应的发票数据结构
    // 见下方"支持的发票类型"章节
  }
}
```

### result_code 说明
| 代码 | 含义 |
|-----|-----|
| 00 | 成功 |
| 01 | 失败 |
| 02 | 查无数据 |
| 03 | 查验不一致 |
| 04 | 此发票非本单位开具或取得 |

### 错误响应（401）
```json
{
  "errcode": "错误代码",
  "description": "错误说明"
}
```

## 支持的发票类型

本API支持**10种发票类型**，每种类型对应不同的`verification_data`数据结构：

### 1. 数字化电子发票-增值税发票
**类型代码**: 81, 82, 85, 86
- 81：电子发票（增值税专用发票）
- 82：电子发票（普通发票）
- 85：纸质发票（增值税专用发票）
- 86：纸质发票（普通发票）

**数据结构**: 38个主字段 + `items`明细行数组 + 特定要素
**Schema引用**: `#/definitions/223576033`

### 2. 标准增值税发票
**类型代码**: 01, 02, 04, 08, 10
- 01：增值税专用发票
- 02：货物运输业增值税专用发票（注意：购方、销方信息反向存储）
- 04：增值税普通发票
- 08：增值税电子专用发票
- 10：增值税电子普通发票

**Schema引用**: `#/definitions/223576034`

### 3. 增值税普通发票（卷式）
**类型代码**: 11

**Schema引用**: `#/definitions/223576035`

### 4. 增值税普通发票（通行费）
**类型代码**: 14

**Schema引用**: `#/definitions/223576036`

### 5. 机动车销售统一发票
**类型代码**: 03, 87
- 03：机动车销售统一发票
- 87：纸质发票（机动车销售统一发票）

**Schema引用**: `#/definitions/223576037`

### 6. 二手车销售统一发票
**类型代码**: 15, 88
- 15：二手车销售统一发票
- 88：纸质发票（二手车销售统一发票）

**Schema引用**: `#/definitions/223576038`

### 7. 航空运输客票电子行程单
**类型代码**: 61

**Schema引用**: `#/definitions/223576039`

### 8. 铁路电子客票
**类型代码**: 51

**Schema引用**: `#/definitions/223576040`

### 9. 数字化电子发票-机动车销售统一发票
**类型代码**: 83

**Schema引用**: `#/definitions/223576041`

### 10. 数字化电子发票-二手车销售统一发票
**类型代码**: 84

**Schema引用**: `#/definitions/223576042`

## 字段命名规范

本API严格遵循ISV API的snake_case命名约定：

| 中文 | 税局缩写 | ISV约定 |
|------|---------|---------|
| 发票 | fp | invoice_ |
| 代码 | dm | _code |
| 号码 | hm | _no |
| 日期 | rq | _date |
| 销售方 | xsf/xf | saler_ |
| 购买方 | gmf/gf | buyer_ |
| 名称 | mc | _name |
| 地址 | dz | _address |
| 电话 | dh | _phone |
| 开户行 | khh | _bank_name |
| 账号 | zh | _account_number |
| 金额 | je | _amount |
| 税额 | se | _tax_amount |
| 税率 | slv | tax_rate |

## Schema复用设计

为支持将来的**发票数据导入**和**发票下载**接口复用相同的数据结构，所有10种发票数据类型均定义为独立可复用的schemas，存放在`schemaCollection`中。

其他接口可通过`$ref`引用这些schemas：
```json
{
  "$ref": "#/definitions/223576033"  // 引用数字化电子增值税发票schema
}
```

## 辅助Schemas

### 医疗机构类型
**Schema ID**: `#/definitions/220013573`

枚举值：
- 1：综合医院
- 2：中医医院
- 3：专科医院
- 4：社区卫生服务中心（站）
- 5：其他

### 证件类型
**Schema ID**: `#/definitions/220013572`（复用现有ISV API定义）

包含50+种证件类型代码，用于身份证件相关字段。

## 使用示例

### 查验数字化电子增值税发票
```bash
curl -X POST https://api.example.com/isv/invoice-verifications \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "X-Request-Id: req_1703123456789_12345678" \
  -H "X-Customer-Id: 1234567890" \
  -H "Content-Type: application/json" \
  -d '{
    "invoice_type": "81",
    "invoice_no": "12345678901234567890",
    "invoice_date": "2025-01-01",
    "taxpayer_id": "91510000MA6CL6XX1A"
  }'
```

### 查验机动车销售发票
```bash
curl -X POST https://api.example.com/isv/invoice-verifications \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "X-Request-Id: req_1703123456789_87654321" \
  -H "X-Customer-Id": "1234567890" \
  -H "Content-Type: application/json" \
  -d '{
    "invoice_type": "03",
    "invoice_code": "123456789012",
    "invoice_no": "00000001",
    "invoice_date": "2025-01-01",
    "invoice_amount": 250000.00,
    "taxpayer_id": "91510000MA6CL6XX1A"
  }'
```

## 重要注意事项

1. **日期格式**：
   - 请求参数使用ISO格式：`YYYY-MM-DD`
   - 响应数据使用完整格式：`YYYY-MM-DD HH:mm:ss`

2. **金额精度**：所有金额字段整数部分最大18位，保留2位小数

3. **特殊处理**：
   - 发票类型02（农产品收购）：购方、销方信息为反向存储
   - `verification_data`字段已自动解压gzip+base64，直接返回JSON对象

4. **HTTP状态码**：
   - 所有业务请求统一返回200 OK
   - 业务状态通过`result_code`字段判断
   - 仅认证失败返回401

## 生成工具

本API定义由以下Python脚本生成：
- `generate_invoice_verification_api.py` - 基础结构和第1种发票类型
- `add_remaining_schemas.py` - 第2-5种发票类型
- `add_final_schemas.py` - 第6-10种发票类型

## 参考文档

- 税局原始文档：`乐企发票查验能力说明文档-V1.020.docx`
- 现有ISV API规范：`ISV接口梳理.apifox.json`
- 实施计划：`/Users/qinqiang02/.claude/plans/mutable-honking-petal.md`

## 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0.0 | 2025-12-21 | 初始版本，包含10种发票类型完整定义 |

---

**联系方式**: 如有疑问，请参考Apifox项目或查阅税局文档。
